# フィードUIコンポーネントの要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Feature名**: 0069-feed-component
- **作成日**: 2026-01-27
- **関連Issue**: https://github.com/taku-o/go-webdb-template/issues/142

### 1.2 目的
Twitter風のメッセージのエントリーが並ぶUIをNext.jsで作成し、投稿一覧の表示、新規投稿、返信、いいね機能を提供する。**本実装の主な目的は、コンポーネントの挙動と見た目を重視することである。** データ管理はメモリで行い、データベース連携は行わない。クライアント側でダミーデータを返すAPI実装を使用し、初期の投稿データ・返信データはランダムで生成する。

### 1.3 スコープ
- Twitter風のフィードUIコンポーネントの作成（挙動と見た目を重視）
- 投稿一覧の表示（初期10件、スクロールで追加読み込み）
- 新規投稿機能
- 投稿への返信機能（返信に対する返信は不可）
- 投稿へのいいね機能（返信にはいいね不可）
- トップページからの専用ページへのリンク追加
- `client/lib/api.ts`にダミーデータを返すAPI実装の追加（メモリ管理、ランダム生成）

**本実装の範囲外**:
- データベース連携（メモリ管理のみ）
- サーバー側API実装
- 認証機能（既存の認証機能を使用）
- 返信のネスト機能（返信に対する返信）
- 返信へのいいね機能
- その他のSNS機能（リツイート、ブックマーク等）
- データの永続化（メモリ管理のみ）

## 2. 背景・現状分析

### 2.1 現状
- Next.js 14+ (App Router)を使用したクライアントアプリケーションが存在
- shadcn/uiコンポーネントライブラリが導入済み
- `client/lib/api.ts`に既存のAPIクライアント実装が存在
- トップページ（`client/app/page.tsx`）に機能一覧が表示されている

### 2.2 問題点
- Twitter風のフィードUIコンポーネントが存在しない
- 投稿、返信、いいね機能を実装するUIコンポーネントが存在しない
- 無限スクロール機能を持つフィード表示が存在しない

### 2.3 必要性
- ソーシャルメディア風のUIコンポーネントの実装例を提供する（挙動と見た目を重視）
- 投稿、返信、いいねなどの基本的なSNS機能のUI実装パターンを確立する
- 無限スクロールなどのUXパターンの実装例を提供する
- コンポーネントの動作確認とデモンストレーションのための実装

### 2.4 実現可否
- Next.jsとshadcn/uiを使用して実装可能
- クライアント側でダミーデータを返す実装により、データベース連携なしで実装可能
- 既存のプロジェクト構造に沿って実装可能

## 3. 機能要件

### 3.1 ページの作成

#### 3.1.1 フィード一覧ページ
- **新規作成**: `client/app/feed/[userId]/page.tsx`
- トップページ（`client/app/page.tsx`）の機能一覧に「フィード」リンクを追加
- リンク先: `/feed`（リダイレクト用）
- 実際のフィード一覧ページ: `/feed/[userId]`（`[userId]`はユーザーID）
- ページタイトル: 「フィード」
- 新規投稿フォームを上部に配置
- 投稿一覧を下部に配置
- レスポンシブデザインに対応

#### 3.1.1.1 フィード一覧ページへのリダイレクト
- **新規作成**: `client/app/feed/page.tsx`
- `/feed`にアクセスした際、`/feed/[userId]`にリダイレクトする
- リダイレクト先の`userId`は、固定のダミー`userId`を使用（ダミー実装のため）
- 将来的には、認証ユーザーのIDを使用する想定

#### 3.1.2 返信一覧ページ
- **新規作成**: `client/app/feed/[userId]/[postId]/page.tsx`
- フィード一覧ページの各投稿の「返信」ボタンから遷移
- リンク先: `/feed/[userId]/[postId]`（`[userId]`はユーザーID、`[postId]`は投稿ID）
- ページタイトル: 「返信」
- 返信元のエントリーを一番上に表示
- 返信一覧をその下に配置
- レスポンシブデザインに対応

### 3.2 投稿一覧の表示

#### 3.2.1 初期表示
- ページ読み込み時に最初の10件の投稿を表示
- 投稿は時系列順（新しいものが上）で表示
- 各投稿には以下の情報を表示:
  - 投稿者名（表示名）
  - 投稿者ID（ユーザー名）
  - 投稿日時（相対時刻表示、例: "5分前"）
  - 投稿内容（テキスト）
  - いいね数
  - いいねボタン
  - 返信ボタン（クリックで返信一覧ページに遷移）
- 返信一覧は表示しない（返信一覧ページで表示）

#### 3.2.2 無限スクロール
- **下方向スクロール（古い投稿の読み込み）**:
  - ユーザーがページを下にスクロールした際、自動的に次の10件（古い投稿）を読み込む
  - スクロール位置がページ下部に近づいた際に自動読み込みをトリガー
  - カーソルベースのページネーションを使用（最後に表示された投稿のIDを`fromPostId`として使用）
  - 読み込み中はローディングインジケーターを表示
  - 全ての投稿を読み込み終えた場合は、それ以上読み込めないことを表示

- **上方向スクロール（最新投稿の読み込み）**:
  - ユーザーがページを上にスクロールし、ページトップに近づいた際、最新の10件の投稿を読み込む
  - スクロール位置がページ上部に近づいた際に自動読み込みをトリガー
  - 最新の投稿を取得するため、`getDmFeedPosts`の`fromPostId`パラメータに空文字列を指定
  - 読み込み中はローディングインジケーターを表示
  - 取得した最新の投稿は、既存の投稿一覧の上に追加表示（スクロール位置は維持）

#### 3.2.3 投稿の表示形式
- Twitter風のカード形式で表示
- 投稿者情報、投稿内容、アクションボタン（いいね、返信）を明確に区別
- shadcn/uiのCardコンポーネントを活用

### 3.3 新規投稿機能

#### 3.3.1 投稿フォーム
- ページ上部に投稿フォームを配置
- テキストエリア（最大文字数制限: 280文字）
- 文字数カウンターを表示
- 投稿ボタン
- 投稿成功時、投稿一覧の一番上に新規投稿を追加表示
- 投稿後、フォームをクリア

#### 3.3.2 投稿内容のバリデーション
- 投稿内容が空の場合は投稿不可
- 280文字を超える場合は投稿不可
- バリデーションエラーは適切に表示

### 3.4 返信機能

#### 3.4.1 返信一覧ページの表示
- 返信一覧ページ（`/feed/[userId]/[postId]`）に以下の情報を表示:
  - **返信元のエントリー（一番上）**:
    - 投稿者名（表示名）
    - 投稿者ID（ユーザー名）
    - 投稿日時（相対時刻表示）
    - 投稿内容（テキスト）
    - いいね数
    - いいねボタン
    - 返信ボタン（返信フォーム表示用）
  - **返信一覧（その下）**:
    - 各返信には以下の情報を表示:
      - 返信者名（表示名）
      - 返信者ID（ユーザー名）
      - 返信日時（相対時刻表示）
      - 返信内容（テキスト）
    - 返信は時系列順（古いものが上、新しいものが下）で表示
    - 返信への返信は不可（返信ボタンは表示しない）
    - 返信にはいいね機能は不可（いいねボタンは表示しない）

#### 3.4.2 返信の投稿
- 返信一覧ページに返信フォームを配置（返信元エントリーの下、返信一覧の上）
- 返信フォームにテキストエリア（最大文字数制限: 280文字）
- 文字数カウンターを表示
- 返信ボタン
- 返信成功時、返信一覧の一番下に新規返信を追加表示（新しい返信は下に追加）
- 返信後、返信フォームをクリア

#### 3.4.3 返信の制約
- 返信に対する返信は不可（ネスト機能なし）
- 返信にはいいね機能は不可（いいねボタンは表示しない）

#### 3.4.4 返信一覧の無限スクロール
- 返信一覧も無限スクロールに対応（必要に応じて）
- 下方向スクロール時に新しい返信を読み込む（ページ下部に近づいた際）
- 上方向スクロール時に古い返信を読み込む（ページ上部に近づいた際）
- 注: 返信一覧は投稿一覧と逆の順序（下が新しい）のため、スクロール挙動も逆になる

### 3.5 いいね機能

#### 3.5.1 いいねの表示
- 各投稿に「いいね」ボタンを配置
- いいね数を表示
- いいね済みの場合は視覚的に区別（色の変更等）

#### 3.5.2 いいねの操作
- いいねボタンクリックでいいねのON/OFFを切り替え
- いいね数をリアルタイムで更新
- いいね状態を保持（ページリロード時も維持）

#### 3.5.3 いいねの制約
- 返信にはいいね機能は不可（いいねボタンは表示しない）

### 3.6 API実装（ダミーデータ）

#### 3.6.1 API関数の追加
- `client/lib/api.ts`に以下の関数を追加:
  - `getDmFeedPosts(userId: string, limit: number, fromPostId: string): Promise<DmFeedPost[]>` - フィード一覧取得
  - `createDmFeedPost(userId: string, content: string): Promise<DmFeedPost>` - 新規投稿作成
  - `getDmFeedReplies(userId: string, postId: string, limit: number, fromReplyId: string): Promise<DmFeedReply[]>` - 返信一覧取得
  - `replyToDmPost(userId: string, postId: string, content: string): Promise<DmFeedReply>` - 返信作成
  - `toggleLikeDmPost(userId: string, postId: string): Promise<{ liked: boolean; likeCount: number }>` - いいねのON/OFF
- 注: 全てのAPI関数に`userId`パラメータを追加。操作ユーザーの情報と権限管理のために必要。

#### 3.6.2 ダミーデータの構造
- 投稿（DmFeedPost）の構造:
  - `id: string` - 投稿ID
  - `userId: string` - ユーザーID
  - `userName: string` - ユーザー名（表示名）
  - `userHandle: string` - ユーザーハンドル（@username）
  - `content: string` - 投稿内容
  - `createdAt: string` - 作成日時（ISO 8601形式）
  - `likeCount: number` - いいね数
  - `liked: boolean` - 現在のユーザーがいいね済みか
  - 注: 返信一覧は含まない（返信一覧ページで別途取得）

- 返信（DmFeedReply）の構造:
  - `id: string` - 返信ID
  - `postId: string` - 元の投稿ID
  - `userId: string` - ユーザーID
  - `userName: string` - ユーザー名（表示名）
  - `userHandle: string` - ユーザーハンドル（@username）
  - `content: string` - 返信内容
  - `createdAt: string` - 作成日時（ISO 8601形式）

#### 3.6.3 ダミーデータの生成
- **データ管理方針**: 全てのデータはメモリで管理する（データベース連携なし、ページリロード時は初期化）
- **初期データの生成**: 初期の投稿データ・返信データはランダムで生成する（コンポーネントの挙動と見た目の確認が主目的のため）
- 各API関数は適切なダミーデータを返す
- 全てのAPI関数に`userId`パラメータを渡す（操作ユーザーの識別と権限管理のため）
- 投稿一覧は時系列順（新しいものが先頭）で返す
- `getDmFeedPosts`の`fromPostId`パラメータは、カーソルベースのページネーションに使用
  - 空文字列または未指定の場合: 最新の投稿を取得（上方向スクロール時）
  - 投稿IDが指定された場合: 指定された投稿より古い投稿を取得（下方向スクロール時）
- 返信一覧は時系列順（古いものが先頭、新しいものが末尾）で返す
- `getDmFeedReplies`の`fromReplyId`パラメータは、カーソルベースのページネーションに使用
  - 空文字列または未指定の場合: 最新の返信を取得（下方向スクロール時、返信一覧は下が新しいため）
  - 返信IDが指定された場合: 指定された返信より新しい返信を取得（上方向スクロール時、返信一覧は上が古いため）
- いいね状態はメモリで管理（`userId`をキーとして管理、ページリロード時は初期化）
- 新規投稿はメモリに保持し、ページリロード時は初期化
- 上方向スクロールで取得した最新の投稿は、既存の投稿と重複しないように管理（重複チェック）
- 下方向スクロールで取得した最新の返信は、既存の返信と重複しないように管理（重複チェック）

### 3.7 型定義の追加

#### 3.7.1 TypeScript型定義
- `client/types/dm_feed.ts`を新規作成
- 以下の型を定義:
  - `DmFeedPost` - 投稿の型
  - `DmFeedReply` - 返信の型
  - `CreateDmFeedPostRequest` - 新規投稿リクエストの型
  - `CreateDmFeedReplyRequest` - 返信リクエストの型

## 4. 非機能要件

### 4.1 UI/UX
- shadcn/uiコンポーネントを活用した統一感のあるデザイン
- レスポンシブデザインに対応（モバイル、タブレット、デスクトップ）
- アクセシビリティに配慮（適切なaria-label、キーボード操作対応）
- ローディング状態の適切な表示
- エラー状態の適切な表示

### 4.2 パフォーマンス
- 無限スクロールの実装により、大量の投稿でもパフォーマンスを維持
- 画像やメディアの最適化は不要（本実装ではテキストのみ）

### 4.3 保守性
- コンポーネントを適切に分割し、再利用可能な構造にする
- 型安全性を確保（TypeScript）
- 既存のプロジェクト構造に沿った実装

### 4.4 互換性
- 既存の認証機能と互換性を保つ
- 既存のshadcn/uiコンポーネントと整合性を保つ
- 既存のAPIクライアント構造と整合性を保つ

## 5. 制約事項

### 5.1 技術的制約
- データベース連携は行わない（ダミーデータのみ）
- サーバー側API実装は行わない
- 返信のネスト機能は実装しない（返信に対する返信は不可）
- 返信へのいいね機能は実装しない

### 5.2 実装上の制約
- 既存のプロジェクト構造に沿って実装する
- 既存のshadcn/uiコンポーネントを活用する
- 既存のAPIクライアント構造に沿って実装する

### 5.3 機能の制約
- 認証機能は既存のものを使用（新規実装は不要）
- ユーザー情報はダミーデータで固定（現在の認証ユーザー情報は使用しない）
- ただし、API関数には操作ユーザーの`userId`を渡す必要がある（権限管理と操作履歴のため）
- ダミー実装では、固定のダミー`userId`を使用する想定

## 6. 受け入れ基準

### 6.1 ページの作成
- [ ] `client/app/feed/page.tsx`（リダイレクト用ページ）が作成されている
- [ ] `client/app/feed/[userId]/page.tsx`（フィード一覧ページ）が作成されている
- [ ] `client/app/feed/[userId]/[postId]/page.tsx`（返信一覧ページ）が作成されている
- [ ] `/feed`にアクセスした際、`/feed/[userId]`にリダイレクトされる
- [ ] トップページに「フィード」リンクが追加されている
- [ ] リンクからフィード一覧ページに遷移できる
- [ ] フィード一覧ページの「返信」ボタンから返信一覧ページに遷移できる

### 6.2 投稿一覧の表示
- [ ] ページ読み込み時に最初の10件の投稿が表示される
- [ ] 投稿が時系列順（新しいものが上）で表示される
- [ ] 各投稿に必要な情報（投稿者名、投稿者ID、投稿日時、投稿内容、いいね数）が表示される
- [ ] 下方向スクロール時に古い投稿10件が自動的に読み込まれる
- [ ] 上方向スクロール時に最新の投稿10件が自動的に読み込まれる
- [ ] 上方向スクロールで取得した最新の投稿が、既存の投稿一覧の上に追加表示される
- [ ] 最新の投稿取得時に、既存の投稿との重複が発生しない
- [ ] 全ての投稿を読み込み終えた場合、適切に表示される

### 6.3 新規投稿機能
- [ ] 投稿フォームがページ上部に表示される
- [ ] テキストエリアに最大280文字の制限がある
- [ ] 文字数カウンターが表示される
- [ ] 投稿ボタンで投稿できる
- [ ] 投稿成功時、投稿一覧の一番上に新規投稿が追加表示される
- [ ] 投稿後、フォームがクリアされる
- [ ] バリデーションエラーが適切に表示される

### 6.4 返信機能
- [ ] フィード一覧ページの各投稿に「返信」ボタンが表示される
- [ ] 返信ボタンクリックで返信一覧ページに遷移できる
- [ ] 返信一覧ページに返信元のエントリーが一番上に表示される
- [ ] 返信一覧ページに返信一覧が表示される
- [ ] 返信は時系列順（古いものが上、新しいものが下）で表示される
- [ ] 返信に必要な情報（返信者名、返信者ID、返信日時、返信内容）が表示される
- [ ] 返信に対する返信は不可（返信ボタンは表示されない）
- [ ] 返信一覧ページで返信の投稿が正常に動作する
- [ ] 返信成功時、返信一覧の一番下に新規返信が追加表示される（新しい返信は下に追加）

### 6.5 いいね機能
- [ ] 各投稿に「いいね」ボタンが表示される
- [ ] いいね数が表示される
- [ ] いいねボタンクリックでいいねのON/OFFが切り替わる
- [ ] いいね数がリアルタイムで更新される
- [ ] いいね済みの場合は視覚的に区別される
- [ ] 返信にはいいね機能は不可（いいねボタンは表示されない）

### 6.6 API実装
- [ ] `client/lib/api.ts`に必要なAPI関数（`getDmFeedPosts`、`createDmFeedPost`、`getDmFeedReplies`、`replyToDmPost`、`toggleLikeDmPost`）が追加されている
- [ ] 全てのAPI関数に`userId`パラメータが含まれている
- [ ] 各API関数が適切なダミーデータを返す
- [ ] 投稿一覧が時系列順（新しいものが先頭）で返される
- [ ] 返信一覧が時系列順（古いものが先頭、新しいものが末尾）で返される
- [ ] いいね状態が適切に管理される（`userId`をキーとして管理）

### 6.7 型定義
- [ ] `client/types/dm_feed.ts`が作成されている
- [ ] 必要な型定義（`DmFeedPost`、`DmFeedReply`、`CreateDmFeedPostRequest`、`CreateDmFeedReplyRequest`）が全て定義されている

### 6.8 UI/UX
- [ ] shadcn/uiコンポーネントが適切に使用されている
- [ ] レスポンシブデザインに対応している
- [ ] アクセシビリティに配慮されている
- [ ] ローディング状態が適切に表示される
- [ ] エラー状態が適切に表示される

## 7. 影響範囲

### 7.1 変更されるファイル
- `client/app/page.tsx`: 機能一覧に「フィード」リンクを追加
- `client/lib/api.ts`: フィード関連のAPI関数を追加
- `client/types/dm_feed.ts`: 新規作成（型定義）

### 7.2 新規作成されるファイル
- `client/app/feed/page.tsx`: リダイレクト用ページ（`/feed/[userId]`にリダイレクト）
- `client/app/feed/[userId]/page.tsx`: フィード一覧ページ
- `client/app/feed/[userId]/[postId]/page.tsx`: 返信一覧ページ
- `client/components/feed/`: フィード関連コンポーネント（必要に応じて）
  - `feed-post.tsx`: 投稿コンポーネント（必要に応じて）
  - `feed-reply.tsx`: 返信コンポーネント（必要に応じて）
  - `feed-form.tsx`: 投稿フォームコンポーネント（必要に応じて）
  - `reply-form.tsx`: 返信フォームコンポーネント（必要に応じて）
- `client/types/dm_feed.ts`: 型定義

### 7.3 既存ファイルへの影響
- 既存のAPIクライアント構造に影響なし（追加のみ）
- 既存のページに影響なし（新規ページの追加のみ）
- 既存のコンポーネントに影響なし

### 7.4 既存機能への影響
- 既存の機能への影響なし
- 認証機能は既存のものを使用（変更なし）

## 8. 実装上の注意事項

### 8.1 コンポーネント設計
- コンポーネントを適切に分割し、再利用可能な構造にする
- 状態管理はReact Hooks（useState、useEffect等）を使用
- 無限スクロールの実装にはIntersection Observer APIを活用
- 上方向スクロールと下方向スクロールの両方に対応するため、ページ上部と下部の両方にIntersection Observerを設定
- 上方向スクロールで取得した最新の投稿を既存の投稿一覧の上に追加する際、スクロール位置を維持する実装を考慮
- 重複投稿のチェック機能を実装（投稿IDをキーとして管理）

### 8.2 ダミーデータの管理
- **データ管理方針**: 全てのデータはメモリで管理する（データベース連携なし、ページリロード時は初期化）
- **初期データの生成**: 初期の投稿データ・返信データはランダムで生成する（コンポーネントの挙動と見た目の確認が主目的のため）
- いいね状態はメモリで管理（`userId`をキーとして管理、ページリロード時は初期化）
- 新規投稿はメモリに保持し、ページリロード時は初期化
- 全てのAPI関数呼び出し時に、操作ユーザーの`userId`を渡す（ダミー実装では固定のダミー`userId`を使用）
- ランダム生成するデータには、適切なバリエーションを持たせる（投稿者名、投稿内容、日時など）

### 8.3 日時の表示
- 投稿日時は相対時刻表示（例: "5分前"、"1時間前"、"3日前"）
- 必要に応じてライブラリ（例: `date-fns`）を使用

### 8.4 エラーハンドリング
- API呼び出し時のエラーを適切にハンドリング
- ユーザーフレンドリーなエラーメッセージを表示
- ネットワークエラーなどの適切な処理

### 8.5 テスト
- コンポーネントの単体テストは不要（本実装では）
- E2Eテストは不要（本実装では）
- 動作確認は手動で実施

## 9. 参考情報

### 9.1 関連ドキュメント
- 既存の`client/app/page.tsx`
- 既存の`client/lib/api.ts`
- shadcn/uiドキュメント
- Next.js App Routerドキュメント

### 9.2 関連Issue
- https://github.com/taku-o/go-webdb-template/issues/142: 本要件定義書の元となったIssue

### 9.3 技術スタック
- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript 5+
- **UIライブラリ**: shadcn/ui
- **スタイリング**: Tailwind CSS

### 9.4 実装の流れ
1. 型定義の作成（`client/types/dm_feed.ts`）
2. API関数の追加（`client/lib/api.ts`）
3. リダイレクト用ページの作成（`client/app/feed/page.tsx`）
4. フィード一覧ページの作成（`client/app/feed/[userId]/page.tsx`）
5. 返信一覧ページの作成（`client/app/feed/[userId]/[postId]/page.tsx`）
6. コンポーネントの作成（必要に応じて）
7. トップページへのリンク追加（`client/app/page.tsx`）
8. 動作確認

### 9.5 依存関係
- 既存のNext.jsプロジェクト構造
- 既存のshadcn/uiコンポーネント
- 既存の認証機能（使用のみ、変更なし）

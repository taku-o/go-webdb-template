# dm_news_viewビュー作成要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Issue番号**: #78
- **Issueタイトル**: Atlasのビュー作成機能を確認する
- **Feature名**: 0039-dm_news_view
- **作成日**: 2025-01-27

### 1.2 目的
Atlasのビュー作成機能を確認し、`dm_news`テーブルから`dm_news_view`ビューを作成する。作成したビューはCloudBeaverで確認できることを確認する。プログラムからビューを参照する必要はない。

### 1.3 スコープ
- Atlasのビュー作成機能の確認
- `dm_news_view`ビューの定義（Atlas HCL形式）
- ビューのマイグレーション生成と適用
- CloudBeaverでのビュー確認
- ビューの動作確認

**本実装の範囲外**:
- プログラムからのビュー参照（API、Repository層など）
- ビューに対するインデックス作成
- ビューのパフォーマンス最適化
- ビューの更新・削除機能

## 2. 背景・現状分析

### 2.1 現状の実装
- **データベース管理**: Atlas CLIを使用（Issue #26で導入済み）
- **スキーマ定義**: `db/schema/master.hcl`でマスターデータベースのスキーマを定義
- **データベースビューア**: CloudBeaverを使用（Issue #27で導入済み）
- **dm_newsテーブル**: マスターデータベースに存在
  - カラム: `id`, `title`, `content`, `author_id`, `published_at`, `created_at`, `updated_at`
  - 主キー: `id`
  - インデックス: `idx_dm_news_published_at`, `idx_dm_news_author_id`

### 2.2 課題点
1. **Atlasのビュー作成機能の未確認**: Atlasでビューを作成する方法が確認されていない
2. **ビュー定義の不足**: `dm_news`テーブルから必要なカラムのみを抽出したビューが存在しない
3. **ビュー作成のワークフロー未確立**: Atlasを使用したビュー作成の手順が確立されていない

### 2.3 本実装による改善点
1. **Atlasのビュー作成機能の確認**: Atlasでビューを作成する方法を確認し、ドキュメント化
2. **ビュー定義の追加**: `dm_news_view`ビューを定義し、必要なカラムのみを抽出
3. **ビュー作成ワークフローの確立**: Atlasを使用したビュー作成の手順を確立

## 3. 要件定義

### 3.1 ビュー定義要件

#### REQ-1: dm_news_viewビューの定義
- **要件**: `dm_news`テーブルから必要なカラムのみを抽出した`dm_news_view`ビューを定義する
- **詳細**:
  - ビュー名: `dm_news_view`
  - ベーステーブル: `dm_news`
  - 抽出カラム:
    - `id`: 主キー
    - `title`: タイトル
    - `content`: コンテンツ
    - `published_at`: 公開日時
  - 除外カラム:
    - `author_id`: ビューには含めない
    - `created_at`: ビューには含めない
    - `updated_at`: ビューには含めない
- **定義形式**: Atlas HCL形式（`db/schema/master.hcl`に追加）
- **受け入れ基準**:
  - `db/schema/master.hcl`にビュー定義が追加されている
  - ビュー定義の構文が正しい
  - Atlasスキーマ検証が正常に完了する

### 3.2 Atlasビュー作成機能の確認要件

#### REQ-2: Atlasのビュー作成機能の確認
- **要件**: Atlasでビューを作成する方法を確認し、ドキュメント化する
- **詳細**:
  - Atlas HCL形式でのビュー定義方法を確認
  - ビュー定義の構文を確認
  - ビューのマイグレーション生成方法を確認
  - ビューのマイグレーション適用方法を確認
  - ビュー定義の検証方法を確認
- **受け入れ基準**:
  - Atlasでビューを作成できることが確認できている
  - ビュー作成の手順がドキュメント化されている
  - ビュー作成時の注意事項が記載されている

### 3.3 マイグレーション生成と適用要件

#### REQ-3: ビューのマイグレーション生成
- **要件**: `dm_news_view`ビューを作成するマイグレーションファイルを生成する
- **詳細**:
  - `atlas migrate diff`コマンドを使用してマイグレーションファイルを生成
  - マイグレーションファイルは`db/migrations/master/`ディレクトリに保存
  - マイグレーションファイルの命名規則に従う
- **受け入れ基準**:
  - マイグレーションファイルが正常に生成される
  - マイグレーションファイルの内容が正しい
  - マイグレーションファイルがGitで管理できる

#### REQ-4: ビューのマイグレーション適用
- **要件**: 生成したマイグレーションファイルを適用してビューを作成する
- **詳細**:
  - `atlas migrate apply`コマンドを使用してマイグレーションを適用
  - 開発環境（develop）でマイグレーションを適用
  - マイグレーション適用後、ビューが正常に作成されることを確認
- **受け入れ基準**:
  - マイグレーションが正常に適用される
  - ビューがデータベースに正常に作成される
  - マイグレーション履歴が正常に記録される

### 3.4 CloudBeaverでの確認要件

#### REQ-5: CloudBeaverでのビュー確認
- **要件**: CloudBeaverで`dm_news_view`ビューを確認できることを確認する
- **詳細**:
  - CloudBeaverを起動
  - マスターデータベースに接続
  - `dm_news_view`ビューが表示されることを確認
  - ビューの構造（カラム一覧）が正しいことを確認
  - ビューのデータが正しく表示されることを確認
  - ビューに対してSQLクエリを実行できることを確認
- **受け入れ基準**:
  - CloudBeaverで`dm_news_view`ビューが表示される
  - ビューのカラム（`id`, `title`, `content`, `published_at`）が正しく表示される
  - ビューのデータが正しく表示される
  - ビューに対してSQLクエリを実行できる

### 3.5 ビューの動作確認要件

#### REQ-6: ビューの動作確認
- **要件**: `dm_news_view`ビューが正しく動作することを確認する
- **詳細**:
  - ビューからデータを取得できることを確認
  - ビューに含まれるカラムが正しいことを確認（`id`, `title`, `content`, `published_at`のみ）
  - ビューに含まれないカラムが除外されていることを確認（`author_id`, `created_at`, `updated_at`）
  - ビューのデータが`dm_news`テーブルのデータと一致することを確認
- **受け入れ基準**:
  - ビューからデータを取得できる
  - ビューのカラムが正しい
  - ビューのデータが`dm_news`テーブルのデータと一致する

## 4. 非機能要件

### 4.1 ドキュメント要件
- **ビュー作成手順のドキュメント化**: Atlasでビューを作成する手順をドキュメント化
- **ビュー定義の説明**: `dm_news_view`ビューの目的と構造を説明
- **注意事項の記載**: ビュー作成時の注意事項を記載

### 4.2 既存システムとの整合性
- **既存のスキーマ定義との整合性**: `db/schema/master.hcl`の既存定義との整合性を維持
- **既存のマイグレーションとの整合性**: 既存のマイグレーション履歴との整合性を維持
- **既存のデータベース構造との整合性**: 既存のデータベース構造を変更しない

### 4.3 保守性
- **ビュー定義の明確性**: ビュー定義が明確で理解しやすい
- **ドキュメントの充実**: ビュー作成の手順と注意事項が明確に記載されている

## 5. 制約事項

### 5.1 技術的制約
- **Atlas形式のビュー定義**: Atlas HCL形式でビューを定義する必要がある
- **データベース**: SQLite（開発環境）で動作確認
- **既存のAtlas設定**: 既存のAtlas設定（`config/{env}/atlas.hcl`）を使用

### 5.2 既存システムとの整合性
- **既存のスキーマ定義**: `db/schema/master.hcl`の既存定義を変更しない
- **既存のマイグレーション**: 既存のマイグレーション履歴を変更しない
- **既存のデータベース構造**: 既存のデータベース構造（テーブル、インデックスなど）を変更しない

### 5.3 ビューの用途
- **プログラムからの参照なし**: ビューはプログラムから参照しない（CloudBeaverでの確認のみ）
- **読み取り専用**: ビューは読み取り専用として使用（更新・削除は行わない）

## 6. 受け入れ基準

### 6.1 ビュー定義
- [ ] `db/schema/master.hcl`に`dm_news_view`ビューの定義が追加されている
- [ ] ビュー定義の構文が正しい
- [ ] ビューに含まれるカラムが正しい（`id`, `title`, `content`, `published_at`）
- [ ] Atlasスキーマ検証が正常に完了する

### 6.2 Atlasビュー作成機能の確認
- [ ] Atlasでビューを作成できることが確認できている
- [ ] ビュー作成の手順がドキュメント化されている
- [ ] ビュー作成時の注意事項が記載されている

### 6.3 マイグレーション生成と適用
- [ ] マイグレーションファイルが正常に生成される
- [ ] マイグレーションファイルの内容が正しい
- [ ] マイグレーションが正常に適用される
- [ ] ビューがデータベースに正常に作成される
- [ ] マイグレーション履歴が正常に記録される

### 6.4 CloudBeaverでの確認
- [ ] CloudBeaverで`dm_news_view`ビューが表示される
- [ ] ビューのカラム（`id`, `title`, `content`, `published_at`）が正しく表示される
- [ ] ビューのデータが正しく表示される
- [ ] ビューに対してSQLクエリを実行できる

### 6.5 ビューの動作確認
- [ ] ビューからデータを取得できる
- [ ] ビューのカラムが正しい（`id`, `title`, `content`, `published_at`のみ）
- [ ] ビューのデータが`dm_news`テーブルのデータと一致する

### 6.6 ドキュメント
- [ ] ビュー作成手順がドキュメント化されている
- [ ] ビュー定義の説明が記載されている
- [ ] 注意事項が記載されている

## 7. 影響範囲

### 7.1 新規追加が必要なファイル
- **スキーマ定義**: `db/schema/master.hcl`にビュー定義を追加
- **マイグレーションファイル**: `db/migrations/master/`ディレクトリにマイグレーションファイルを追加
- **ドキュメント**: ビュー作成手順のドキュメント（必要に応じて）

### 7.2 変更が必要なファイル
- **スキーマ定義**: `db/schema/master.hcl`にビュー定義を追加（既存定義は変更しない）

### 7.3 既存ファイルの扱い
- **既存のスキーマ定義**: 既存のテーブル定義は変更しない
- **既存のマイグレーション**: 既存のマイグレーションファイルは変更しない
- **既存のデータベース構造**: 既存のテーブル、インデックスなどは変更しない

## 8. 実装上の注意事項

### 8.1 Atlas HCL形式でのビュー定義
- Atlas HCL形式の構文に従ってビューを定義
- ビュー定義の構文をAtlas公式ドキュメントで確認
- ビュー定義の検証を実施

### 8.2 ビュー定義の構造
- ビュー名: `dm_news_view`
- ベーステーブル: `dm_news`
- 抽出カラム: `id`, `title`, `content`, `published_at`
- SELECT文の構文を正しく記述

### 8.3 マイグレーション生成と適用
- `atlas migrate diff`コマンドでマイグレーションファイルを生成
- 生成されたマイグレーションファイルの内容を確認
- `atlas migrate apply`コマンドでマイグレーションを適用
- マイグレーション適用後、ビューが正常に作成されることを確認

### 8.4 CloudBeaverでの確認
- CloudBeaverを起動
- マスターデータベースに接続
- `dm_news_view`ビューが表示されることを確認
- ビューの構造とデータを確認

### 8.5 ビューの動作確認
- ビューからデータを取得するSQLクエリを実行
- ビューのカラムが正しいことを確認
- ビューのデータが`dm_news`テーブルのデータと一致することを確認

### 8.6 ドキュメント整備
- Atlasでビューを作成する手順をドキュメント化
- `dm_news_view`ビューの目的と構造を説明
- ビュー作成時の注意事項を記載

## 9. 参考情報

### 9.1 関連Issue
- GitHub Issue #78: Atlasのビュー作成機能を確認する

### 9.2 既存ドキュメント
- `README.md`: プロジェクト概要とセットアップ手順
- `docs/Atlas.md`: Atlasの使用方法（既存）
- `db/schema/master.hcl`: マスターデータベーススキーマ定義

### 9.3 技術スタック
- **Atlas**: 最新の安定版を使用
- **データベース**: SQLite（開発環境）
- **CloudBeaver**: データベースビューア（Issue #27で導入済み）

### 9.4 参考リンク
- Atlas公式ドキュメント: https://atlasgo.io/
- Atlas HCL形式リファレンス: https://atlasgo.io/schema-reference
- Atlasビュー定義: Atlas公式ドキュメントでビュー定義の構文を確認

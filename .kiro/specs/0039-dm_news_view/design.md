# dm_news_viewビュー作成設計書

## 1. 概要

### 1.1 設計の目的

要件定義書に基づき、Issue #78の対応として、Atlasのビュー作成機能を確認し、`dm_news`テーブルから`dm_news_view`ビューを作成する機能の詳細設計を定義する。

### 1.2 設計の範囲

- Atlas HCL形式でのビュー定義
- ビュー定義のスキーマファイルへの追加
- マイグレーション生成と適用
- CloudBeaverでのビュー確認
- ビュー作成手順のドキュメント化

### 1.3 設計方針

- **シンプルな実装**: Atlasの標準的なビュー定義機能を使用
- **既存スキーマとの整合性**: 既存の`db/schema/master.hcl`の構造を維持
- **段階的実装**: ビュー定義→マイグレーション生成→適用→確認の順で実装
- **ドキュメント化**: ビュー作成の手順と注意事項を明確に記載

## 2. アーキテクチャ設計

### 2.1 ビュー定義の構造

#### 2.1.1 ビュー定義の配置

```
db/schema/
└── master.hcl
    ├── schema "main" { ... }
    ├── table "dm_news" { ... }
    ├── table "goadmin_*" { ... }
    └── view "dm_news_view" { ... }  ← 新規追加
```

#### 2.1.2 ビュー定義の構造

```hcl
view "dm_news_view" {
  schema = schema.main
  as     = "SELECT id, title, content, published_at FROM dm_news"
}
```

### 2.2 ビュー作成フロー

```
┌─────────────────────────────────────────────────────────┐
│              ビュー作成フロー                             │
│                                                          │
│  1. スキーマ定義ファイルにビュー定義を追加                │
│     db/schema/master.hcl                                │
│                    │                                     │
│                    ▼                                     │
│  2. Atlasスキーマ検証                                    │
│     atlas schema validate                                │
│                    │                                     │
│                    ▼                                     │
│  3. マイグレーションファイル生成                          │
│     atlas migrate diff                                   │
│                    │                                     │
│                    ▼                                     │
│  4. マイグレーション適用                                  │
│     atlas migrate apply                                  │
│                    │                                     │
│                    ▼                                     │
│  5. CloudBeaverでビュー確認                              │
│     - ビューの表示確認                                   │
│     - データの確認                                       │
│     - SQLクエリの実行確認                                 │
└─────────────────────────────────────────────────────────┘
```

### 2.3 ビュー定義の詳細

#### 2.3.1 ビュー名とスキーマ

- **ビュー名**: `dm_news_view`
- **スキーマ**: `main`（既存のスキーマ定義と同じ）
- **ベーステーブル**: `dm_news`

#### 2.3.2 抽出カラム

- `id`: 主キー（integer型）
- `title`: タイトル（text型）
- `content`: コンテンツ（text型）
- `published_at`: 公開日時（datetime型、NULL許可）

#### 2.3.3 除外カラム

- `author_id`: ビューには含めない
- `created_at`: ビューには含めない
- `updated_at`: ビューには含めない

#### 2.3.4 SELECT文の定義

```sql
SELECT 
  id, 
  title, 
  content, 
  published_at 
FROM dm_news
```

## 3. 実装設計

### 3.1 スキーマ定義ファイルの修正

#### 3.1.1 ファイルパス

- **ファイル**: `db/schema/master.hcl`
- **修正内容**: ビュー定義を追加

#### 3.1.2 ビュー定義の追加位置

- 既存のテーブル定義（`dm_news`テーブル）の後に追加
- GoAdmin関連テーブル定義の前に追加（推奨）
- または、ファイルの最後に追加

#### 3.1.3 ビュー定義の記述

```hcl
// dm_news_view ビュー
view "dm_news_view" {
  schema = schema.main
  as     = "SELECT id, title, content, published_at FROM dm_news"
}
```

### 3.2 マイグレーション生成と適用

#### 3.2.1 マイグレーション生成コマンド

```bash
atlas migrate diff \
  --dir "file://db/migrations/master" \
  --to "file://db/schema/master.hcl" \
  --dev-url "sqlite://file?mode=memory"
```

#### 3.2.2 マイグレーション適用コマンド

```bash
atlas migrate apply \
  --dir "file://db/migrations/master" \
  --url "sqlite://server/data/master.db"
```

#### 3.2.3 マイグレーションファイルの命名

- Atlasの標準命名規則に従う
- 例: `YYYYMMDDHHMMSS_create_dm_news_view.sql`（Atlasが自動生成）

### 3.3 CloudBeaverでの確認手順

#### 3.3.1 CloudBeaver起動

```bash
npm run cloudbeaver:start
```

#### 3.3.2 データベース接続確認

1. CloudBeaverにアクセス（http://localhost:8978）
2. マスターデータベース（`master.db`）に接続
3. データベースツリーでビュー一覧を確認

#### 3.3.3 ビュー確認項目

1. **ビューの表示確認**
   - `dm_news_view`がビュー一覧に表示される
   - ビューの構造（カラム一覧）が正しい

2. **データの確認**
   - ビューからデータを取得できる
   - データが`dm_news`テーブルのデータと一致する

3. **SQLクエリの実行確認**
   - `SELECT * FROM dm_news_view`が実行できる
   - 結果が正しく表示される

## 4. データモデル設計

### 4.1 ビューのデータ構造

#### 4.1.1 ビューのカラム定義

| カラム名 | データ型 | NULL許可 | 説明 |
|---------|---------|---------|------|
| id | integer | NOT NULL | 主キー |
| title | text | NOT NULL | タイトル |
| content | text | NOT NULL | コンテンツ |
| published_at | datetime | NULL | 公開日時 |

#### 4.1.2 ベーステーブルとの関係

```
dm_news テーブル
├── id (integer, NOT NULL, PK)
├── title (text, NOT NULL)
├── content (text, NOT NULL)
├── author_id (integer, NULL)          ← ビューに含めない
├── published_at (datetime, NULL)      ← ビューに含める
├── created_at (datetime, NOT NULL)   ← ビューに含めない
└── updated_at (datetime, NOT NULL)   ← ビューに含めない
                    │
                    ▼
        dm_news_view ビュー
        ├── id (integer, NOT NULL)
        ├── title (text, NOT NULL)
        ├── content (text, NOT NULL)
        └── published_at (datetime, NULL)
```

### 4.2 ビューの特性

#### 4.2.1 読み取り専用

- ビューは読み取り専用として使用
- ビューに対するINSERT、UPDATE、DELETEは行わない
- データの変更はベーステーブル（`dm_news`）に対して行う

#### 4.2.2 データの同期

- ビューはベーステーブルのデータをリアルタイムで反映
- ビューのデータは常にベーステーブルの最新データを表示
- ビューの更新は不要（ベーステーブルの更新が自動的に反映される）

## 5. エラーハンドリング

### 5.1 スキーマ検証エラー

#### 5.1.1 ビュー定義の構文エラー

- **原因**: HCL形式の構文エラー
- **対処**: Atlasスキーマ検証コマンドでエラーを確認し、構文を修正

#### 5.1.2 参照テーブルの不存在

- **原因**: `dm_news`テーブルが存在しない
- **対処**: ベーステーブルが存在することを確認

### 5.2 マイグレーションエラー

#### 5.2.1 マイグレーション生成エラー

- **原因**: スキーマ定義の不整合
- **対処**: スキーマ定義を確認し、修正

#### 5.2.2 マイグレーション適用エラー

- **原因**: データベース接続エラー、権限エラーなど
- **対処**: データベース接続設定を確認し、権限を確認

### 5.3 CloudBeaverでの確認エラー

#### 5.3.1 ビューが表示されない

- **原因**: ビューが正常に作成されていない
- **対処**: マイグレーション適用を確認し、データベースを確認

#### 5.3.2 データが表示されない

- **原因**: ベーステーブルにデータがない、ビュー定義の不整合
- **対処**: ベーステーブルのデータを確認し、ビュー定義を確認

## 6. テスト設計

### 6.1 スキーマ検証テスト

#### 6.1.1 Atlasスキーマ検証

- **テスト内容**: `atlas schema validate`コマンドでスキーマ定義を検証
- **期待結果**: エラーが発生しない
- **実行タイミング**: ビュー定義追加後

### 6.2 マイグレーションテスト

#### 6.2.1 マイグレーション生成テスト

- **テスト内容**: `atlas migrate diff`コマンドでマイグレーションファイルを生成
- **期待結果**: マイグレーションファイルが正常に生成される
- **実行タイミング**: スキーマ検証後

#### 6.2.2 マイグレーション適用テスト

- **テスト内容**: `atlas migrate apply`コマンドでマイグレーションを適用
- **期待結果**: マイグレーションが正常に適用され、ビューが作成される
- **実行タイミング**: マイグレーションファイル生成後

### 6.3 ビュー動作テスト

#### 6.3.1 ビュー存在確認テスト

- **テスト内容**: データベースに`dm_news_view`ビューが存在することを確認
- **期待結果**: ビューが存在する
- **実行方法**: SQLクエリで確認（`SELECT name FROM sqlite_master WHERE type='view' AND name='dm_news_view'`）

#### 6.3.2 ビュー構造確認テスト

- **テスト内容**: ビューのカラムが正しいことを確認
- **期待結果**: カラム（`id`, `title`, `content`, `published_at`）が正しく定義されている
- **実行方法**: SQLクエリで確認（`PRAGMA table_info(dm_news_view)`）

#### 6.3.3 ビューデータ確認テスト

- **テスト内容**: ビューからデータを取得できることを確認
- **期待結果**: データが正しく取得できる
- **実行方法**: SQLクエリで確認（`SELECT * FROM dm_news_view LIMIT 10`）

#### 6.3.4 ビューデータ整合性テスト

- **テスト内容**: ビューのデータがベーステーブルのデータと一致することを確認
- **期待結果**: データが一致する
- **実行方法**: SQLクエリで比較（`SELECT COUNT(*) FROM dm_news_view`と`SELECT COUNT(*) FROM dm_news`を比較）

### 6.4 CloudBeaver確認テスト

#### 6.4.1 ビュー表示確認テスト

- **テスト内容**: CloudBeaverでビューが表示されることを確認
- **期待結果**: ビューがビュー一覧に表示される
- **実行方法**: CloudBeaverのUIで確認

#### 6.4.2 ビューデータ表示確認テスト

- **テスト内容**: CloudBeaverでビューのデータが表示されることを確認
- **期待結果**: データが正しく表示される
- **実行方法**: CloudBeaverのUIで確認

#### 6.4.3 SQLクエリ実行確認テスト

- **テスト内容**: CloudBeaverでビューに対してSQLクエリを実行できることを確認
- **期待結果**: SQLクエリが正常に実行される
- **実行方法**: CloudBeaverのSQLエディタで確認

## 7. ドキュメント設計

### 7.1 ビュー作成手順のドキュメント化

#### 7.1.1 ドキュメントの内容

- Atlasでビューを作成する基本的な手順
- ビュー定義の構文説明
- マイグレーション生成と適用の手順
- CloudBeaverでの確認手順
- トラブルシューティング

#### 7.1.2 ドキュメントの配置

- **既存ドキュメントの更新**: `docs/Atlas.md`にビュー作成のセクションを追加
- **または新規ドキュメント**: `docs/Atlas-Views.md`を作成（必要に応じて）

### 7.2 ビュー定義の説明

#### 7.2.1 ビューの目的

- `dm_news_view`ビューの目的と用途を説明
- ビューに含まれるカラムと除外されるカラムの理由を説明

#### 7.2.2 ビューの構造

- ビューのカラム定義を説明
- ベーステーブルとの関係を説明

## 8. 実装上の注意事項

### 8.1 Atlas HCL形式でのビュー定義

#### 8.1.1 ビュー定義の構文

- Atlas公式ドキュメントでビュー定義の構文を確認
- HCL形式の構文に従ってビューを定義
- `view`ブロックを使用してビューを定義

#### 8.1.2 SELECT文の記述

- SELECT文は文字列として記述
- SQLの構文に従って記述
- カラム名は正確に記述（大文字小文字を区別）

### 8.2 既存スキーマとの整合性

#### 8.2.1 スキーマ定義の構造

- 既存の`db/schema/master.hcl`の構造を維持
- 既存のテーブル定義を変更しない
- ビュー定義を適切な位置に追加

#### 8.2.2 スキーマ検証

- ビュー定義追加後、必ずAtlasスキーマ検証を実行
- エラーが発生した場合は、構文を確認し修正

### 8.3 マイグレーション管理

#### 8.3.1 マイグレーションファイルの管理

- マイグレーションファイルはGitで管理
- マイグレーションファイルの命名規則に従う
- マイグレーション履歴を確認

#### 8.3.2 マイグレーション適用の確認

- マイグレーション適用後、必ずビューが作成されていることを確認
- マイグレーション履歴を確認

### 8.4 CloudBeaverでの確認

#### 8.4.1 ビュー表示の確認

- CloudBeaverでビューが表示されることを確認
- ビューの構造（カラム一覧）が正しいことを確認

#### 8.4.2 データ確認

- ビューのデータが正しく表示されることを確認
- ベーステーブルのデータと一致することを確認

## 9. 参考情報

### 9.1 Atlas公式ドキュメント

- Atlas公式サイト: https://atlasgo.io/
- Atlas HCL形式リファレンス: https://atlasgo.io/schema-reference
- Atlasビュー定義: Atlas公式ドキュメントでビュー定義の構文を確認

### 9.2 既存のスキーマ定義

- `db/schema/master.hcl`: マスターデータベーススキーマ定義
- `db/schema/sharding.hcl`: シャーディングデータベーススキーマ定義（参考）

### 9.3 関連Issue

- GitHub Issue #78: Atlasのビュー作成機能を確認する
- GitHub Issue #26: データベースの管理にAtlasを導入（Atlas導入）
- GitHub Issue #27: データの管理機能としてのCloudBeaverの導入（CloudBeaver導入）

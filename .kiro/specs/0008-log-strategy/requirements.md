# ログ出力機能要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Issue番号**: #10
- **Issueタイトル**: ログ出力機能の組み込み
- **Feature名**: 0008-log-strategy
- **作成日**: 2025-01-27

### 1.2 目的
APIサーバーと管理画面サーバー（クライアントサーバー）のアクセスログを日付別ファイルに出力する機能を実装する。
これにより、サーバーの動作状況を記録し、トラブルシューティングや監視を容易にする。

### 1.3 スコープ
- APIサーバー（`server/cmd/server/main.go`）のアクセスログ出力機能
- 管理画面サーバー（`server/cmd/admin/main.go`）のアクセスログ出力機能（production環境以外）
- 日付別ログファイル分割機能
- ログ出力先の設定機能（デフォルト: `logs`ディレクトリ）
- `.gitignore`の更新（`logs`ディレクトリ内のファイル・ディレクトリを除外）
- `logs/.gitkeep`の追加（ディレクトリを保持）

## 2. 背景・現状分析

### 2.1 現在の実装
- **ログ出力**: Go言語の標準`log`パッケージを使用
- **出力先**: 標準出力（stdout）のみ
- **アクセスログ**: HTTPリクエストのアクセスログ機能が存在しない
- **ログの永続化**: ファイル出力機能がないため、ログが永続化されない
- **設定**: `internal/config/config.go`に`LoggingConfig`構造体が存在するが、ファイル出力に関する設定項目がない
- **ログライブラリ**: サードパーティのログライブラリは使用していない

### 2.2 課題点
1. **アクセスログの欠如**: HTTPリクエストのアクセスログが記録されないため、トラブルシューティングが困難
2. **ログの永続化不足**: 標準出力のみのため、サーバー再起動時にログが失われる
3. **ログ管理の困難**: 日付別のログファイル分割がないため、大量のログが1つのファイルに蓄積される
4. **環境別の制御不足**: 管理画面サーバーのログをproduction環境で出力しない制御がない

### 2.3 本実装による改善点
1. **アクセスログの記録**: HTTPリクエストの詳細（メソッド、パス、ステータスコード、レスポンス時間など）を記録
2. **ログの永続化**: ファイル出力により、ログを永続的に保存
3. **日付別ログファイル**: 日付ごとにログファイルを分割し、管理を容易にする
4. **環境別制御**: production環境では管理画面サーバーのログを出力しない
5. **設定による柔軟性**: ログ出力先を設定ファイルで変更可能

## 3. 機能要件

### 3.1 APIサーバーアクセスログ機能

#### 3.1.1 基本機能
- APIサーバー（`server/cmd/server/main.go`）へのすべてのHTTPリクエストをログに記録する
- すべての環境（develop/staging/production）で有効

#### 3.1.2 ログ出力内容
以下の情報をログに記録する：
- リクエスト日時（タイムスタンプ）
- HTTPメソッド（GET, POST, PUT, DELETE等）
- リクエストパス（URLパス）
- HTTPステータスコード
- レスポンス時間（ミリ秒）
- リモートIPアドレス（オプション）
- User-Agent（オプション）

#### 3.1.3 ログファイル名
- 形式: `api-access-YYYY-MM-DD.log`
- 例: `api-access-2025-01-27.log`
- 日付が変わったら自動的に新しいファイルに切り替える

### 3.2 管理画面サーバーアクセスログ機能

#### 3.2.1 基本機能
- 管理画面サーバー（`server/cmd/admin/main.go`）へのすべてのHTTPリクエストをログに記録する
- production環境以外（develop/staging環境）でのみ有効

#### 3.2.2 ログ出力内容
APIサーバーアクセスログと同様の情報を記録する：
- リクエスト日時（タイムスタンプ）
- HTTPメソッド
- リクエストパス
- HTTPステータスコード
- レスポンス時間（ミリ秒）
- リモートIPアドレス（オプション）
- User-Agent（オプション）

#### 3.2.3 ログファイル名
- 形式: `admin-access-YYYY-MM-DD.log`
- 例: `admin-access-2025-01-27.log`
- 日付が変わったら自動的に新しいファイルに切り替える

#### 3.2.4 環境別制御
- `APP_ENV=production`の場合はログを出力しない
- `APP_ENV=develop`または`APP_ENV=staging`の場合はログを出力する

### 3.3 日付別ログファイル分割機能

#### 3.3.1 自動分割
- 日付が変わったら（00:00:00になったら）自動的に新しいログファイルに切り替える
- ファイル名に日付（YYYY-MM-DD形式）を含める
- **既存のログローテーションライブラリを積極的に活用する**

#### 3.3.2 ファイル名形式
- APIサーバー: `api-access-YYYY-MM-DD.log`
- 管理画面サーバー: `admin-access-YYYY-MM-DD.log`

#### 3.3.3 実装方法
- **ログローテーションライブラリを使用**: `lumberjack` (gopkg.in/natefinch/lumberjack.v2) を推奨
  - 日付別ファイル分割機能が標準で提供されている
  - ファイル名に日付を含める設定が可能
  - 自動的なファイル切り替えをサポート
  - 自前実装よりも既存ライブラリを優先的に使用
- サーバーのローカルタイムゾーンを使用
- ライブラリが日付変更を自動検知して新しいファイルに切り替える

### 3.4 ログ出力先の設定機能

#### 3.4.1 デフォルト設定
- デフォルトのログ出力先: `logs`ディレクトリ（プロジェクトルート）
- ディレクトリが存在しない場合は自動作成

#### 3.4.2 設定による変更
- 設定ファイル（`config/{env}/config.yaml`）の`logging`セクションに`output_dir`項目を追加
- 設定ファイルでログ出力先を変更可能
- **絶対パスと相対パスの両方をサポート**:
  - 相対パス: プロジェクトルートからの相対パス（例: `logs`）
  - 絶対パス: システムの絶対パス（例: `/var/log/go-webdb-template`）

#### 3.4.3 設定例
```yaml
logging:
  level: debug
  format: json
  output: file
  output_dir: logs  # デフォルト値
  # output_dir: /var/log/go-webdb-template  # カスタムパス
```

### 3.5 ログフォーマット

#### 3.5.1 フォーマット形式
- **テキスト形式**（人間が読みやすい形式）を採用
- ログライブラリのテキストフォーマッターを使用して実装
- 将来的にJSON形式への拡張も検討可能な設計とする

#### 3.5.2 ログエントリの形式
テキスト形式で以下の情報を1行に記録する：
```
[YYYY-MM-DD HH:MM:SS] METHOD /path HTTP/1.1 STATUS_CODE RESPONSE_TIME_MS REMOTE_IP USER_AGENT
```

例:
```
[2025-01-27 14:30:45] GET /api/users HTTP/1.1 200 15.2ms 192.168.1.100 "Mozilla/5.0..."
[2025-01-27 14:30:46] POST /api/users HTTP/1.1 201 23.5ms 192.168.1.100 "Mozilla/5.0..."
```

#### 3.5.3 ログライブラリ
- **サードパーティのログライブラリを積極的に活用する**
- **推奨ライブラリ**: 
  - `logrus` (github.com/sirupsen/logrus): メインのログライブラリ
    - テキストフォーマッターが標準で提供されている
    - 使いやすく、設定が簡単
    - ファイル出力機能が標準でサポートされている
  - `lumberjack` (gopkg.in/natefinch/lumberjack.v2): ログローテーション・日付別ファイル分割
    - 日付別ファイル分割機能が標準で提供されている
    - ファイル名に日付を含める設定が可能
    - 自動的なファイル切り替えをサポート
    - `logrus`と組み合わせて使用
- **方針**: 自前実装よりも既存ライブラリの活用を優先する

## 4. 非機能要件

### 4.1 パフォーマンス
- ログ出力がHTTPリクエスト処理のボトルネックにならないよう、非同期書き込みまたはバッファリングを検討
- ログファイルへの書き込みエラーが発生しても、HTTPリクエスト処理には影響を与えない

### 4.2 ログローテーション
- 日付別に自動分割されるため、1日1ファイルの形式
- 古いログファイルの自動削除機能は本実装では含めない（将来の拡張として検討）

### 4.3 エラーハンドリング
- ログファイルの作成・書き込みエラーが発生した場合、標準エラー出力にエラーメッセージを出力
- ログファイルへの書き込みに失敗しても、HTTPリクエスト処理は継続する

### 4.4 ディレクトリ管理
- `logs`ディレクトリが存在しない場合は自動作成
- `logs/.gitkeep`ファイルを追加して、ディレクトリをGitリポジトリに含める
- `.gitignore`で`logs`ディレクトリ内のファイル・ディレクトリを除外（`logs/*`、`logs/**`）

### 4.5 既存機能への影響
- 既存のログ出力（標準`log`パッケージによる出力）は維持
- アクセスログは追加機能として実装し、既存のログ機能に影響を与えない

## 5. 制約事項

### 5.1 技術的制約
- **ログライブラリ**: サードパーティのログライブラリを積極的に活用する
  - メインライブラリ: `logrus` (github.com/sirupsen/logrus)
  - ログローテーション: `lumberjack` (gopkg.in/natefinch/lumberjack.v2)
- **実装方針**: 自前実装よりも既存ライブラリの活用を優先する
- 既存の`LoggingConfig`構造体を拡張して設定を追加
- 既存のサーバー起動処理（`server/cmd/server/main.go`、`server/cmd/admin/main.go`）への統合
- ログフォーマットはテキスト形式とする

### 5.2 プロジェクト制約
- 既存のアーキテクチャ（レイヤードアーキテクチャ）を維持
- 既存の設定読み込み機能（`internal/config`）を変更しない
- 既存のルーター実装（`internal/api/router`）への影響を最小化

### 5.3 ディレクトリ構造
- ログファイルは`logs`ディレクトリ（プロジェクトルート）に出力
- `logs/.gitkeep`を追加してディレクトリを保持
- `.gitignore`で`logs/*`と`logs/**`を除外（`logs`ディレクトリ自体は除外しない）

### 5.4 設定ファイル形式
- YAML形式の設定ファイルを使用
- 環境別設定（develop/staging/production）を維持

## 6. 受け入れ基準

### 6.1 機能要件
- [ ] APIサーバーへのすべてのHTTPリクエストがログファイルに記録される
- [ ] 管理画面サーバーへのHTTPリクエストがログファイルに記録される（production環境以外）
- [ ] production環境では管理画面サーバーのログが出力されない
- [ ] ログファイル名に日付（YYYY-MM-DD形式）が含まれる
- [ ] 日付が変わったら自動的に新しいログファイルに切り替わる
- [ ] ログファイルに必要な情報（メソッド、パス、ステータスコード、レスポンス時間等）が記録される
- [ ] 設定ファイルでログ出力先を変更できる
- [ ] デフォルトで`logs`ディレクトリにログが出力される
- [ ] `logs`ディレクトリが存在しない場合は自動作成される

### 6.2 非機能要件
- [ ] ログ出力がHTTPリクエスト処理のパフォーマンスに大きな影響を与えない
- [ ] ログファイルへの書き込みエラーが発生してもHTTPリクエスト処理は継続する
- [ ] ログファイルの作成・書き込みエラーは標準エラー出力に記録される
- [ ] 既存のログ出力機能（標準`log`パッケージ）が正常に動作する

### 6.3 ディレクトリ・ファイル管理
- [ ] `logs`ディレクトリが作成されている
- [ ] `logs/.gitkeep`ファイルが作成されている
- [ ] `.gitignore`に`logs/*`と`logs/**`が追加されている（`logs`ディレクトリ自体は除外されない）
- [ ] `logs`ディレクトリ内のログファイルがGitの管理対象外になっている

### 6.4 設定
- [ ] `config/{env}/config.yaml`の`logging`セクションに`output_dir`項目が追加されている
- [ ] 設定ファイルでログ出力先を変更できる
- [ ] デフォルト値（`logs`）が正しく動作する

### 6.5 ドキュメント
- [ ] README.mdまたは関連ドキュメントにログ出力機能の説明が追加されている（必要に応じて）

## 7. 影響範囲

### 7.1 新規追加が必要なディレクトリ・ファイル

#### ディレクトリ
- `logs/`: ログファイル出力先ディレクトリ

#### ファイル
- `logs/.gitkeep`: ディレクトリを保持するための空ファイル
- `server/internal/logging/`: ログ出力機能の実装（新規パッケージ）
  - `server/internal/logging/access_logger.go`: アクセスログ出力機能（logrus + lumberjackを使用）
  - `server/internal/logging/middleware.go`: HTTPミドルウェア

### 7.2 変更が必要なファイル

#### 設定ファイル
- `config/develop/config.yaml`: `logging.output_dir`項目を追加
- `config/staging/config.yaml`: `logging.output_dir`項目を追加
- `config/production/config.yaml`: `logging.output_dir`項目を追加（例示ファイル）

#### コードファイル
- `server/internal/config/config.go`: `LoggingConfig`構造体に`OutputDir`フィールドを追加
- `server/cmd/server/main.go`: アクセスログミドルウェアの追加
- `server/cmd/admin/main.go`: アクセスログミドルウェアの追加（production環境以外）
- `server/internal/api/router/router.go`: アクセスログミドルウェアの統合
- `server/go.mod`: 以下のライブラリの依存関係を追加
  - `logrus` (github.com/sirupsen/logrus)
  - `lumberjack` (gopkg.in/natefinch/lumberjack.v2)

#### 設定ファイル（Git管理）
- `.gitignore`: `logs/*`と`logs/**`を追加

### 7.3 削除されるファイル
なし

## 8. 実装上の注意事項

### 8.1 ログライブラリの選定
- **実装方針**: 既存ライブラリを積極的に活用し、自前実装は最小限にする
- **使用ライブラリ**:
  - **`logrus`** (github.com/sirupsen/logrus): メインのログライブラリ
    - テキストフォーマッター（`logrus.TextFormatter`）を使用
    - ファイル出力機能が標準でサポートされている
    - 使いやすく、設定が簡単
  - **`lumberjack`** (gopkg.in/natefinch/lumberjack.v2): ログローテーション・日付別ファイル分割
    - 日付別ファイル分割機能を提供
    - ファイル名に日付を含める設定が可能（例: `api-access-2006-01-02.log`）
    - 自動的なファイル切り替えをサポート
    - `logrus`の`SetOutput()`と組み合わせて使用
- **ライブラリの組み合わせ**: `logrus` + `lumberjack` で日付別ファイル分割を実現
- 自前で日付判定やファイル切り替えのロジックを実装する必要はない

### 8.2 アクセスログミドルウェアの実装
- HTTPミドルウェアとして実装し、ルーターに統合
- リクエスト処理前後でログを記録
- レスポンス時間の計測には`time`パッケージを使用

### 8.3 日付別ファイル分割の実装
- **`lumberjack`ライブラリを使用**: 日付別ファイル分割を自動的に処理
- ファイル名パターンに日付フォーマット（`2006-01-02`）を含める
- ライブラリが自動的に日付変更を検知して新しいファイルに切り替える
- ファイルハンドルの管理はライブラリが自動的に行う
- 自前で日付判定やファイル切り替えのロジックを実装する必要はない

### 8.4 エラーハンドリング
- ログファイルの作成・書き込みエラーは標準エラー出力に記録
- エラーが発生してもHTTPリクエスト処理は継続
- ファイルハンドルの適切なクローズ処理

### 8.5 パフォーマンス考慮
- ログファイルへの書き込みは同期的に行う（シンプルさを優先）
- 将来的に非同期書き込みやバッファリングを検討する場合は、設計時に拡張可能な構造にする

### 8.6 既存コードとの統合
- 既存の`LoggingConfig`構造体を拡張
- 既存のルーター実装への影響を最小化
- 既存のログ出力（標準`log`パッケージ）は維持

### 8.7 環境別制御
- `config.Load()`で取得した設定の`APP_ENV`を確認
- production環境では管理画面サーバーのログを出力しない
- 環境判定は設定ファイルまたは環境変数から取得

## 9. 参考情報

### 9.1 関連Issue
- GitHub Issue #10: ログ出力機能の組み込み

### 9.2 既存ドキュメント
- `server/cmd/server/main.go`: APIサーバー起動コマンドの実装例
- `server/cmd/admin/main.go`: 管理画面サーバー起動コマンドの実装例
- `server/internal/config/config.go`: 設定読み込み実装
- `server/internal/api/router/router.go`: ルーター実装

### 9.3 既存実装
- `server/internal/config/config.go`: `LoggingConfig`構造体の定義
- `config/develop/config.yaml`: 開発環境設定ファイル

### 9.4 ログライブラリ
- **`logrus`** (github.com/sirupsen/logrus): https://github.com/sirupsen/logrus
  - 構造化ログをサポート
  - テキストフォーマッターとJSONフォーマッターを提供
  - ファイル出力機能が標準でサポート
  - 使いやすく、設定が簡単

- **`lumberjack`** (gopkg.in/natefinch/lumberjack.v2): https://github.com/natefinch/lumberjack
  - ログローテーション機能を提供する軽量ライブラリ
  - 日付別ファイル分割機能が標準で提供
  - ファイル名に日付フォーマット（`2006-01-02`）を含める設定が可能
  - 自動的なファイル切り替えをサポート
  - `logrus`と組み合わせて使用

### 9.5 Go言語標準ライブラリ
- `os`パッケージ: https://pkg.go.dev/os
- `time`パッケージ: https://pkg.go.dev/time
- `net/http`パッケージ: https://pkg.go.dev/net/http


# Gofakeitによる開発用サンプルデータ生成機能要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Issue番号**: #29
- **Issueタイトル**: Gofakeitによる開発用サンプルデータの生成機能
- **Feature名**: 0025-fakedata
- **作成日**: 2025-12-29

### 1.2 目的
開発用のサンプルデータを大量に生成する機能を提供し、開発環境でのテストやデバッグ作業を効率化する。
Gofakeitライブラリを使用して、リアルなランダムデータを生成する。

### 1.3 スコープ
- 対象テーブル: `user`, `posts`, `news`
- 各テーブルに100件程度のデータを生成
- コマンドライン実行方式による実装
- develop環境での使用を想定
- 現在のテーブルスキーマに基づいた実装（スキーマ変更は考慮しない）

**本実装の範囲外**:
- スキーマ変更への対応（現在のスキーマのみ対応）
- 本番環境やstaging環境での使用（develop環境のみ）
- 既存データの削除やリセット機能
- データ生成量の動的な変更（固定で100件程度）

## 2. 背景・現状分析

### 2.1 現在の実装
- **CLI実装パターン**: `server/cmd/list-users/`に既存のCLI実装が存在
- **設定読み込み**: `internal/config/config.go`の`Load()`関数で環境変数`APP_ENV`に基づいて設定を読み込み
- **DB接続**: `internal/db/manager.go`の`NewGroupManager()`でデータベース接続を初期化
- **データベース構成**:
  - **masterグループ**: `news`テーブル（シャーディングなし、単一テーブル）
  - **shardingグループ**: `users`, `posts`テーブル（32分割: users_000～users_031, posts_000～posts_031）
    - 4つのデータベースファイル（sharding_db_1.db ～ sharding_db_4.db）
    - 各データベースに8テーブルずつ分散（_000-007, _008-015, _016-023, _024-031）

### 2.2 課題点
1. **開発用データの不足**: 開発環境でテストやデバッグを行う際に、十分な量のサンプルデータが存在しない
2. **手動データ投入の非効率**: 手動でデータを投入する作業が非効率的で時間がかかる
3. **リアルなデータの不足**: 単純なテストデータでは、実際の運用に近い状況を再現できない

### 2.3 本実装による改善点
1. **開発効率の向上**: コマンド一つで大量のサンプルデータを生成できるようになる
2. **リアルなデータ生成**: Gofakeitを使用することで、よりリアルなランダムデータを生成できる
3. **テスト環境の充実**: 十分な量のデータがあることで、より実践的なテストが可能になる

## 3. 機能要件

### 3.1 コマンド実装

#### 3.1.1 コマンド構造
既存のCLI実装パターン（`server/cmd/list-users/`）に従い、以下の構造で実装する：

```
server/
├── cmd/
│   └── generate-sample-data/
│       └── main.go          # サンプルデータ生成CLIツール（新規）
└── bin/                     # 実行ファイル生成先（既存）
    └── generate-sample-data  # ビルド後の実行ファイル
```

#### 3.1.2 コマンド実行方法
```bash
APP_ENV=develop ./bin/generate-sample-data
```

- 環境変数`APP_ENV`で環境を指定（develop環境で使用）
- コマンドライン引数は不要（固定で100件程度を生成）

#### 3.1.3 実行フロー
```
1. 設定ファイルの読み込み（config.Load()）
2. GroupManagerの初期化（db.NewGroupManager()）
3. データベース接続確認（PingAll()）
4. usersテーブルへのデータ生成（32分割テーブルに分散）
5. postsテーブルへのデータ生成（32分割テーブルに分散、user_idは既存usersから参照）
6. newsテーブルへのデータ生成（master DB）
7. 生成完了メッセージの表示
```

### 3.2 データ生成ロジック

#### 3.2.1 usersテーブル
- **対象**: 32分割テーブル（users_000～users_031）
- **生成件数**: 合計100件程度（各テーブルに均等に分散）
- **生成方法**:
  - テーブル番号を0～31でループ
  - 各テーブルに約3～4件ずつ生成（100件 ÷ 32テーブル）
  - Gofakeitを使用して以下のフィールドを生成:
    - `name`: `gofakeit.Name()`
    - `email`: `gofakeit.Email()`
    - `created_at`, `updated_at`: 現在時刻
- **ID生成**: データベースのAUTOINCREMENT機能を使用（明示的なID指定は不要）

#### 3.2.2 postsテーブル
- **対象**: 32分割テーブル（posts_000～posts_031）
- **生成件数**: 合計100件程度（各テーブルに均等に分散）
- **生成方法**:
  - テーブル番号を0～31でループ
  - 各テーブルに約3～4件ずつ生成（100件 ÷ 32テーブル）
  - 既存のusersテーブルからuser_idを取得して参照
  - Gofakeitを使用して以下のフィールドを生成:
    - `user_id`: 既存のusersテーブルからランダムに選択
    - `title`: `gofakeit.Sentence(5)`（5単語程度の文）
    - `content`: `gofakeit.Paragraph(3, 5, 10, "\n")`（3～5文、各文10単語程度）
    - `created_at`, `updated_at`: 現在時刻
- **ID生成**: データベースのAUTOINCREMENT機能を使用（明示的なID指定は不要）
- **注意**: user_idは既存のusersテーブルから取得するため、usersテーブルの生成後に実行する

#### 3.2.3 newsテーブル
- **対象**: master DBのnewsテーブル（シャーディングなし）
- **生成件数**: 100件程度
- **生成方法**:
  - master DBのnewsテーブルに直接100件を生成
  - Gofakeitを使用して以下のフィールドを生成:
    - `title`: `gofakeit.Sentence(5)`（5単語程度の文）
    - `content`: `gofakeit.Paragraph(3, 5, 10, "\n")`（3～5文、各文10単語程度）
    - `author_id`: `gofakeit.Int64()`（ランダムな整数、NULL許容）
    - `published_at`: `gofakeit.Date()`（ランダムな日時、NULL許容）
    - `created_at`, `updated_at`: 現在時刻
- **ID生成**: データベースのAUTOINCREMENT機能を使用（明示的なID指定は不要）

### 3.3 バッチ処理

#### 3.3.1 バッチサイズ
大量データ生成時のパフォーマンスを考慮し、バッチ挿入を実装する：
- **バッチサイズ**: 500件ずつ（参考コードに基づく）
- 各テーブルへの挿入時にバッチ処理を使用

#### 3.3.2 トランザクション管理
- 各テーブルへの挿入は独立したトランザクションで実行
- エラー発生時は適切にロールバック

### 3.4 エラーハンドリング

#### 3.4.1 エラー処理
- データベース接続エラー: 適切なエラーメッセージを表示して終了
- データ生成エラー: エラーが発生したテーブルを特定して表示
- 終了コード: エラー時は非ゼロの終了コードを返す

#### 3.4.2 ログ出力
- 進捗状況の表示（どのテーブルに何件生成したか）
- エラー発生時の詳細なエラーメッセージ

## 4. 非機能要件

### 4.1 パフォーマンス
- バッチ挿入による効率的なデータ生成
- 100件程度のデータ生成は数秒以内に完了すること

### 4.2 エラーハンドリング
- 適切なエラーメッセージと終了コード
- 部分的な失敗時も適切にエラーを報告

### 4.3 ログ出力
- 進捗状況の表示（どのテーブルに何件生成したか）
- 生成完了時のサマリー表示

### 4.4 依存関係
- `github.com/brianvoe/gofakeit/v6`ライブラリの追加が必要

## 5. 制約事項

### 5.1 技術的制約
- 現在のテーブルスキーマのみ対応（将来のスキーマ変更は考慮しない）
- 既存のデータベース接続管理機能（`internal/db/manager.go`）を再利用
- 既存の設定読み込み機能（`internal/config/config.go`）を再利用

### 5.2 プロジェクト制約
- develop環境での使用を想定（本番環境やstaging環境では使用しない）
- 既存のCLI実装パターン（`server/cmd/list-users/`）に従う
- 既存のレイヤードアーキテクチャを維持すること

### 5.3 データ生成制約
- 各テーブルに100件程度のデータを生成（固定値）
- 既存データの削除やリセット機能は実装しない
- データ生成量の動的な変更は実装しない

### 5.4 シャーディング対応
- users, postsテーブルは32分割テーブルに適切に分散すること
- テーブル選択ロジック（`id % 32`）に従ってデータを生成すること
- postsテーブルのuser_idは既存のusersテーブルから参照すること

## 6. 受け入れ基準

### 6.1 コマンド実装
- [ ] `server/cmd/generate-sample-data/main.go`が作成されている
- [ ] コマンドが正常に実行できる
- [ ] 環境変数`APP_ENV`で環境を指定できる
- [ ] 適切なエラーハンドリングが実装されている

### 6.2 データ生成
- [ ] usersテーブルに100件程度のデータが生成される
- [ ] postsテーブルに100件程度のデータが生成される
- [ ] newsテーブルに100件程度のデータが生成される
- [ ] シャーディングテーブル（users, posts）が適切に分散される
- [ ] postsテーブルのuser_idが既存のusersテーブルから参照されている

### 6.3 バッチ処理
- [ ] バッチ挿入が実装されている
- [ ] パフォーマンスが適切である（100件程度のデータ生成が数秒以内に完了）

### 6.4 エラーハンドリング
- [ ] 適切なエラーメッセージが表示される
- [ ] エラー時は非ゼロの終了コードを返す
- [ ] 進捗状況が適切に表示される

### 6.5 ドキュメント
- [ ] `docs/Generate-Sample-Data.md`が作成されている
- [ ] コマンドの使用方法が記載されている
- [ ] 生成されるデータの説明が記載されている

### 6.6 依存関係
- [ ] `go.mod`に`github.com/brianvoe/gofakeit/v6`が追加されている

## 7. 影響範囲

### 7.1 新規追加が必要なファイル

#### コマンド実装
- `server/cmd/generate-sample-data/main.go`: サンプルデータ生成CLIツール本体

#### ドキュメント
- `docs/Generate-Sample-Data.md`: サンプルデータ生成機能のドキュメント

### 7.2 変更が必要なファイル

#### 依存関係
- `go.mod`: `github.com/brianvoe/gofakeit/v6`の追加

### 7.3 削除されるファイル
なし（既存ファイルは変更なし）

### 7.4 再利用する既存機能
- `internal/config/config.go`: 設定読み込み機能
- `internal/db/manager.go`: データベース接続管理機能
- `internal/model/user.go`: Userモデル
- `internal/model/post.go`: Postモデル
- `internal/model/news.go`: Newsモデル

## 8. 実装上の注意事項

### 8.1 シャーディングテーブルへの分散
- users, postsテーブルは32分割テーブル（users_000～users_031, posts_000～posts_031）に分散する
- テーブル選択ロジック（`id % 32`）に従ってデータを生成する
- 各テーブルに均等に分散することを考慮する（100件 ÷ 32テーブル ≈ 3～4件/テーブル）

### 8.2 postsテーブルのuser_id参照
- postsテーブルのuser_idは既存のusersテーブルから取得する
- usersテーブルの生成後にpostsテーブルを生成する
- 既存のusersテーブルからランダムにuser_idを選択する

### 8.3 バッチ挿入の実装
- バッチサイズは500件ずつ（参考コードに基づく）
- 各テーブルへの挿入時にバッチ処理を使用する
- パフォーマンスを考慮した実装とする

### 8.4 トランザクション管理
- 各テーブルへの挿入は独立したトランザクションで実行する
- エラー発生時は適切にロールバックする

### 8.5 Gofakeitの使用方法
- 各フィールドに適切なGofakeit関数を使用する
- リアルなデータを生成するため、適切な関数を選択する

### 8.6 エラーハンドリング
- データベース接続エラー、データ生成エラーなど、適切なエラーハンドリングを実装する
- エラー発生時は詳細なエラーメッセージを表示する

## 9. 参考情報

### 9.1 関連Issue
- GitHub Issue #29: Gofakeitによる開発用サンプルデータの生成機能

### 9.2 既存ドキュメント
- `docs/Command-Line-Tool.md`: 既存のCLIツールドキュメント
- `docs/Sharding.md`: シャーディング戦略の詳細

### 9.3 既存実装
- `server/cmd/list-users/main.go`: 既存のCLI実装パターン
- `server/internal/config/config.go`: 設定読み込み機能
- `server/internal/db/manager.go`: データベース接続管理機能
- `server/internal/model/user.go`: Userモデル
- `server/internal/model/post.go`: Postモデル
- `server/internal/model/news.go`: Newsモデル

### 9.4 技術スタック
- **Go**: 1.21+
- **GORM**: v1.25.12
- **データベース**: SQLite3（開発環境）
- **Gofakeit**: v6（新規追加）

### 9.5 参考コード
Issue #29に記載されている参考コードを基に実装する：
- バッチサイズ: 500件ずつ
- バッチ挿入の実装パターン
- Gofakeitを使用したデータ生成パターン

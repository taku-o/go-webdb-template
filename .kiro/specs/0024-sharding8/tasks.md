# シャーディング数8対応実装タスク一覧

## 概要
シャーディング数8対応の実装を段階的に進めるためのタスク一覧。要件定義書と設計書に基づき、実装可能な粒度でタスクを分解。

## 実装フェーズ

### Phase 1: 設定ファイルの更新

#### - [ ] タスク 1.1: 開発環境設定ファイルの更新
**目的**: 開発環境の設定ファイルに8つのシャーディングエントリを追加

**作業内容**:
- `config/develop/database.yaml`を更新
- `sharding.databases`セクションを8つのエントリに拡張
- 各エントリの設定:
  - id: 1-8
  - dsn: 適切なデータベースファイル（sharding_db_1.db ～ sharding_db_4.db）
  - table_range: [0,3], [4,7], [8,11], [12,15], [16,19], [20,23], [24,27], [28,31]
  - その他の設定項目（driver, writer_dsn, reader_dsns, reader_policy, max_connections等）は既存の設定を維持

**受け入れ基準**:
- `config/develop/database.yaml`に8つのシャーディングエントリが定義されている
- 各エントリの`table_range`が正しく設定されている（[0,3], [4,7], ..., [28,31]）
- 各エントリが適切なデータベースファイルに接続するように設定されている
  - id 1,2 → sharding_db_1.db
  - id 3,4 → sharding_db_2.db
  - id 5,6 → sharding_db_3.db
  - id 7,8 → sharding_db_4.db
- 既存の設定項目（max_connections, max_idle_connections等）が維持されている

---

#### - [ ] タスク 1.2: テスト用設定ファイルの更新
**目的**: テスト用設定ファイルに8つのシャーディングエントリを追加

**作業内容**:
- `server/internal/config/testdata/develop/database.yaml`を更新
- 開発環境設定ファイルと同様に8つのエントリに拡張
- 各エントリの設定は開発環境設定ファイルと同じ構造

**受け入れ基準**:
- `server/internal/config/testdata/develop/database.yaml`に8つのシャーディングエントリが定義されている
- 各エントリの`table_range`が正しく設定されている
- 各エントリが適切なデータベースファイルに接続するように設定されている

---

#### - [ ] タスク 1.3: その他の環境設定ファイルの確認と更新（オプション）
**目的**: ステージング・本番環境の設定ファイルが存在する場合に更新

**作業内容**:
- `config/staging/database.yaml`が存在する場合、8つのエントリに拡張
- `config/production/database.yaml.example`が存在する場合、8つのエントリに拡張
- 各環境の設定ファイルの構造を確認し、開発環境と同様に更新

**受け入れ基準**:
- 存在する環境設定ファイルが8つのエントリに拡張されている
- 各エントリの設定が正しい

---

### Phase 2: ShardingManagerのデータ構造変更

#### - [ ] タスク 2.1: ShardingManager構造体の更新
**目的**: 接続共有とO(1)最適化のためのフィールドを追加

**作業内容**:
- `server/internal/db/group_manager.go`の`ShardingManager`構造体を更新
- 追加するフィールド:
  - `connectionPool map[string]*GORMConnection`: DSNをキーとした接続プール（共有用）
  - `tableNumberToDBID map[int]int`: テーブル番号からエントリIDへのマッピング（O(1)最適化用）

**受け入れ基準**:
- `ShardingManager`構造体に`connectionPool`フィールドが追加されている
- `ShardingManager`構造体に`tableNumberToDBID`フィールドが追加されている
- 既存のフィールド（`connections`, `tableRange`, `mu`）が維持されている

---

### Phase 3: 接続共有機能の実装

#### - [ ] タスク 3.1: getOrCreateConnectionメソッドの実装
**目的**: 同じDSNを持つ複数のエントリが接続を共有できるようにする

**作業内容**:
- `server/internal/db/group_manager.go`に`getOrCreateConnection`メソッドを実装
- メソッドの動作:
  1. 既存の接続プール（`connectionPool`）を確認
  2. 同じDSNの接続が存在する場合は、既存の接続を返す
  3. 存在しない場合は、新しい接続を作成してプールに追加
- スレッドセーフな実装（`mu`ロックを使用）

**受け入れ基準**:
- `getOrCreateConnection`メソッドが実装されている
- 同じDSNを持つ複数のエントリが同じ接続オブジェクトを共有する
- 異なるDSNを持つエントリが異なる接続を使用する
- スレッドセーフな実装になっている

---

### Phase 4: 接続選択ロジックの変更

#### - [ ] タスク 4.1: buildTableNumberMapメソッドの実装
**目的**: テーブル番号からエントリIDへのマッピングテーブルを構築（O(1)最適化用）

**作業内容**:
- `server/internal/db/group_manager.go`に`buildTableNumberMap`メソッドを実装
- メソッドの動作:
  1. `tableRange`マップを走査
  2. 各エントリの`table_range`に含まれるすべてのテーブル番号に対して、エントリIDをマッピング
  3. `tableNumberToDBID`マップに保存
- 例: `table_range: [0, 3]`の場合、テーブル番号0,1,2,3すべてにエントリIDをマッピング

**受け入れ基準**:
- `buildTableNumberMap`メソッドが実装されている
- すべてのテーブル番号（0-31）がマッピングされる
- 重複するマッピングがないこと
- マッピングが正しいこと（各テーブル番号が適切なエントリIDにマッピングされる）

---

#### - [ ] タスク 4.2: NewShardingManagerメソッドの変更
**目的**: 接続共有とマッピングテーブル構築を初期化時に実行

**作業内容**:
- `server/internal/db/group_manager.go`の`NewShardingManager`メソッドを変更
- 変更内容:
  1. `connectionPool`と`tableNumberToDBID`の初期化を追加
  2. 各エントリの接続作成時に`getOrCreateConnection`を使用（接続共有）
  3. すべての接続作成後、`buildTableNumberMap()`を呼び出してマッピングテーブルを構築

**受け入れ基準**:
- `NewShardingManager`メソッドが接続共有を実装している
- 初期化時に`buildTableNumberMap()`が呼び出される
- 同じDSNを持つ複数のエントリが同じ接続を共有する
- エラー発生時に既存の接続が適切にクローズされる

---

#### - [ ] タスク 4.3: GetConnectionByTableNumberメソッドの変更
**目的**: table_rangeベースの接続選択をO(1)で実行

**作業内容**:
- `server/internal/db/group_manager.go`の`GetConnectionByTableNumber`メソッドを変更
- 変更内容:
  1. テーブル番号の範囲チェック（0-31）
  2. `tableNumberToDBID`マップからO(1)でエントリIDを取得
  3. `connections`マップから接続を取得
  4. エラーハンドリング（テーブル番号が範囲外、接続が見つからない場合）

**受け入れ基準**:
- `GetConnectionByTableNumber`メソッドがO(1)で接続を選択する
- テーブル番号0-31が正しい接続を返す
- 範囲外のテーブル番号で適切なエラーが返る
- 既存のAPIインターフェースが維持されている

---

### Phase 5: 接続管理メソッドの変更

#### - [ ] タスク 5.1: CloseAllメソッドの変更
**目的**: 接続プールを考慮した接続クローズ処理を実装

**作業内容**:
- `server/internal/db/group_manager.go`の`CloseAll`メソッドを変更
- 変更内容:
  1. `connectionPool`の接続をクローズ（重複を避けるため）
  2. すべてのマップをクリア（`connections`, `tableRange`, `connectionPool`, `tableNumberToDBID`）
  3. エラーハンドリング（複数の接続クローズエラーを処理）

**受け入れ基準**:
- `CloseAll`メソッドが接続プールの接続を適切にクローズする
- 重複する接続のクローズが回避される
- すべてのマップがクリアされる
- エラーが適切に処理される

---

#### - [ ] タスク 5.2: GetAllConnectionsメソッドの変更
**目的**: ユニークな接続のみを返すように変更

**作業内容**:
- `server/internal/db/group_manager.go`の`GetAllConnections`メソッドを変更
- 変更内容:
  1. `connectionPool`からユニークな接続のみを取得
  2. 重複を避けるため、`seen`マップを使用
  3. ユニークな接続のリストを返す

**受け入れ基準**:
- `GetAllConnections`メソッドがユニークな接続のみを返す
- 重複する接続が返されない
- 4つの接続が返される（実際のデータベース数）

---

### Phase 6: テストの実装・更新

#### - [ ] タスク 6.1: buildTableNumberMapの単体テスト
**目的**: マッピングテーブル構築のロジックを検証

**作業内容**:
- `server/internal/db/group_manager_test.go`に`buildTableNumberMap`のテストを追加
- テストケース:
  1. マッピングテーブルが正しく構築されること
  2. すべてのテーブル番号（0-31）がマッピングされること
  3. 重複するマッピングがないこと
  4. 各テーブル番号が適切なエントリIDにマッピングされること

**受け入れ基準**:
- `buildTableNumberMap`のテストが実装されている
- すべてのテストケースがパスする

---

#### - [ ] タスク 6.2: 接続共有の単体テスト
**目的**: 接続共有のロジックを検証

**作業内容**:
- `server/internal/db/group_manager_test.go`に接続共有のテストを追加
- テストケース:
  1. 同じDSNを持つ複数のエントリが同じ接続を共有すること
  2. 異なるDSNを持つエントリが異なる接続を使用すること
  3. `GetAllConnections`がユニークな接続のみを返すこと

**受け入れ基準**:
- 接続共有のテストが実装されている
- すべてのテストケースがパスする

---

#### - [ ] タスク 6.3: GetConnectionByTableNumberの単体テスト更新
**目的**: O(1)最適化後の接続選択ロジックを検証

**作業内容**:
- `server/internal/db/group_manager_test.go`の`GetConnectionByTableNumber`テストを更新
- テストケース:
  1. テーブル番号0-31が正しい接続を返すこと
  2. 範囲外のテーブル番号でエラーが返ること
  3. 各テーブル番号が正しいエントリにマッピングされること
  4. O(1)で接続選択が実行されること（パフォーマンステスト）

**受け入れ基準**:
- `GetConnectionByTableNumber`のテストが更新されている
- すべてのテストケースがパスする
- 既存のテストが可能な限り動作する

---

#### - [ ] タスク 6.4: 統合テストの更新
**目的**: 実際のデータベース操作を検証

**作業内容**:
- `server/test/integration/sharding_test.go`を更新（存在する場合）
- テストケース:
  1. 各テーブル番号に対してCRUD操作が正常に動作すること
  2. クロステーブルクエリが正常に動作すること
  3. 接続共有が正常に動作すること

**受け入れ基準**:
- 統合テストが更新されている
- すべてのテストケースがパスする
- 既存のテストが可能な限り動作する

---

### Phase 7: ドキュメントの更新

#### - [ ] タスク 7.1: Sharding.mdの更新
**目的**: シャーディング数の変更と接続共有の仕組みを文書化

**作業内容**:
- `docs/Sharding.md`を更新
- 更新内容:
  1. シャーディング数の変更（4→8）を反映
  2. 接続共有の仕組みを説明
  3. 設定ファイルの構造を更新（8つのエントリの例）
  4. 接続選択ロジックの変更（O(1)最適化）を説明

**受け入れ基準**:
- `docs/Sharding.md`が更新されている
- 新しいシャーディング構成が文書化されている
- 接続共有の仕組みが説明されている
- 設定ファイルの変更内容が文書化されている

---

#### - [ ] タスク 7.2: コードコメントの更新
**目的**: 接続共有とO(1)最適化の仕組みをコメントで説明

**作業内容**:
- `server/internal/db/group_manager.go`のコードコメントを更新
- 更新内容:
  1. `ShardingManager`構造体の各フィールドの説明
  2. `getOrCreateConnection`メソッドの説明
  3. `buildTableNumberMap`メソッドの説明
  4. `GetConnectionByTableNumber`メソッドの説明（O(1)最適化）

**受け入れ基準**:
- コードコメントが更新されている
- 接続共有の仕組みが説明されている
- O(1)最適化の仕組みが説明されている

---

### Phase 8: 動作確認

#### - [ ] タスク 8.1: 既存機能の動作確認
**目的**: 既存のAPIエンドポイントとCRUD操作が正常に動作することを確認

**作業内容**:
- 既存のAPIエンドポイントをテスト
- CRUD操作をテスト
- クロステーブルクエリをテスト
- エラーが発生しないことを確認

**受け入れ基準**:
- 既存のCRUD操作が正常に動作する
- クロステーブルクエリが正常に動作する
- 既存のAPIエンドポイントが正常に動作する
- エラーが発生しない

---

#### - [ ] タスク 8.2: パフォーマンス確認
**目的**: O(1)最適化が正しく動作することを確認

**作業内容**:
- 接続選択のパフォーマンスを測定
- マッピングテーブルの構築時間を測定
- シャーディング数が増えても接続選択のパフォーマンスが一定であることを確認

**受け入れ基準**:
- 接続選択がO(1)で実行されること
- マッピングテーブルの構築がO(32)で実行されること
- シャーディング数が増えても接続選択のパフォーマンスが一定であること

---

## 実装順序の推奨

1. **Phase 1**: 設定ファイルの更新（開発環境、テスト用）
2. **Phase 2**: ShardingManagerのデータ構造変更
3. **Phase 3**: 接続共有機能の実装
4. **Phase 4**: 接続選択ロジックの変更（O(1)最適化）
5. **Phase 5**: 接続管理メソッドの変更
6. **Phase 6**: テストの実装・更新
7. **Phase 7**: ドキュメントの更新
8. **Phase 8**: 動作確認

## 注意事項

- 各フェーズは順次実装することを推奨
- テストは各フェーズの実装後に実行し、問題がないことを確認
- 既存のテストが失敗する場合は、テストコードの更新も許容
- エラーが発生した場合は、即座にユーザーに報告

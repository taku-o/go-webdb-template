# Auth0ログイン機能実装タスク一覧

## 概要
Auth0ログイン機能の実装を段階的に進めるためのタスク一覧。要件定義書と設計書に基づき、実装可能な粒度でタスクを分解。

## 実装フェーズ

### Phase 1: パッケージのインストールと環境変数の設定

#### - [ ] タスク 1.1: Auth0 SDKパッケージのインストール
**目的**: Next.js App Routerに対応したAuth0 SDKをインストール

**作業内容**:
- `client/package.json`に`@auth0/nextjs-auth0`パッケージを追加
- `npm install`を実行してパッケージをインストール
- パッケージのバージョンを確認（Next.js 14 App Router対応版を使用）

**受け入れ基準**:
- `client/package.json`に`@auth0/nextjs-auth0`が追加されている
- `npm install`が正常に完了している
- `client/node_modules/@auth0/nextjs-auth0`が存在する

---

#### - [ ] タスク 1.2: 環境変数ファイルの確認と設定
**目的**: 環境変数ファイルのひな形が正しく作成されていることを確認

**作業内容**:
- `client/.env.local`が存在することを確認
- `client/.env.development`が存在し、Auth0設定が追加されていることを確認
- `client/.env.staging`が存在することを確認
- `client/.env.production`が存在することを確認
- 各ファイルに必要な環境変数のプレースホルダーが記載されていることを確認

**受け入れ基準**:
- すべての環境変数ファイルが存在する
- 各ファイルにAuth0設定のプレースホルダーが記載されている
- Client Secretはプレースホルダーのみで、実際の値は記載されていない

---

### Phase 2: Auth0 SDKの設定

#### - [ ] タスク 2.1: API Routesハンドラーの作成
**目的**: Auth0 SDKのAPI Routesハンドラーを作成

**作業内容**:
- `client/src/app/api/auth/[...auth0]/route.ts`を作成
- `handleAuth()`関数をインポート
- `GET`ハンドラーとして`handleAuth()`をエクスポート

**受け入れ基準**:
- `client/src/app/api/auth/[...auth0]/route.ts`が存在する
- `handleAuth()`が正しくインポートされている
- `GET`ハンドラーが正しくエクスポートされている

---

#### - [ ] タスク 2.2: UserProviderの設定
**目的**: アプリケーション全体で認証状態を共有できるようにUserProviderを設定

**作業内容**:
- `client/src/app/layout.tsx`を修正
- `UserProvider`をインポート
- `UserProvider`でアプリケーション全体をラップ

**受け入れ基準**:
- `client/src/app/layout.tsx`に`UserProvider`が追加されている
- `UserProvider`でアプリケーション全体がラップされている
- 既存の機能に影響がない

---

### Phase 3: ログイン機能の実装

#### - [ ] タスク 3.1: ログインボタンの実装
**目的**: トップページにログインボタンを追加

**作業内容**:
- `client/src/app/page.tsx`を修正
- `'use client'`ディレクティブを追加
- `useUser()`フックをインポート
- 未ログイン時にログインボタンを表示
- ログインボタンクリック時に`/api/auth/login`にリダイレクト

**受け入れ基準**:
- 未ログイン時にログインボタンが表示される
- ログインボタンをクリックすると`/api/auth/login`にリダイレクトされる
- 既存のコンテンツに影響がない

---

#### - [ ] タスク 3.2: ログイン処理の動作確認
**目的**: Auth0へのリダイレクトとコールバック処理が正常に動作することを確認

**作業内容**:
- ログインボタンをクリック
- Auth0のログインページにリダイレクトされることを確認
- PARTNERアプリのアカウントでログイン
- コールバック処理が正常に動作することを確認
- JWTがHTTP-only Cookieに保存されることを確認

**受け入れ基準**:
- ログインボタンをクリックするとAuth0のログインページにリダイレクトされる
- ログイン成功後、コールバック処理が正常に動作する
- JWTがHTTP-only Cookieに保存される（ブラウザの開発者ツールで確認）

---

### Phase 4: ログイン状態の表示

#### - [ ] タスク 4.1: ログイン状態の確認機能の実装
**目的**: `useUser()`フックを使用してログイン状態を確認し、UIを切り替え

**作業内容**:
- `client/src/app/page.tsx`を修正
- `useUser()`フックから`user`、`error`、`isLoading`を取得
- ローディング状態の表示を実装
- エラー状態の表示を実装
- ログイン済み/未ログイン状態の表示を実装

**受け入れ基準**:
- ローディング状態が適切に表示される
- エラー状態が適切に表示される
- ログイン済み時にログイン済み状態が表示される
- 未ログイン時に未ログイン状態が表示される

---

#### - [ ] タスク 4.2: ユーザー情報の表示（オプション）
**目的**: ログイン済みユーザーの情報を表示

**作業内容**:
- `client/src/app/page.tsx`を修正
- ログイン済み時にユーザー情報（名前、メールアドレス等）を表示
- ユーザー情報の表示スタイルを調整

**受け入れ基準**:
- ログイン済み時にユーザー情報が表示される
- ユーザー情報の表示が適切にスタイリングされている

---

### Phase 5: ログアウト機能の実装

#### - [ ] タスク 5.1: ログアウトボタンの実装
**目的**: ログイン済み時にログアウトボタンを表示

**作業内容**:
- `client/src/app/page.tsx`を修正
- ログイン済み時にログアウトボタンを表示
- ログアウトボタンクリック時に`/api/auth/logout`にリダイレクト
- または`useUser()`フックの`logout()`関数を使用

**受け入れ基準**:
- ログイン済み時にログアウトボタンが表示される
- ログアウトボタンをクリックするとログアウト処理が実行される

---

#### - [ ] タスク 5.2: ログアウト処理の動作確認
**目的**: ログアウト処理が正常に動作することを確認

**作業内容**:
- ログアウトボタンをクリック
- HTTP-only CookieからJWTが削除されることを確認
- 未ログイン状態に戻ることを確認
- ログインボタンが表示されることを確認

**受け入れ基準**:
- ログアウトボタンをクリックするとログアウト処理が実行される
- HTTP-only CookieからJWTが削除される（ブラウザの開発者ツールで確認）
- ログアウト後、未ログイン状態に戻る
- ログインボタンが表示される

---

### Phase 6: JWT取得機能の実装

#### - [ ] タスク 6.1: Server ComponentsでのJWT取得機能の実装
**目的**: Server Componentsで`getAccessToken()`を使用してJWTを取得できるようにする

**作業内容**:
- テスト用のServer Componentを作成（オプション）
- `getAccessToken()`をインポート
- `getAccessToken()`を使用してJWTを取得
- 取得したJWTをログ出力（デバッグ用）

**受け入れ基準**:
- Server Componentsで`getAccessToken()`を使用してJWTを取得できる
- 取得したJWTが正しく返される

---

#### - [ ] タスク 6.2: Client ComponentsでのJWT取得機能の実装
**目的**: Client Componentsで`useUser()`と`getAccessToken()`を使用してJWTを取得できるようにする

**作業内容**:
- テスト用のClient Componentを作成（オプション）
- `useUser()`フックをインポート
- `getAccessToken()`を使用してJWTを取得
- 取得したJWTをログ出力（デバッグ用）

**受け入れ基準**:
- Client Componentsで`useUser()`と`getAccessToken()`を使用してJWTを取得できる
- 取得したJWTが正しく返される

**注意**: 本実装では、JWT取得機能を実装するが、API呼び出しでの使用は次のissueで対応する。

---

### Phase 7: エラーハンドリングの実装

#### - [ ] タスク 7.1: 認証エラーの処理
**目的**: 認証エラーが発生した場合、適切なエラーメッセージを表示

**作業内容**:
- `client/src/app/page.tsx`を修正
- `useUser()`フックから`error`を取得
- エラー状態の表示を実装
- エラーメッセージと再ログインリンクを表示

**受け入れ基準**:
- 認証エラーが発生した場合、適切なエラーメッセージが表示される
- 再ログインリンクが表示される

---

#### - [ ] タスク 7.2: ネットワークエラーの処理
**目的**: Auth0への接続に失敗した場合、適切なエラーハンドリングを行う

**作業内容**:
- ネットワークエラーが発生した場合の処理を実装
- エラーメッセージを表示
- リトライ機能を実装（オプション）

**受け入れ基準**:
- ネットワークエラーが発生した場合、適切なエラーメッセージが表示される

---

#### - [ ] タスク 7.3: JWT取得エラーの処理
**目的**: JWT取得に失敗した場合、適切なエラーハンドリングを行う

**作業内容**:
- `getAccessToken()`の呼び出しをtry-catchで囲む
- エラーが発生した場合、適切なエラーメッセージをログ出力
- エラー状態を適切に処理

**受け入れ基準**:
- JWT取得に失敗した場合、適切なエラーハンドリングが行われる
- エラーメッセージが適切にログ出力される

---

### Phase 8: 環境別設定の確認

#### - [ ] タスク 8.1: 開発環境での動作確認
**目的**: 開発環境（`npm run dev`）でAuth0ログイン機能が正常に動作することを確認

**作業内容**:
- `client/.env.development`の環境変数を設定
- `npm run dev`でアプリケーションを起動
- ログイン機能が正常に動作することを確認
- ログアウト機能が正常に動作することを確認
- JWT取得機能が正常に動作することを確認

**受け入れ基準**:
- 開発環境でログイン機能が正常に動作する
- 開発環境でログアウト機能が正常に動作する
- 開発環境でJWT取得機能が正常に動作する

---

#### - [ ] タスク 8.2: 環境変数の確認
**目的**: 各環境で適切な環境変数が設定されていることを確認

**作業内容**:
- `client/.env.local`の環境変数を確認
- `client/.env.development`の環境変数を確認
- `client/.env.staging`の環境変数を確認（設定可能な場合）
- `client/.env.production`の環境変数を確認（設定可能な場合）
- Client Secretが環境変数として設定されていることを確認

**受け入れ基準**:
- すべての環境変数ファイルに必要な設定が記載されている
- Client Secretが環境変数として設定されている（ファイルに直接記載されていない）

---

### Phase 9: テストの実装

#### - [ ] タスク 9.1: ログインボタンのユニットテスト
**目的**: ログインボタンが正しく表示されることをテスト

**作業内容**:
- `client/src/app/__tests__/page.test.tsx`を修正
- 未ログイン時にログインボタンが表示されることをテスト
- ログイン済み時にログインボタンが表示されないことをテスト
- `useUser()`フックをモック

**受け入れ基準**:
- ログインボタンのユニットテストが正常に動作する
- テストが成功する

---

#### - [ ] タスク 9.2: ログアウトボタンのユニットテスト
**目的**: ログアウトボタンが正しく表示されることをテスト

**作業内容**:
- `client/src/app/__tests__/page.test.tsx`を修正
- ログイン済み時にログアウトボタンが表示されることをテスト
- 未ログイン時にログアウトボタンが表示されないことをテスト
- `useUser()`フックをモック

**受け入れ基準**:
- ログアウトボタンのユニットテストが正常に動作する
- テストが成功する

---

#### - [ ] タスク 9.3: ログイン状態表示のユニットテスト
**目的**: ログイン状態が正しく表示されることをテスト

**作業内容**:
- `client/src/app/__tests__/page.test.tsx`を修正
- ローディング状態の表示をテスト
- エラー状態の表示をテスト
- ログイン済み状態の表示をテスト
- 未ログイン状態の表示をテスト

**受け入れ基準**:
- ログイン状態表示のユニットテストが正常に動作する
- テストが成功する

---

#### - [ ] タスク 9.4: E2Eテストの実装（オプション）
**目的**: ログイン/ログアウトフローをE2Eテストで確認

**作業内容**:
- `client/e2e/auth-flow.spec.ts`を作成
- ログインフローのE2Eテストを実装
- ログアウトフローのE2Eテストを実装
- テスト用のAuth0アカウントを使用

**受け入れ基準**:
- E2Eテストが正常に動作する
- ログイン/ログアウトフローが正常に動作することを確認

**注意**: E2Eテストはオプション。実装時間に余裕がある場合のみ実装する。

---

### Phase 10: ドキュメントの更新

#### - [ ] タスク 10.1: READMEの更新
**目的**: READMEにAuth0ログイン機能の説明を追加

**作業内容**:
- `README.md`を確認
- Auth0ログイン機能の説明を追加
- 環境変数の設定方法を追加
- ログイン/ログアウトの手順を追加

**受け入れ基準**:
- READMEにAuth0ログイン機能の説明が追加されている
- 環境変数の設定方法が記載されている
- ログイン/ログアウトの手順が記載されている

---

#### - [ ] タスク 10.2: 環境変数の設定手順のドキュメント化
**目的**: 環境変数の設定手順を明確にドキュメント化

**作業内容**:
- 環境変数の設定手順をドキュメント化
- Client Secretの設定方法を明記
- 各環境での設定方法を明記

**受け入れ基準**:
- 環境変数の設定手順が明確にドキュメント化されている
- Client Secretの設定方法が明記されている

---

## 実装順序の推奨

1. **Phase 1**: パッケージのインストールと環境変数の設定（必須）
2. **Phase 2**: Auth0 SDKの設定（必須）
3. **Phase 3**: ログイン機能の実装（必須）
4. **Phase 4**: ログイン状態の表示（必須）
5. **Phase 5**: ログアウト機能の実装（必須）
6. **Phase 6**: JWT取得機能の実装（必須）
7. **Phase 7**: エラーハンドリングの実装（推奨）
8. **Phase 8**: 環境別設定の確認（必須）
9. **Phase 9**: テストの実装（推奨）
10. **Phase 10**: ドキュメントの更新（推奨）

## 注意事項

### 実装範囲
- **本実装の範囲**: ログインしてJWTを取得・保存するまで、ログイン状態の表示、ログアウト機能
- **次のissueで対応**: JWTを使ってAPIを叩く機能（apiClientの修正）

### セキュリティ
- Client Secretは環境変数のみで管理し、Gitにコミットしない
- `.env.local`は`.gitignore`に追加されていることを確認
- 本番環境ではHTTPSを使用する

### テスト
- ユニットテストは必須
- E2Eテストはオプション（実装時間に余裕がある場合のみ）

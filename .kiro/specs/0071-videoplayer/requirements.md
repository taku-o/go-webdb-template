# 動画プレイヤーコンポーネントとデモページの要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Feature名**: 0071-videoplayer
- **作成日**: 2026-01-27
- **関連Issue**: https://github.com/taku-o/go-webdb-template/issues/147

### 1.2 目的
Twitter風のフィードUIで使用する想定の動画プレイヤーコンポーネントを作成し、そのコンポーネントを表示するデモページを実装する。動画はHLS配信を想定し、HLS.jsを利用してHLSをサポートしないブラウザでも再生可能にする。UIはvideoタグをベースに実装し、必要に応じてカスタムコントロールを追加する。なお、Twitter風のフィードUI自体は別で実装する想定であり、本実装では単体の動画プレイヤーコンポーネントのデモページのみを作成する。

### 1.3 スコープ
- 動画プレイヤーコンポーネントの作成（HLS.jsとvideoタグを利用）
- デモページの作成（dmプレフィックス付きのページ名）
- デモ用の動画ファイルとサムネイル画像ファイルの配置（gitにコミットしない）

**本実装の範囲外**:
- Twitter風のフィードUIの実装（別で実装する想定）
- 動画のアップロード機能（既存の動画アップロード機能を使用）
- 動画のエンコード機能
- 動画の配信機能（既存の動画ファイルを使用）
- データベース連携（デモ用の静的ファイルのみ）
- 認証機能（既存の認証機能を使用）

## 2. 背景・現状分析

### 2.1 現状
- Next.js 14+ (App Router)を使用したクライアントアプリケーションが存在
- shadcn/uiコンポーネントライブラリが導入済み
- 動画アップロード機能（`/dm_movie/upload`）が既に実装されている
- トップページ（`client/app/page.tsx`）に機能一覧が表示されている
- デモ用の動画ファイル（`~/Desktop/movie/mini-movie-m.mp4`）とサムネイル画像ファイル（`~/Desktop/movie/mini-movie-m.png`）が存在

### 2.2 問題点
- 動画プレイヤーコンポーネントが存在しない
- HLS配信に対応した動画プレイヤーが存在しない
- Twitter風のフィードUIで使用できる動画プレイヤーコンポーネントが存在しない

### 2.3 必要性
- Twitter風のフィードUIで動画を表示するためのコンポーネントが必要
- HLS配信に対応した動画プレイヤーが必要
- 再生ボタンを押すまで動画をダウンロードしない遅延読み込み機能が必要
- 凝ったUIの動画プレイヤーが必要

### 2.4 実現可否
- Next.jsとReactを使用して実装可能
- HLS.jsとvideoタグを使用して実装可能
- 既存のプロジェクト構造に沿って実装可能

## 3. 機能要件

### 3.1 動画プレイヤーコンポーネント

#### 3.1.1 コンポーネントの基本仕様
- **新規作成**: `client/components/video-player/video-player.tsx`
- videoタグをベースに実装
- HLS配信を想定し、HLS.jsを利用
- HLSをサポートするブラウザではそのまま動画を表示
- HLSをサポートしないブラウザではHLS.jsを利用して動画を表示
- コンポーネントには以下のpropsを渡す:
  - `videoUrl: string` - HLSまたはMP4のURL
  - `thumbnailUrl: string` - サムネイル画像のURL
  - その他のオプション（必要に応じて）

#### 3.1.2 遅延読み込み機能
- 動画は再生ボタンを押すまで、ダウンロード開始しない
- `preload="none"`属性を設定
- サムネイル画像を表示し、再生ボタンをクリックしたら動画を読み込む

#### 3.1.3 UIデザイン
- videoタグをベースに実装
- サムネイル画像を表示（`poster`属性を使用）
- 再生ボタンを中央に配置（カスタムUIまたはvideoタグの標準コントロール）
- 再生中はvideoタグの標準コントロールを表示（`controls`属性を使用）
- 必要に応じてカスタムコントロールを追加

#### 3.1.4 HLS対応
- HLSをサポートするブラウザ（Safari等）では、videoタグのsrc属性にHLSのURLを直接設定
- HLSをサポートしないブラウザでは、HLS.jsを使用して動画を再生
- HLS.jsの初期化とクリーンアップを適切に実装

#### 3.1.5 フィードUIでの使用想定
- Twitter風のフィードUIで、いくつかの動画プレイヤーを並べて表示する想定
- 各動画プレイヤーは独立して動作する
- 複数の動画プレイヤーが同時に存在しても問題なく動作する

### 3.2 デモページ

#### 3.2.1 ページの作成
- **新規作成**: `client/app/dm_videoplayer/page.tsx`
- トップページ（`client/app/page.tsx`）の機能一覧に「動画プレイヤー」リンクを追加
- リンク先: `/dm_videoplayer`
- ページタイトル: 「動画プレイヤー」
- 単体の動画プレイヤーコンポーネントを表示（デモ用）
- レスポンシブデザインに対応

#### 3.2.2 デモ用ファイルの配置
- デモ用の動画ファイル（`~/Desktop/movie/mini-movie-m.mp4`）を`client/public/demo-videos/mini-movie-m.mp4`にコピー
- デモ用のサムネイル画像ファイル（`~/Desktop/movie/mini-movie-m.png`）を`client/public/demo-videos/mini-movie-m.png`にコピー
- これらのファイルはgitにコミットしない（`.gitignore`に追加）
- デモページでは、これらのファイルを参照して動画プレイヤーを表示

#### 3.2.3 デモページの表示内容
- 単体の動画プレイヤーコンポーネントを表示（デモ用）
- 動画ファイルとサムネイル画像を表示
- 動画プレイヤーコンポーネントが正常に動作することを確認できる

### 3.3 依存関係の追加

#### 3.3.1 必要なパッケージ
- `hls.js` - HLS.jsライブラリ

#### 3.3.2 パッケージのインストール
- `npm install hls.js`
- 型定義が必要な場合は`@types/hls.js`もインストール

## 4. 非機能要件

### 4.1 UI/UX
- videoタグをベースにした統一感のあるデザイン
- レスポンシブデザインに対応（モバイル、タブレット、デスクトップ）
- アクセシビリティに配慮（適切なaria-label、キーボード操作対応）
- ローディング状態の適切な表示
- エラー状態の適切な表示

### 4.2 パフォーマンス
- 遅延読み込みにより、初期ページ読み込み時のパフォーマンスを維持
- 動画の読み込みは必要になった時点で開始
- コンポーネントは複数の動画プレイヤーが同時に存在しても問題なく動作する設計とする（将来のTwitter風フィードUIでの使用を想定）

### 4.3 保守性
- コンポーネントを適切に分割し、再利用可能な構造にする
- 型安全性を確保（TypeScript）
- 既存のプロジェクト構造に沿った実装

### 4.4 互換性
- 既存の認証機能と互換性を保つ
- 既存のshadcn/uiコンポーネントと整合性を保つ
- 各種ブラウザ（Chrome、Firefox、Safari、Edge）で動作する

## 5. 制約事項

### 5.1 技術的制約
- HLS.jsとvideoタグを使用する
- videoタグをベースに実装する
- デモ用のファイルはgitにコミットしない

### 5.2 実装上の制約
- 既存のプロジェクト構造に沿って実装する
- 既存のshadcn/uiコンポーネントを活用する
- デモ用のファイルは`client/public/demo-videos/`に配置する

### 5.3 機能の制約
- 認証機能は既存のものを使用（新規実装は不要）
- 動画のアップロード機能は既存のものを使用（新規実装は不要）
- デモ用のファイルのみを使用（動的な動画取得は不要）

## 6. 受け入れ基準

### 6.1 動画プレイヤーコンポーネント
- [ ] `client/components/video-player/video-player.tsx`が作成されている
- [ ] videoタグをベースに実装されている
- [ ] HLS.jsが適切に統合されている
- [ ] HLSをサポートするブラウザではそのまま動画を表示できる
- [ ] HLSをサポートしないブラウザではHLS.jsを利用して動画を表示できる
- [ ] 動画は再生ボタンを押すまで、ダウンロード開始しない（`preload="none"`）
- [ ] サムネイル画像が表示される（`poster`属性を使用）
- [ ] videoタグが適切に実装されている
- [ ] 動画プレイヤーが表示される
- [ ] 複数の動画プレイヤーが同時に存在しても問題なく動作する

### 6.2 デモページ
- [ ] `client/app/dm_videoplayer/page.tsx`が作成されている
- [ ] `/dm_videoplayer`にアクセスした際、デモページが表示される
- [ ] トップページに「動画プレイヤー」リンクが追加されている
- [ ] リンクからデモページに遷移できる
- [ ] 単体の動画プレイヤーコンポーネントが表示される
- [ ] 動画プレイヤーコンポーネントが正常に動作する
- [ ] レスポンシブデザインに対応している

### 6.3 デモ用ファイルの配置
- [ ] `client/public/demo-videos/mini-movie-m.mp4`が存在する（gitにコミットされていない）
- [ ] `client/public/demo-videos/mini-movie-m.png`が存在する（gitにコミットされていない）
- [ ] `.gitignore`に`client/public/demo-videos/`が追加されている
- [ ] デモページでこれらのファイルが正しく参照されている

### 6.4 依存関係
- [ ] `hls.js`がインストールされている
- [ ] 必要な型定義がインストールされている（該当する場合）

### 6.5 UI/UX
- [ ] videoタグが適切に使用されている
- [ ] レスポンシブデザインに対応している
- [ ] アクセシビリティに配慮されている
- [ ] ローディング状態が適切に表示される
- [ ] エラー状態が適切に表示される

## 7. 影響範囲

### 7.1 変更されるファイル
- `client/app/page.tsx`: 機能一覧に「動画プレイヤー」リンクを追加
- `.gitignore`: `client/public/demo-videos/`を追加

### 7.2 新規作成されるファイル
- `client/components/video-player/video-player.tsx`: 動画プレイヤーコンポーネント
- `client/app/dm_videoplayer/page.tsx`: デモページ
- `client/public/demo-videos/mini-movie-m.mp4`: デモ用動画ファイル（gitにコミットしない）
- `client/public/demo-videos/mini-movie-m.png`: デモ用サムネイル画像ファイル（gitにコミットしない）

### 7.3 既存ファイルへの影響
- 既存のコンポーネント構造への影響なし（新規コンポーネントの追加のみ）
- 既存のページに影響なし（新規ページの追加のみ）
- 既存の機能への影響なし

### 7.4 既存機能への影響
- 既存の機能への影響なし
- 認証機能は既存のものを使用（変更なし）

## 8. 実装上の注意事項

### 8.1 コンポーネント設計
- コンポーネントを適切に分割し、再利用可能な構造にする
- 状態管理はReact Hooks（useState、useRef、useMemo等）を使用
- どうしても必要な時以外はuseEffectを使用しない
- HLS.jsの初期化は再生ボタンクリック時に行う
- HLS.jsのクリーンアップはコンポーネントアンマウント時のみuseEffectを使用（必要最小限）

### 8.2 HLS.jsの統合
- HLSをサポートするブラウザの判定を行う
- HLSをサポートしないブラウザでは、HLS.jsを使用して動画を再生
- HLS.jsのインスタンスを適切に管理（メモリリークを防ぐ）

### 8.3 遅延読み込みの実装
- `preload="none"`属性を設定
- サムネイル画像を表示し、再生ボタンをクリックしたら動画を読み込む
- 再生ボタンのクリックイベントを適切に処理

### 8.4 デモ用ファイルの配置
- `~/Desktop/movie/mini-movie-m.mp4`を`client/public/demo-videos/mini-movie-m.mp4`にコピー
- `~/Desktop/movie/mini-movie-m.png`を`client/public/demo-videos/mini-movie-m.png`にコピー
- `.gitignore`に`client/public/demo-videos/`を追加
- デモページでは、これらのファイルを`/demo-videos/mini-movie-m.mp4`のように参照

### 8.5 エラーハンドリング
- 動画の読み込みエラーを適切にハンドリング
- HLS.jsのエラーを適切にハンドリング
- ユーザーフレンドリーなエラーメッセージを表示

### 8.6 テスト
- コンポーネントの単体テストは不要（本実装では）
- E2Eテストは不要（本実装では）
- 動作確認は手動で実施
- 各種ブラウザ（Chrome、Firefox、Safari、Edge）で動作確認

## 9. 参考情報

### 9.1 関連ドキュメント
- 既存の`client/app/page.tsx`
- 既存の`client/app/dm_movie/upload/page.tsx`
- HLS.jsドキュメント
- HTML5 videoタグドキュメント
- Next.js App Routerドキュメント

### 9.2 関連Issue
- https://github.com/taku-o/go-webdb-template/issues/147: 本要件定義書の元となったIssue

### 9.3 技術スタック
- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript 5+
- **UIライブラリ**: shadcn/ui
- **スタイリング**: Tailwind CSS
- **動画プレイヤー**: videoタグ（HTML5）
- **HLS対応**: HLS.js

### 9.4 実装の流れ
1. 依存関係の追加（`hls.js`）
2. 動画プレイヤーコンポーネントの作成（`client/components/video-player/video-player.tsx`）
3. デモ用ファイルの配置（`client/public/demo-videos/`）
4. `.gitignore`の更新
5. デモページの作成（`client/app/dm_videoplayer/page.tsx`）
6. トップページへのリンク追加（`client/app/page.tsx`）
7. 動作確認

### 9.5 依存関係
- 既存のNext.jsプロジェクト構造
- 既存のshadcn/uiコンポーネント
- 既存の認証機能（使用のみ、変更なし）

# 起動サーバー一覧表示機能の要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Feature名**: 0077-listapp
- **作成日**: 2026-01-17
- **関連Issue**: https://github.com/taku-o/go-webdb-template/issues/157

### 1.2 目的
開発環境で起動しているサーバーの状態を確認するためのコンソールプログラムを作成する。どのサーバーが動作しているかを一目で確認できるようにし、開発効率を向上させる。

### 1.3 スコープ
- 13個のサーバー（API、Client、Admin、JobQueue、PostgreSQL、MySQL、Redis、Redis Cluster、Mailpit、CloudBeaver、Superset、Metabase、Redis Insight）のポート番号を確認し、起動状態を判定する
- 結果を表形式で表示する（指定された順序で表示）
- コンソールプログラムとして実装する（シェルスクリプトまたはGoプログラム）

**本実装の範囲外**:
- サーバーの起動・停止機能
- サーバーの詳細情報の表示（バージョン、メモリ使用量など）
- サーバーのログ表示
- リモートサーバーの状態確認
- 自動再起動機能
- PostgreSQL/MySQLのシャードインスタンスの個別確認（メインのポートのみ確認）

## 2. 背景・現状分析

### 2.1 現在の状況
開発環境では以下のサーバーを起動する可能性がある：

#### アプリケーションサーバー
| サーバー | ポート | ディレクトリ | 起動コマンド |
|---------|-------|-------------|-------------|
| API | 8080 | `server/cmd/server` | `APP_ENV=develop go run ./cmd/server/main.go` |
| Client | 3000 | `client/` | `npm run dev` |
| Admin | 8081 | `server/cmd/admin` | `APP_ENV=develop go run ./cmd/admin/main.go` |
| JobQueue | 8082 | `server/cmd/jobqueue` | `APP_ENV=develop go run ./cmd/jobqueue/main.go` |

#### データベースサーバー
| サーバー | ポート | 起動方法 |
|---------|-------|---------|
| PostgreSQL | 5432 | `docker-compose -f docker-compose.postgres.yml up -d` |
| MySQL | 3306 | `docker-compose -f docker-compose.mysql.yml up -d` |

#### キャッシュ・キューサーバー
| サーバー | ポート | 起動方法 |
|---------|-------|---------|
| Redis | 6379 | `docker-compose -f docker-compose.redis.yml up -d` |
| Redis Cluster | 7100-7105 | `docker-compose -f docker-compose.redis-cluster.yml up -d` |

#### 開発ツール
| サーバー | ポート | 起動方法 |
|---------|-------|---------|
| Mailpit | 8025 | `docker-compose -f docker-compose.mailpit.yml up -d` |
| CloudBeaver | 8978 | `docker-compose -f docker-compose.cloudbeaver.yml up -d` |
| Superset | 8088 | `docker-compose -f docker-compose.apache-superset.yml up -d` |
| Metabase | 8970 | `docker-compose -f docker-compose.metabase.yml up -d` |
| Redis Insight | 8001 | `docker-compose -f docker-compose.redis-insight.yml up -d` |

### 2.2 課題点
1. **サーバー状態の確認が困難**: どのサーバーが起動しているかを確認する方法がない
2. **手動確認の手間**: 各サーバーのポートに接続を試みるなど、手動で確認する必要がある
3. **開発効率の低下**: サーバーが起動していないことに気づかずに開発を進めてしまう可能性がある
4. **一覧性の欠如**: 複数のサーバー（アプリケーション、データベース、開発ツールなど）の状態を一度に確認できない
5. **サーバー数の多さ**: 13個のサーバーがあり、個別に確認するのは非効率

### 2.3 本実装による改善点
1. **状態確認の簡便化**: 一つのコマンドで全サーバー（13個）の状態を確認できる
2. **開発効率の向上**: サーバーの起動状態を素早く確認できる
3. **視認性の向上**: 表形式で見やすく表示され、指定された順序で整理される
4. **運用の改善**: サーバーの起動漏れを防ぐことができる
5. **包括的な確認**: アプリケーション、データベース、開発ツールなど、すべてのサーバーを一度に確認できる

## 3. 機能要件

### 3.1 サーバー状態の確認

#### 3.1.1 確認対象サーバー
以下の13個のサーバーの状態を確認する：

| サーバー名 | ポート | 確認方法 |
|-----------|-------|---------|
| API | 8080 | ポートへのTCP接続または`/health`エンドポイント |
| Client | 3000 | ポートへのTCP接続または`/health`エンドポイント |
| Admin | 8081 | ポートへのTCP接続または`/health`エンドポイント |
| JobQueue | 8082 | ポートへのTCP接続または`/health`エンドポイント |
| PostgreSQL | 5432 | ポートへのTCP接続 |
| MySQL | 3306 | ポートへのTCP接続 |
| Redis | 6379 | ポートへのTCP接続 |
| Redis Cluster | 7100 | ポートへのTCP接続（最初のポート） |
| Mailpit | 8025 | ポートへのTCP接続（Web UI） |
| CloudBeaver | 8978 | ポートへのTCP接続 |
| Superset | 8088 | ポートへのTCP接続または`/health`エンドポイント |
| Metabase | 8970 | ポートへのTCP接続または`/api/health`エンドポイント |
| Redis Insight | 8001 | ポートへのTCP接続 |

#### 3.1.2 状態判定方法
- **起動中**: ポートへのTCP接続が成功する場合
- **停止中**: ポートへのTCP接続が失敗する場合（接続拒否、タイムアウトなど）

#### 3.1.3 実装方法
- シェルスクリプトまたはGoプログラムで実装可能
- ポートへのTCP接続を試みて、成功/失敗を判定する
- タイムアウトは適切な時間（例: 1秒）を設定する

### 3.2 結果の表示

#### 3.2.1 表示形式
表形式で以下の情報を表示する：

```
サーバー          | ポート | 状態
------------------|-------|--------
API              | 8080  | 起動中
Client           | 3000  | 停止中
Admin            | 8081  | 起動中
JobQueue         | 8082  | 停止中
PostgreSQL       | 5432  | 起動中
MySQL            | 3306  | 停止中
Redis            | 6379  | 起動中
Redis Cluster    | 7100  | 停止中
Mailpit          | 8025  | 起動中
CloudBeaver      | 8978  | 停止中
Superset         | 8088  | 起動中
Metabase         | 8970  | 停止中
Redis Insight    | 8001  | 起動中
```

#### 3.2.2 表示項目
- **サーバー名**: サーバーの名称
- **ポート**: サーバーが使用するポート番号
- **状態**: 「起動中」または「停止中」

#### 3.2.3 表示の詳細
- 表形式で見やすく表示する
- 各サーバーの状態が一目で分かるようにする
- 日本語で表示する

### 3.3 実装方式

#### 3.3.1 実装方法の選択
- **シェルスクリプト**: シンプルで軽量、`nc`（netcat）や`curl`を使用
- **Goプログラム**: プロジェクトの技術スタックに一致、クロスプラットフォーム対応

実現方法は何でも良いとされているため、どちらでも実装可能。ただし、プロジェクトの技術スタック（Go）を考慮すると、Goプログラムでの実装が望ましい。

#### 3.3.2 実装場所
- **シェルスクリプトの場合**: `scripts/`ディレクトリに配置（例: `scripts/server-status.sh`）
- **Goプログラムの場合**: `server/cmd/server-status/main.go`に配置

#### 3.3.3 実行方法
- **シェルスクリプトの場合**: `./scripts/server-status.sh`または`bash scripts/server-status.sh`
- **Goプログラムの場合**: `go run ./cmd/server-status/main.go`またはビルドして実行

## 4. 非機能要件

### 4.1 パフォーマンス
- **実行時間**: 各サーバーの確認は並列実行または順次実行で、全体で5秒以内に完了する
- **リソース使用量**: 最小限（ポート接続のみ）
- **タイムアウト**: 各ポートへの接続試行は1秒以内にタイムアウトする

### 4.2 可用性
- **エラーハンドリング**: ポート接続エラーを適切に処理し、停止中として表示する
- **ネットワークエラー**: ネットワークエラーが発生した場合も適切に処理する

### 4.3 保守性
- **コードの簡潔性**: シンプルで理解しやすい実装
- **拡張性**: 将来的にサーバーが追加された場合、設定を追加するだけで対応できる

### 4.4 動作環境
- **ローカル環境**: ローカル環境で動作する
- **OS**: macOS、Linuxで動作する（Windowsはオプション）

## 5. 制約事項

### 5.1 技術的制約
- **ポート確認方法**: TCP接続による確認（`/health`エンドポイントはオプション）
- **既存機能への影響**: 既存のサーバーや機能に影響を与えない
- **外部依存**: 可能な限り標準ライブラリまたは標準コマンドを使用する

### 5.2 実装上の制約
- **サーバー情報のハードコーディング**: サーバー名、ポート番号はコード内に定義する（設定ファイルは不要）
- **認証**: ポート接続のみで判定するため、認証は不要

### 5.3 動作環境
- **ローカル環境**: ローカル環境でのみ動作する（リモートサーバーは対象外）
- **開発環境**: 開発環境（`APP_ENV=develop`）を想定

## 6. 受け入れ基準

### 6.1 サーバー状態の確認
- [ ] API（ポート8080）の状態が正しく判定される
- [ ] Client（ポート3000）の状態が正しく判定される
- [ ] Admin（ポート8081）の状態が正しく判定される
- [ ] JobQueue（ポート8082）の状態が正しく判定される
- [ ] PostgreSQL（ポート5432）の状態が正しく判定される
- [ ] MySQL（ポート3306）の状態が正しく判定される
- [ ] Redis（ポート6379）の状態が正しく判定される
- [ ] Redis Cluster（ポート7100）の状態が正しく判定される
- [ ] Mailpit（ポート8025）の状態が正しく判定される
- [ ] CloudBeaver（ポート8978）の状態が正しく判定される
- [ ] Superset（ポート8088）の状態が正しく判定される
- [ ] Metabase（ポート8970）の状態が正しく判定される
- [ ] Redis Insight（ポート8001）の状態が正しく判定される
- [ ] ポート接続エラーが適切に処理される

### 6.2 結果の表示
- [ ] 表形式でサーバー名、ポート、状態が表示される
- [ ] 「起動中」「停止中」が正しく表示される
- [ ] 日本語で表示される
- [ ] 見やすい形式で表示される

### 6.3 動作確認
- [ ] 全てのサーバーが起動している場合、全て「起動中」と表示される
- [ ] 一部のサーバーが停止している場合、該当サーバーが「停止中」と表示される
- [ ] 全てのサーバーが停止している場合、全て「停止中」と表示される
- [ ] サーバーが指定された順序（API、Client、Admin、JobQueue、PostgreSQL、MySQL、Redis、Redis Cluster、Mailpit、CloudBeaver、Superset、Metabase、Redis Insight）で表示される
- [ ] コマンド実行が正常に完了する

### 6.4 実装
- [ ] シェルスクリプトまたはGoプログラムとして実装されている
- [ ] 実行可能な形式になっている
- [ ] エラーハンドリングが適切に実装されている

## 7. 影響範囲

### 7.1 変更が必要なファイル

#### 新規作成するファイル
- **シェルスクリプトの場合**: `scripts/server-status.sh`（新規作成）
- **Goプログラムの場合**: `server/cmd/server-status/main.go`（新規作成）

#### 確認が必要なファイル
- なし（新規機能のため）

### 7.2 既存機能への影響
- **既存のサーバー**: 影響なし（ポート接続のみで判定）
- **既存の機能**: 影響なし（新規機能の追加のみ）

### 7.3 テストへの影響
- **既存のテスト**: 影響なし（新規機能のため）
- **新規テスト**: 必要に応じてテストを追加する可能性がある

## 8. 実装上の注意事項

### 8.1 ポート確認の注意事項
- **タイムアウト設定**: 適切なタイムアウト時間（1秒程度）を設定する
- **エラーハンドリング**: 接続拒否、タイムアウト、その他のエラーを適切に処理する
- **並列実行**: 複数のサーバーを並列に確認することで、実行時間を短縮できる

### 8.2 表示の注意事項
- **表形式**: 見やすい表形式で表示する（列の幅を適切に設定）
- **日本語表示**: サーバー名と状態を日本語で表示する
- **エラー表示**: エラーが発生した場合も適切に表示する

### 8.3 実装方式の注意事項
- **シェルスクリプトの場合**: `nc`（netcat）や`curl`の有無を確認する
- **Goプログラムの場合**: 標準ライブラリの`net`パッケージを使用する
- **クロスプラットフォーム**: macOS、Linuxで動作することを確認する

## 9. 参考情報

### 9.1 サーバー情報
- **API**: ポート8080、`/health`エンドポイントあり
- **Client**: ポート3000、Next.js開発サーバー、`/health`エンドポイントあり
- **Admin**: ポート8081、`/health`エンドポイントあり
- **JobQueue**: ポート8082、`/health`エンドポイントあり
- **PostgreSQL**: ポート5432、PostgreSQLデータベース
- **MySQL**: ポート3306、MySQLデータベース
- **Redis**: ポート6379、Redisキャッシュ・ジョブキュー
- **Redis Cluster**: ポート7100-7105、Redis Cluster（最初のポート7100で確認）
- **Mailpit**: ポート8025（Web UI）、メールテストツール
- **CloudBeaver**: ポート8978、データベース管理ツール
- **Superset**: ポート8088、データ可視化ツール、`/health`エンドポイントあり
- **Metabase**: ポート8970、BIツール、`/api/health`エンドポイントあり
- **Redis Insight**: ポート8001、Redis管理ツール

### 9.2 技術スタック
- **言語**: Go（推奨）またはシェルスクリプト
- **ポート確認**: TCP接続（`net.Dial`または`nc`コマンド）
- **表示**: 標準出力への表形式出力

### 9.3 関連ドキュメント
- `.kiro/steering/tech.md`: サーバー構成の詳細
- `config/develop/config.yaml`: サーバー設定
- Issue #157: 本機能の元となる要望

# テスト用データベース導入の要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Issue番号**: #105
- **Issueタイトル**: テスト用データベースの導入
- **Feature名**: 0051-testdb
- **作成日**: 2026-01-10

### 1.2 目的
テスト実行時に使用する専用のデータベースを用意し、開発環境や本番環境のデータベースと分離する。これにより、テスト実行によるデータ汚染を防ぎ、安全にテストを実行できるようにする。

### 1.3 スコープ
- テスト用データベース設定ファイル（`config/test/database.yaml`）の作成
- テスト用Atlas設定ファイル（`config/test/atlas.hcl`）の作成
- テスト用データベース名の命名規則の定義（`_test`サフィックス）
- テスト実行時にテスト用データベースを使用する仕組みの実装
- テスト開始時にデータベースの内容をクリアする機能の実装

**本実装の範囲外**:
- テスト用データベースの自動作成・削除機能（手動で作成する前提）
- テスト用データベースのマイグレーション自動実行機能（手動で実行する前提）
- CI/CD環境でのテスト用データベース設定（別途対応）

## 2. 背景・現状分析

### 2.1 現在の状況
- **開発環境設定**: `config/develop/database.yaml`に開発環境用のデータベース設定が存在
  - マスターデータベース: `webdb_master` (localhost:5432)
  - シャーディングデータベース: `webdb_sharding_1` ~ `webdb_sharding_4` (localhost:5433-5436)
- **Atlas設定**: `config/develop/atlas.hcl`に開発環境用のAtlas設定が存在
- **テスト実装**: `server/test/testutil/db.go`にテスト用のデータベース接続設定が存在
  - `SetupTestGroupManager`関数: ハードコードされた設定でデータベース接続を作成
  - データベース名: `webdb_master`, `webdb_sharding_1` ~ `webdb_sharding_4`（開発環境と同じ）
  - テスト実行時に開発環境のデータベースを直接使用している

### 2.2 課題点
1. **データ汚染のリスク**: テスト実行時に開発環境のデータベースを直接使用するため、テストデータが開発環境に残る
2. **テストの独立性**: 開発環境のデータがテスト結果に影響を与える可能性がある
3. **並行実行の制約**: 複数のテストを並行実行する場合、同じデータベースを使用すると競合が発生する
4. **設定の重複**: テスト用の設定がコード内にハードコードされており、設定ファイルと分離されていない

### 2.3 本実装による改善点
1. **データ分離**: テスト用データベースを用意することで、開発環境のデータと分離される
2. **テストの独立性**: テスト開始時にデータベースをクリアすることで、テスト間の独立性が保証される
3. **設定の一元管理**: テスト用の設定を設定ファイルに集約し、管理しやすくなる
4. **並行実行の可能性**: 将来的にテスト用データベースを複数用意することで、並行実行が可能になる

## 3. 機能要件

### 3.1 テスト用データベース設定ファイルの作成

#### 3.1.1 ファイル構成
- **ファイルパス**: `config/test/database.yaml`
- **構成**: 開発環境設定（`config/develop/database.yaml`）をベースに、データベース名に`_test`サフィックスを付与

#### 3.1.2 データベース名の命名規則
- **マスターデータベース**: `webdb_master` → `webdb_master_test`
- **シャーディングデータベース**: 
  - 案1: `webdb_sharding_1` → `webdb_sharding_1_test`
  - 案2: `webdb_sharding_1` → `webdb_sharding_test_1`
- **採用案**: 案1（`webdb_sharding_1_test`）を採用
  - 理由: 既存のデータベース名の後に`_test`を付与する方が一貫性がある

#### 3.1.3 設定内容
- ホスト、ポート、ユーザー、パスワードは開発環境と同じ設定を使用
- データベース名のみ`_test`サフィックスを付与
- 接続設定（max_connections等）も開発環境と同じ設定を使用

### 3.2 テスト用Atlas設定ファイルの作成

#### 3.2.1 ファイル構成
- **ファイルパス**: `config/test/atlas.hcl`
- **構成**: 開発環境設定（`config/develop/atlas.hcl`）をベースに、データベース名に`_test`サフィックスを付与

#### 3.2.2 環境設定
- 各環境（master, sharding_1 ~ sharding_4）のURLにテスト用データベース名を使用
- 例: `postgres://webdb:webdb@localhost:5432/webdb_master_test?sslmode=disable`
- マイグレーションディレクトリは開発環境と同じ設定を使用

### 3.3 テスト実行時のデータベース設定読み込み

#### 3.3.1 設定読み込み方法
- テスト実行時に`config/test/database.yaml`を読み込む
- 既存の`config.Load()`関数を拡張するか、テスト専用の設定読み込み関数を実装
- 環境変数やフラグでテスト環境を指定できるようにする

#### 3.3.2 実装場所
- `server/test/testutil/db.go`の`SetupTestGroupManager`関数を修正
- ハードコードされた設定の代わりに、設定ファイルから読み込む

### 3.4 テスト開始時のデータベースクリア機能

#### 3.4.1 クリア対象
- マスターデータベースの全テーブルのデータを削除
- シャーディングデータベースの全テーブルのデータを削除
- テーブル構造は維持（TRUNCATEまたはDELETEを使用）

#### 3.4.2 実装方法
- テスト開始時に自動的にデータベースをクリアする関数を実装
- `SetupTestGroupManager`関数内で自動実行するか、別関数として提供

#### 3.4.3 パフォーマンス
- 大量のデータがある場合でも、クリア処理が高速に実行されること
- TRUNCATEを使用することで、DELETEよりも高速に処理できる

## 4. 非機能要件

### 4.1 パフォーマンス
- **設定読み込み時間**: 1秒以下
- **データベースクリア時間**: データ量に応じて変動するが、10秒以内を目安とする

### 4.2 可用性
- **テスト用データベースの存在確認**: テスト実行前にデータベースの存在を確認し、存在しない場合はエラーメッセージを表示
- **接続エラーハンドリング**: データベース接続に失敗した場合、適切なエラーメッセージを表示

### 4.3 セキュリティ
- **認証情報**: 開発環境と同じ認証情報を使用（テスト環境のみのため）
- **データ分離**: テスト用データベースと開発環境データベースは完全に分離される

### 4.4 保守性
- **設定の一元管理**: テスト用の設定を設定ファイルに集約
- **コードの簡潔性**: ハードコードされた設定を削除し、設定ファイルから読み込むように変更
- **一貫性**: 開発環境設定と同様の構造を維持

## 5. 制約事項

### 5.1 技術的制約
- **データベースの事前作成**: テスト用データベースは手動で事前に作成する必要がある
- **マイグレーションの実行**: テスト用データベースに対してマイグレーションを手動で実行する必要がある
- **PostgreSQL**: PostgreSQLデータベースを使用（SQLite等への対応は不要）

### 5.2 実装上の制約
- **既存テストへの影響**: 既存のテストが正常に動作することを確認する
- **設定ファイルの互換性**: 既存の設定ファイル構造を維持する
- **後方互換性**: 既存のテストコードへの影響を最小限に抑える

### 5.3 動作環境
- **ローカル環境**: ローカル環境でテスト用データベースが動作することを確認
- **Docker環境**: Docker環境での動作確認は本実装の範囲外（別途対応）

## 6. 受け入れ基準

### 6.1 テスト用データベース設定ファイルの作成
- [ ] `config/test/database.yaml`が作成されている
- [ ] データベース名に`_test`サフィックスが付与されている
- [ ] マスターデータベース名が`webdb_master_test`である
- [ ] シャーディングデータベース名が`webdb_sharding_1_test` ~ `webdb_sharding_4_test`である
- [ ] その他の設定（ホスト、ポート、ユーザー等）が開発環境と同じである

### 6.2 テスト用Atlas設定ファイルの作成
- [ ] `config/test/atlas.hcl`が作成されている
- [ ] 各環境のURLにテスト用データベース名が使用されている
- [ ] マイグレーションディレクトリが正しく設定されている

### 6.3 テスト実行時のデータベース設定読み込み
- [ ] テスト実行時に`config/test/database.yaml`が読み込まれる
- [ ] `SetupTestGroupManager`関数が設定ファイルから設定を読み込む
- [ ] ハードコードされた設定が削除されている
- [ ] 既存のテストが正常に動作する

### 6.4 テスト開始時のデータベースクリア機能
- [ ] テスト開始時にデータベースの内容がクリアされる
- [ ] マスターデータベースの全テーブルがクリアされる
- [ ] シャーディングデータベースの全テーブルがクリアされる
- [ ] テーブル構造が維持される（テーブルが削除されない）
- [ ] クリア処理が高速に実行される

### 6.5 動作確認
- [ ] テスト用データベースが事前に作成されていることを確認
- [ ] テスト用データベースに対してマイグレーションが実行されていることを確認
- [ ] テストを実行して、テスト用データベースが使用されることを確認
- [ ] テスト実行後、開発環境のデータベースに影響がないことを確認
- [ ] 既存のテストが全て失敗しないことを確認

### 6.6 実現可能性の検討
- [ ] テスト用データベースの導入が技術的に実現可能であることを確認
- [ ] 設定ファイルからの読み込みが正常に動作することを確認
- [ ] データベースクリア機能が正常に動作することを確認
- [ ] パフォーマンスに問題がないことを確認

## 7. 影響範囲

### 7.1 変更が必要なファイル

#### 新規作成するファイル
- `config/test/database.yaml`: テスト用データベース設定ファイル
- `config/test/atlas.hcl`: テスト用Atlas設定ファイル

#### 修正が必要なファイル
- `server/test/testutil/db.go`: 設定ファイルから読み込むように修正
  - `SetupTestGroupManager`関数の修正
  - `SetupTestGroupManager8Sharding`関数の修正
  - データベースクリア機能の追加

#### 確認が必要なファイル
- `server/internal/config/config.go`: 設定読み込み関数の確認（必要に応じて修正）
- 既存のテストファイル: 正常に動作することを確認

### 7.2 既存機能への影響
- **既存のテスト**: 設定ファイルから読み込むように変更するが、テストの動作は変わらない
- **開発環境**: 影響なし（テスト用データベースは別データベース）
- **本番環境**: 影響なし

### 7.3 テストへの影響
- **既存のテスト**: テスト用データベースを使用するように変更するが、テストロジックは変更しない
- **新規テスト**: テスト用データベースを使用する前提で実装

## 8. 実装上の注意事項

### 8.1 設定ファイル作成の注意事項
- **データベース名の一貫性**: すべてのデータベース名に`_test`サフィックスを付与する
- **設定の完全性**: 開発環境設定のすべての項目を含める
- **コメント**: 設定ファイルに適切なコメントを追加する

### 8.2 テスト実装の注意事項
- **設定読み込みのエラーハンドリング**: 設定ファイルが存在しない場合や読み込みエラーの場合、適切なエラーメッセージを表示
- **データベース接続のエラーハンドリング**: テスト用データベースに接続できない場合、適切なエラーメッセージを表示

### 8.3 動作確認の注意事項
- **データベースの事前準備**: テスト実行前にテスト用データベースを作成し、マイグレーションを実行する
- **開発環境との分離**: テスト実行後、開発環境のデータベースに影響がないことを確認
- **パフォーマンステスト**: データベースクリア処理のパフォーマンスを確認

## 9. 参考情報

### 9.1 関連Issue
- GitHub Issue #105: テスト用データベースの導入

### 9.2 既存実装の参考
- **開発環境設定**: `config/develop/database.yaml`
- **開発環境Atlas設定**: `config/develop/atlas.hcl`
- **テストユーティリティ**: `server/test/testutil/db.go`
  - `SetupTestGroupManager`関数
  - `SetupTestGroupManager8Sharding`関数

### 9.3 技術スタック
- **言語**: Go
- **データベース**: PostgreSQL
- **マイグレーションツール**: Atlas
- **設定ファイル形式**: YAML (database.yaml), HCL (atlas.hcl)

### 9.4 関連ドキュメント
- `config/develop/database.yaml`: 開発環境のデータベース設定
- `config/develop/atlas.hcl`: 開発環境のAtlas設定
- `server/test/testutil/db.go`: テスト用のデータベース接続設定

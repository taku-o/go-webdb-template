# dm_newsテーブルidカラム定義変更実装タスク一覧

## 概要

Issue #59の対応として、dm_newsテーブルのidカラムの定義を`integer auto_increment = true`に変更する機能の実装を段階的に進めるためのタスク一覧。要件定義書と設計書に基づき、sonyflakeによるID生成を削除し、GORMのauto_increment機能に戻す。

## 実装フェーズ

### Phase 1: テーブル定義とモデル定義の修正

#### タスク 1.1: dm_newsテーブル定義の修正
**目的**: master.hclのdm_newsテーブルのidカラムを修正する

**作業内容**:
- db/schema/master.hclのdm_newsテーブル定義を修正
- idカラムの型を`bigint`から`integer`に変更
- `unsigned = true`を削除（integerはunsignedをサポートしない）
- `auto_increment = false`を`auto_increment = true`に変更
- Atlasスキーマ検証を実行

**受け入れ基準**:
- idカラムの型が`integer`に変更されている
- `unsigned = true`が削除されている
- `auto_increment = true`に設定されている
- Atlasスキーマ検証が正常に完了する
- コンパイルエラーがない
- _Requirements: REQ-1_

---

#### タスク 1.2: DmNewsモデル定義の修正
**目的**: DmNews構造体のIDフィールドのGORMタグを修正する

**作業内容**:
- server/internal/model/dm_news.goのDmNews構造体を修正
- IDフィールドのGORMタグを`gorm:"primaryKey"`から`gorm:"primaryKey;autoIncrement"`に変更
- ID型は`int64`のまま（integerでもint64で問題ない）
- コンパイルエラーの確認

**受け入れ基準**:
- IDフィールドのGORMタグに`autoIncrement`が追加されている
- モデルファイルが正常にコンパイルできる
- GORMがautoIncrementを使用する
- コンパイルエラーがない
- _Requirements: REQ-2_

---

### Phase 2: ID生成ロジックの修正

#### タスク 2.1: サンプルデータ生成コマンドの修正
**目的**: generateDmNews関数からsonyflakeによるID生成を削除する

**作業内容**:
- server/cmd/generate-sample-data/main.goの`generateDmNews`関数を修正
- `idgen.GenerateSonyflakeID()`の呼び出しを削除
- モデルのIDフィールドに値を設定しない（0のまま、GORMのautoIncrementに任せる）
- `idgen`パッケージのインポートが不要になった場合は削除（他の関数で使用されていない場合）
- コンパイルエラーの確認

**受け入れ基準**:
- sonyflakeによるID生成コードが削除されている
- モデルのIDフィールドに値を設定していない
- コンパイルエラーがない
- コマンドが正常に実行できる（次のフェーズで確認）
- _Requirements: REQ-3_

---

#### タスク 2.2: GoAdmin管理画面の修正
**目的**: GetDmNewsTable関数からsonyflakeによるID生成を削除する

**作業内容**:
- server/internal/admin/tables.goの`GetDmNewsTable`関数を修正
- フォーム設定の`FieldPostFilterFn`を削除（sonyflakeによるID生成を削除）
- IDフィールドの設定を簡素化（`FieldNotAllowEdit()`と`FieldHide()`のみ）
- `idgen`パッケージのインポートが不要になった場合は削除（他の関数で使用されていない場合）
- コンパイルエラーの確認

**受け入れ基準**:
- `FieldPostFilterFn`が削除されている
- sonyflakeによるID生成コードが削除されている
- IDフィールドの設定が簡素化されている
- コンパイルエラーがない
- 管理画面が正常に動作する（次のフェーズで確認）
- _Requirements: REQ-4_

---

### Phase 3: マイグレーションSQLファイルの生成

#### タスク 3.1: マイグレーションSQLファイルの生成
**目的**: AtlasでマイグレーションSQLファイルを生成する

**作業内容**:
- `atlas migrate diff`コマンドでマイグレーションSQLファイルを生成
- マイグレーションSQLファイルの内容を確認
- idカラムが`INTEGER AUTO_INCREMENT`になっていることを確認
- マイグレーションSQLファイルは`db/migrations/master/`に配置されることを確認

**受け入れ基準**:
- マイグレーションSQLファイルが正常に生成される
- マイグレーションSQLファイルの内容が正しい（idカラムが`INTEGER AUTO_INCREMENT`）
- マイグレーションSQLファイルが`db/migrations/master/`に配置されている
- _Requirements: REQ-5_

---

#### タスク 3.2: マイグレーションの適用確認
**目的**: マイグレーションが正常に適用できることを確認する

**作業内容**:
- マイグレーションSQLファイルを適用
- データベースのスキーマが正しく変更されていることを確認
- idカラムが`INTEGER AUTO_INCREMENT`になっていることを確認

**受け入れ基準**:
- マイグレーションが正常に適用できる
- データベースのスキーマが正しく変更されている
- idカラムが`INTEGER AUTO_INCREMENT`になっている
- _Requirements: REQ-5_

---

### Phase 4: テストの実行と動作確認

#### タスク 4.1: 既存テストの実行
**目的**: 既存のテストが正常に動作することを確認する

**作業内容**:
- 既存の単体テストを実行
- 既存の統合テストを実行
- テストエラーがないことを確認

**受け入れ基準**:
- 既存の単体テストが全て正常に動作する
- 既存の統合テストが全て正常に動作する
- テストエラーが発生しない
- _Requirements: REQ-6_

---

#### タスク 4.2: サンプルデータ生成コマンドの動作確認
**目的**: サンプルデータ生成コマンドでIDが自動生成されることを確認する

**作業内容**:
- サンプルデータ生成コマンドを実行
- 生成されたデータのIDが連番になっていることを確認
- IDが自動生成されていることを確認

**受け入れ基準**:
- サンプルデータ生成コマンドが正常に実行できる
- 生成されたIDが連番になっている
- IDが自動生成されている（手動で設定していない）
- _Requirements: REQ-3, REQ-6_

---

#### タスク 4.3: GoAdmin管理画面の動作確認
**目的**: GoAdmin管理画面で新規作成時にIDが自動生成されることを確認する

**作業内容**:
- GoAdmin管理画面で新規作成を実行
- 生成されたIDが連番になっていることを確認
- IDが自動生成されていることを確認

**受け入れ基準**:
- GoAdmin管理画面が正常に動作する
- 新規作成時にIDが自動生成される
- 生成されたIDが連番になっている
- _Requirements: REQ-4, REQ-6_

---

#### タスク 4.4: ビルドの確認
**目的**: ビルドが正常に完了することを確認する

**作業内容**:
- プロジェクト全体のビルドを実行
- コンパイルエラーがないことを確認
- ビルドが正常に完了することを確認

**受け入れ基準**:
- ビルドが正常に完了する
- コンパイルエラーがない
- 警告がない（または許容範囲内）

---

## タスク依存関係

```
Phase 1: テーブル定義とモデル定義の修正
  ├─ タスク 1.1: dm_newsテーブル定義の修正
  └─ タスク 1.2: DmNewsモデル定義の修正

Phase 2: ID生成ロジックの修正（Phase 1の完了後）
  ├─ タスク 2.1: サンプルデータ生成コマンドの修正
  └─ タスク 2.2: GoAdmin管理画面の修正

Phase 3: マイグレーションSQLファイルの生成（Phase 1の完了後）
  ├─ タスク 3.1: マイグレーションSQLファイルの生成
  └─ タスク 3.2: マイグレーションの適用確認

Phase 4: テストの実行と動作確認（Phase 1, 2, 3の完了後）
  ├─ タスク 4.1: 既存テストの実行
  ├─ タスク 4.2: サンプルデータ生成コマンドの動作確認
  ├─ タスク 4.3: GoAdmin管理画面の動作確認
  └─ タスク 4.4: ビルドの確認
```

## 注意事項

### 実装時の注意点

1. **integer型の範囲制限**: integer型は通常32ビット（-2,147,483,648 〜 2,147,483,647）または64ビットの範囲を持つ。大量のデータがある場合は注意が必要。

2. **既存データの扱い**: Issue記載により既存データは維持しなくて良い。マイグレーション時に既存データを削除する必要がある場合は、マイグレーションSQLに`TRUNCATE TABLE`または`DELETE FROM`を追加する。

3. **sonyflakeライブラリの扱い**: sonyflakeライブラリは他のテーブル（dm_users、dm_posts）で使用されているため、削除しない。`idgen`パッケージのインポートが不要になった場合のみ削除する（他の関数で使用されていない場合）。

4. **互換性の維持**: 既存のAPIインターフェースは変更しない。既存のデータ構造との互換性を維持する（ただし、既存データは維持しなくて良い）。

### テスト時の注意点

1. **IDの連番確認**: サンプルデータ生成コマンドとGoAdmin管理画面で、生成されたIDが連番になっていることを確認する。

2. **既存テストの確認**: 既存のテストが全て正常に動作することを確認する。テストエラーが発生した場合は、原因を調査して修正する。

3. **ビルドの確認**: ビルドが正常に完了し、コンパイルエラーや警告がないことを確認する。

# 動画ファイルアップロード機能実装タスク一覧

## 概要
動画ファイルアップロード機能の実装を段階的に進めるためのタスク一覧。要件定義書と設計書に基づき、実装可能な粒度でタスクを分解。

## 実装フェーズ

### Phase 1: 設定とインフラの準備

#### - [ ] タスク 1.1: UploadConfig構造体の追加
**目的**: アップロード機能の設定を管理する構造体を追加する

**作業内容**:
- `server/internal/config/config.go`の`Config`構造体に`Upload UploadConfig`フィールドを追加
- `mapstructure:"upload"`タグを追加
- `UploadConfig`構造体を定義:
  - `BasePath string` - TUSエンドポイントのベースパス
  - `MaxFileSize int64` - 最大ファイルサイズ
  - `AllowedExtensions []string` - 許可された拡張子リスト
  - `Storage StorageConfig` - ストレージ設定
- `StorageConfig`構造体を定義:
  - `Type string` - ストレージタイプ（"local" or "s3"）
  - `Local LocalConfig` - ローカルストレージ設定
  - `S3 S3Config` - S3ストレージ設定
- `LocalConfig`構造体を定義:
  - `Path string` - ローカル保存パス
- `S3Config`構造体を定義:
  - `Bucket string` - S3バケット名
  - `Region string` - AWSリージョン

**受け入れ基準**:
- `Config`構造体に`Upload UploadConfig`フィールドが追加されている
- `UploadConfig`、`StorageConfig`、`LocalConfig`、`S3Config`構造体が定義されている
- 既存のコードスタイルに従っている

---

#### - [ ] タスク 1.2: 設定ファイルにアップロード設定を追加
**目的**: 各環境の設定ファイルにアップロード設定を追加する

**作業内容**:
- `config/develop/config.yaml`の`upload`セクションを追加:
  - `base_path: "/api/upload/dm_movie"`
  - `max_file_size: 2147483648` (2GB)
  - `allowed_extensions: ["mp4"]`
  - `storage.type: "local"`
  - `storage.local.path: "./uploads"`
- `config/staging/config.yaml`の`upload`セクションを追加:
  - `base_path: "/api/upload/dm_movie"`
  - `max_file_size: 2147483648` (2GB)
  - `allowed_extensions: ["mp4"]`
  - `storage.type: "s3"`
  - `storage.s3.bucket: "your-bucket-name"`
  - `storage.s3.region: "ap-northeast-1"`
- `config/production/config.yaml.example`の`upload`セクションを追加:
  - 上記と同様の設定（S3設定を含む）

**受け入れ基準**:
- 3つの設定ファイルに`upload`セクションが追加されている
- 設定値が適切に設定されている
- YAML形式が正しい

---

#### - [ ] タスク 1.3: .gitignoreにuploadsディレクトリを追加
**目的**: 開発環境でアップロードされたファイルをGit管理から除外する

**作業内容**:
- `.gitignore`ファイルに`uploads/`を追加
- 既存の`.gitignore`の形式に従う

**受け入れ基準**:
- `.gitignore`に`uploads/`が追加されている
- 既存の`.gitignore`の形式に従っている

---

### Phase 2: ストレージ実装

#### - [ ] タスク 2.1: ローカルファイルストアの実装
**目的**: 開発環境用のローカルファイルシステムストアを実装する

**作業内容**:
- `server/internal/storage/filestore.go`を新規作成
- `LocalFileStore`構造体を定義
- `NewLocalFileStore(path string) (*LocalFileStore, error)`関数を実装:
  - 指定されたパスのディレクトリが存在しない場合は作成
  - `os.MkdirAll`を使用してディレクトリを作成
- `GetStore() handler.DataStore`メソッドを実装:
  - `filestore.FileStore`を作成して返す
  - `Path`フィールドに設定されたパスを設定
- エラーハンドリング: ディレクトリ作成エラーを適切に処理

**受け入れ基準**:
- `LocalFileStore`構造体が定義されている
- `NewLocalFileStore`関数が正しく実装されている
- `GetStore`メソッドが`handler.DataStore`を返す
- ディレクトリが存在しない場合に自動作成される
- エラーハンドリングが適切に実装されている

---

#### - [ ] タスク 2.2: S3ストアの実装
**目的**: 本番環境用のAWS S3ストアを実装する

**作業内容**:
- `server/internal/storage/s3store.go`を新規作成
- `S3FileStore`構造体を定義
- AWS SDK v2を使用してS3クライアントを作成
- `NewS3FileStore(bucket, region string) (*S3FileStore, error)`関数を実装:
  - AWS認証情報は環境変数またはAWS設定から取得
  - S3クライアントを初期化
- `GetStore() handler.DataStore`メソッドを実装:
  - tusdのS3ストアを使用（`github.com/tus/tusd/v2/pkg/s3store`）
  - S3バケットとリージョンを設定
- エラーハンドリング: S3クライアント作成エラーを適切に処理

**受け入れ基準**:
- `S3FileStore`構造体が定義されている
- `NewS3FileStore`関数が正しく実装されている
- `GetStore`メソッドが`handler.DataStore`を返す
- AWS認証情報が正しく取得される
- エラーハンドリングが適切に実装されている

---

#### - [ ] タスク 2.3: ストレージファクトリーの実装
**目的**: 環境に応じて適切なストレージを選択するファクトリーを実装する

**作業内容**:
- `server/internal/storage/factory.go`を新規作成
- `NewFileStore(cfg *config.UploadConfig) (handler.DataStore, error)`関数を実装:
  - `cfg.Storage.Type`に基づいてストレージを選択
  - `"local"`の場合: `NewLocalFileStore`を使用
  - `"s3"`の場合: `NewS3FileStore`を使用
  - それ以外の場合はエラーを返す
- エラーハンドリング: 無効なストレージタイプの場合はエラーを返す

**受け入れ基準**:
- `NewFileStore`関数が正しく実装されている
- 環境に応じて適切なストレージが選択される
- エラーハンドリングが適切に実装されている

---

### Phase 3: TUSハンドラーの基本実装

#### - [ ] タスク 3.1: TUSハンドラーの構造体と初期化関数の実装
**目的**: TUSハンドラーの基本構造を実装する

**作業内容**:
- `server/internal/api/handler/upload_handler.go`を新規作成
- `UploadHandler`構造体を定義:
  - `tusdHandler http.Handler` - tusdハンドラー
  - `config *config.UploadConfig` - アップロード設定
- `NewUploadHandler(cfg *config.UploadConfig) (*UploadHandler, error)`関数を実装:
  - ストレージファクトリーを使用してストレージを取得
  - `handler.NewStoreComposer()`でストアコンポーザーを作成
  - ストレージをストアコンポーザーに登録
  - `handler.NewHandler`でTUSハンドラーを作成
  - `BasePath`を設定
- エラーハンドリング: ストレージ作成エラー、ハンドラー作成エラーを適切に処理

**受け入れ基準**:
- `UploadHandler`構造体が定義されている
- `NewUploadHandler`関数が正しく実装されている
- TUSハンドラーが正しく初期化される
- エラーハンドリングが適切に実装されている

---

#### - [ ] タスク 3.2: TUSエンドポイントの登録
**目的**: EchoルーターにTUSエンドポイントを登録する

**作業内容**:
- `server/internal/api/router/router.go`の`NewRouter`関数を修正
- `RegisterUploadEndpoints(e *echo.Echo, h *handler.UploadHandler) error`関数を実装:
  - TUSハンドラーをEchoルーターに登録
  - `/api/upload/dm_movie`パスでTUSハンドラーをマウント
  - `http.StripPrefix`を使用してパスを処理
- `NewRouter`関数内で`RegisterUploadEndpoints`を呼び出す
- エラーハンドリング: エンドポイント登録エラーを適切に処理

**受け入れ基準**:
- `RegisterUploadEndpoints`関数が正しく実装されている
- TUSエンドポイントがEchoルーターに登録されている
- パスが正しく設定されている
- エラーハンドリングが適切に実装されている

---

### Phase 4: 認証統合

#### - [ ] タスク 4.1: TUSエンドポイントへの認証ミドルウェア適用
**目的**: TUSエンドポイントに認証を適用する

**作業内容**:
- TUSエンドポイントに認証ミドルウェアを適用
- 既存の`auth.NewHumaAuthMiddleware`を使用
- TUSリクエスト（OPTIONS, POST, PATCH, HEAD, DELETE）すべてに認証を適用
- 認証エラー時はHTTP 401 Unauthorizedを返す
- Public API Key JWT または Auth0 JWT を許可

**受け入れ基準**:
- TUSエンドポイントに認証ミドルウェアが適用されている
- 認証なしのリクエストが拒否される
- Public API Key JWT または Auth0 JWT でアクセス可能
- 認証エラー時に適切なHTTPステータスコードが返される

---

### Phase 5: ファイル検証の実装

#### - [ ] タスク 5.1: ファイルサイズ制限の検証
**目的**: アップロード開始前にファイルサイズを検証する

**作業内容**:
- TUS POSTリクエスト時にファイルサイズを検証
- `Upload-Length`ヘッダーからファイルサイズを取得
- 設定された最大ファイルサイズと比較
- 超過している場合はHTTP 413 Payload Too Largeを返す
- エラーメッセージに最大ファイルサイズを含める

**受け入れ基準**:
- ファイルサイズが最大値を超える場合にアップロードが拒否される
- HTTP 413 Payload Too Largeが返される
- エラーメッセージが適切に設定されている

---

#### - [ ] タスク 5.2: ファイル拡張子制限の検証
**目的**: アップロード開始前にファイル拡張子を検証する

**作業内容**:
- TUS POSTリクエスト時にファイル拡張子を検証
- `Upload-Metadata`ヘッダーからファイル名を取得
- ファイル名から拡張子を抽出
- 許可された拡張子リストと比較
- 許可されていない場合はHTTP 400 Bad Requestを返す
- エラーメッセージに許可された拡張子を含める

**受け入れ基準**:
- 許可されていない拡張子の場合にアップロードが拒否される
- HTTP 400 Bad Requestが返される
- エラーメッセージが適切に設定されている

---

### Phase 6: Hook処理の実装

#### - [ ] タスク 6.1: PostFinish Hookの実装
**目的**: アップロード完了時にHook処理を実行する

**作業内容**:
- `hooks.NewHandler()`でHookハンドラーを作成
- `PostFinish`フックを設定:
  - `hookHandler.PostFinish = func(event hooks.HookEvent) { ... }`
  - 現時点では空実装（ログ出力のみ）
  - HookイベントからファイルID、パス、サイズなどの情報を取得
  - エラーが発生してもアップロードは成功とする（ログに記録のみ）
- TUSハンドラーの初期化時にHookハンドラーを設定
- エラーハンドリング: Hook処理のエラーはログに記録するが、アップロードは成功とする

**受け入れ基準**:
- PostFinish Hookが正しく実装されている
- アップロード完了時にHookが実行される
- Hookイベントから情報が取得できる
- Hook処理のエラーがアップロードを妨げない

---

### Phase 7: フロントエンド実装

#### - [ ] タスク 7.1: アップロード画面の基本実装
**目的**: アップロード画面の基本構造を実装する

**作業内容**:
- `client/src/app/dm_movie/upload/page.tsx`を新規作成
- Next.js App Routerのページコンポーネントとして実装
- 基本的なレイアウトとスタイリングを実装
- ページタイトルと説明を表示
- ファイル選択エリアを準備

**受け入れ基準**:
- `/dm_movie/upload`にアクセスできる
- 基本的なレイアウトが表示される
- Next.js App Routerのパターンに従っている

---

#### - [ ] タスク 7.2: uppyライブラリのインストールと設定
**目的**: uppyライブラリをインストールし、基本的な設定を行う

**作業内容**:
- `client/package.json`に必要なパッケージを追加:
  - `@uppy/core`
  - `@uppy/tus`
  - `@uppy/react`
  - `@uppy/dashboard`
- `npm install`を実行
- uppyインスタンスの基本設定:
  - `id`を設定
  - `autoProceed: false`（手動でアップロード開始）
- TUSプラグインの設定:
  - `endpoint: 'http://localhost:8080/api/upload/dm_movie'`
  - `chunkSize: 5 * 1024 * 1024` (5MB)
  - `retryDelays: [0, 1000, 3000, 5000]`

**受け入れ基準**:
- 必要なパッケージがインストールされている
- uppyインスタンスが正しく設定されている
- TUSプラグインが正しく設定されている

---

#### - [ ] タスク 7.3: uppy Dashboardコンポーネントの統合
**目的**: uppy Dashboardをアップロード画面に統合する

**作業内容**:
- `client/src/app/dm_movie/upload/page.tsx`にuppy Dashboardを統合
- `'use client'`ディレクティブを追加（Next.js App Routerのクライアントコンポーネント）
- `useState`でuppyインスタンスを管理
- `useEffect`でuppyインスタンスのクリーンアップを実装
- `Dashboard`コンポーネントを表示
- 必要なCSSをインポート

**受け入れ基準**:
- uppy Dashboardが表示される
- ファイル選択が可能
- アップロード開始が可能
- コンポーネントのクリーンアップが正しく実装されている

---

#### - [ ] タスク 7.4: アップロード進捗表示の実装
**目的**: アップロードの進捗をリアルタイムで表示する

**作業内容**:
- uppyのイベントリスナーを設定:
  - `upload-progress`イベントで進捗を取得
  - `upload-success`イベントで完了を検知
  - `upload-error`イベントでエラーを検知
- 進捗情報を状態管理:
  - 進捗パーセンテージ
  - 転送速度
  - アップロード済みサイズ
- 進捗バーと進捗情報を表示
- エラーメッセージを表示

**受け入れ基準**:
- アップロード進捗がリアルタイムで表示される
- 進捗パーセンテージが正しく表示される
- 転送速度が表示される
- エラーメッセージが適切に表示される

---

#### - [ ] タスク 7.5: 認証トークンの設定
**目的**: TUSリクエストに認証トークンを付与する

**作業内容**:
- uppyのTUSプラグインに認証ヘッダーを設定
- `headers`オプションで`Authorization: Bearer {token}`を設定
- トークンは環境変数`NEXT_PUBLIC_API_KEY`から取得
- または、Auth0から取得したJWTトークンを使用
- すべてのTUSリクエスト（OPTIONS, POST, PATCH, HEAD）に認証ヘッダーを付与

**受け入れ基準**:
- TUSリクエストに認証ヘッダーが付与される
- 認証トークンが正しく設定される
- 認証エラーが適切に処理される

---

### Phase 8: エラーハンドリングとログ記録

#### - [ ] タスク 8.1: サーバー側のエラーハンドリング実装
**目的**: アップロード処理のエラーを適切に処理する

**作業内容**:
- TUSプロトコルエラーの適切な処理
- ストレージエラーの処理（HTTP 500 Internal Server Error）
- ファイル検証エラーの処理（HTTP 400, 413）
- 認証エラーの処理（HTTP 401 Unauthorized）
- エラーログの記録:
  - アップロード開始、完了、エラーをログに記録
  - エラーコンテキストを含める

**受け入れ基準**:
- 各種エラーが適切に処理される
- 適切なHTTPステータスコードが返される
- エラーログが記録される

---

#### - [ ] タスク 8.2: クライアント側のエラーハンドリング実装
**目的**: クライアント側でエラーを適切に処理・表示する

**作業内容**:
- uppyのエラーイベントを処理
- ネットワークエラーの処理と自動リトライ
- 認証エラーの処理（エラーメッセージ表示）
- ファイルサイズ超過エラーの処理
- 拡張子エラーの処理
- ユーザーフレンドリーなエラーメッセージの表示

**受け入れ基準**:
- 各種エラーが適切に処理される
- エラーメッセージがユーザーに表示される
- 自動リトライが機能する

---

### Phase 9: テスト実装

#### - [ ] タスク 9.1: サーバー側の単体テスト実装
**目的**: TUSハンドラーとストレージの単体テストを作成する

**作業内容**:
- `server/internal/api/handler/upload_handler_test.go`を新規作成
- TUSハンドラーの初期化テスト
- ストレージファクトリーのテスト
- ファイルサイズ制限の検証テスト
- ファイル拡張子制限の検証テスト
- `server/internal/storage/filestore_test.go`を新規作成
- ローカルファイルストアのテスト
- `server/internal/storage/s3store_test.go`を新規作成（モック使用）
- S3ストアのテスト

**受け入れ基準**:
- 各コンポーネントの単体テストが実装されている
- テストカバレッジが適切である
- テストが正常に実行される

---

#### - [ ] タスク 9.2: サーバー側の統合テスト実装
**目的**: TUSプロトコルの統合テストを作成する

**作業内容**:
- `server/test/integration/upload_test.go`を新規作成
- TUS OPTIONSリクエストのテスト
- TUS POSTリクエストのテスト（アップロード開始）
- TUS PATCHリクエストのテスト（チャンクアップロード）
- TUS HEADリクエストのテスト（アップロード状態確認）
- 認証統合のテスト
- ファイル検証の統合テスト
- 中断・再開機能のテスト

**受け入れ基準**:
- TUSプロトコルの各リクエストが正しく動作する
- 認証が正しく機能する
- ファイル検証が正しく機能する
- 中断・再開機能が正しく動作する

---

#### - [ ] タスク 9.3: クライアント側の単体テスト実装
**目的**: アップロード画面の単体テストを作成する

**作業内容**:
- `client/src/app/dm_movie/upload/__tests__/page.test.tsx`を新規作成
- コンポーネントのレンダリングテスト
- uppyインスタンスの初期化テスト
- エラー表示のテスト
- React Testing Libraryを使用

**受け入れ基準**:
- コンポーネントの単体テストが実装されている
- テストが正常に実行される

---

#### - [ ] タスク 9.4: E2Eテスト実装
**目的**: アップロード機能のE2Eテストを作成する

**作業内容**:
- `client/e2e/movie-upload.spec.ts`を新規作成
- アップロード成功シナリオのテスト:
  - ファイル選択
  - アップロード開始
  - 進捗表示
  - アップロード完了
- 中断・再開シナリオのテスト:
  - アップロード中断
  - 再開
  - 完了
- エラーシナリオのテスト:
  - ファイルサイズ超過
  - 拡張子エラー
  - 認証エラー
- Playwrightを使用

**受け入れ基準**:
- E2Eテストが実装されている
- 主要なシナリオがカバーされている
- テストが正常に実行される

---

### Phase 10: 統合と最終確認

#### - [ ] タスク 10.1: 開発環境での動作確認
**目的**: 開発環境でアップロード機能が正常に動作することを確認する

**作業内容**:
- APIサーバーとクライアントサーバーを起動
- アップロード画面にアクセス
- 小さいファイル（10MB程度）でアップロードテスト
- 進捗表示が正しく動作することを確認
- アップロード完了を確認
- ローカルファイルシステムにファイルが保存されることを確認

**受け入れ基準**:
- アップロードが正常に動作する
- 進捗表示が正しく表示される
- ファイルが正しく保存される

---

#### - [ ] タスク 10.2: 中断・再開機能の動作確認
**目的**: アップロードの中断・再開機能が正常に動作することを確認する

**作業内容**:
- 大きなファイル（100MB程度）でアップロード開始
- アップロード中にネットワークを切断（またはブラウザを閉じる）
- 再度アップロード画面にアクセス
- 同じファイルを選択してアップロード再開
- 最後に成功したチャンクから再開されることを確認
- アップロード完了を確認

**受け入れ基準**:
- アップロードが中断できる
- アップロードが再開できる
- 最後に成功したチャンクから再開される

---

#### - [ ] タスク 10.3: ファイル検証の動作確認
**目的**: ファイルサイズ制限と拡張子制限が正常に動作することを確認する

**作業内容**:
- 最大ファイルサイズを超えるファイルでアップロードを試行
- HTTP 413 Payload Too Largeが返されることを確認
- 許可されていない拡張子のファイルでアップロードを試行
- HTTP 400 Bad Requestが返されることを確認
- 許可された拡張子のファイルでアップロードを試行
- 正常にアップロードされることを確認

**受け入れ基準**:
- ファイルサイズ制限が正しく機能する
- 拡張子制限が正しく機能する
- エラーメッセージが適切に表示される

---

#### - [ ] タスク 10.4: 認証の動作確認
**目的**: 認証が正常に機能することを確認する

**作業内容**:
- 認証なしでTUSリクエストを送信
- HTTP 401 Unauthorizedが返されることを確認
- Public API Key JWTでアップロードを試行
- 正常にアップロードされることを確認
- Auth0 JWTでアップロードを試行
- 正常にアップロードされることを確認

**受け入れ基準**:
- 認証なしのリクエストが拒否される
- Public API Key JWTでアクセス可能
- Auth0 JWTでアクセス可能

---

#### - [ ] タスク 10.5: 既存テストの動作確認
**目的**: 既存のテストが全て正常に動作することを確認する

**作業内容**:
- 既存のユニットテストを実行
- 既存の統合テストを実行
- 既存のE2Eテストを実行
- 全てのテストが正常に実行されることを確認

**受け入れ基準**:
- 既存のテストが全て正常に実行される
- 新規実装による既存機能への影響がない

---

## 要件への対応

### Requirement 1: 動画ファイルアップロード機能の提供
- タスク 3.1, 3.2: TUSハンドラーの実装
- タスク 7.1-7.4: フロントエンド実装
- タスク 9.1-9.4: テスト実装

### Requirement 2: フロントエンドアップロードUIの実装
- タスク 7.1-7.4: アップロード画面の実装

### Requirement 3: バックエンドTUSプロトコルサポート
- タスク 3.1, 3.2: TUSハンドラーの実装
- タスク 9.2: 統合テスト

### Requirement 4: ファイル保存先の環境別対応
- タスク 2.1-2.3: ストレージ実装
- タスク 1.2: 設定ファイルの追加

### Requirement 5: アップロード完了時のHook処理
- タスク 6.1: PostFinish Hookの実装

### Requirement 6: 認証・認可の実装
- タスク 4.1: 認証ミドルウェアの適用
- タスク 7.5: 認証トークンの設定

### Requirement 7: ファイルサイズ制限と拡張子制限の実装
- タスク 5.1: ファイルサイズ制限の検証
- タスク 5.2: ファイル拡張子制限の検証

### Requirement 8: エラーハンドリングとログ記録
- タスク 8.1: サーバー側のエラーハンドリング
- タスク 8.2: クライアント側のエラーハンドリング

### Requirement 9: ファイル検証の実施
- 要件定義書では「コード上での実装は不要」とされているため、タスクには含めない

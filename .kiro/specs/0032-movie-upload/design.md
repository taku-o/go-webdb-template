# 動画ファイルアップロード機能設計書

## 1. 概要

### 1.1 設計の目的
要件定義書に基づき、大容量動画ファイルのアップロード機能の詳細設計を定義する。TUSプロトコルを使用してアップロードの中断と再開をサポートし、クライアント側とAPIサーバー側の両方で適切に動作するシステムを構築する。

### 1.2 設計の範囲
- クライアント側: アップロード画面の実装、TUSクライアントの設定、進捗表示機能
- APIサーバー側: TUSエンドポイントの実装、ファイルストレージの実装、Hook処理の実装
- 認証・認可: Public API Key JWT または Auth0 JWT による認証
- ファイル検証: ファイルサイズ制限と拡張子制限の実装
- エラーハンドリング: クライアント側とサーバー側のエラーハンドリング
- テスト: 単体テストとE2Eテストの実装

### 1.3 設計方針
- **TUSプロトコルの採用**: 大容量ファイルの中断・再開をサポートするTUSプロトコルを使用
- **既存システムとの統合**: 既存のHuma API、Echo、Next.jsのパターンに従う
- **環境別ストレージ対応**: 開発環境ではローカルファイルシステム、本番環境ではAWS S3を使用
- **認証の統合**: 既存の認証ミドルウェアを使用してTUSエンドポイントを保護
- **拡張性の確保**: 将来的なアップロード完了状態の表示などに対応できるHookシステムを実装

## 2. アーキテクチャ設計

### 2.1 ディレクトリ構造

#### 2.1.1 変更前の構造
```
client/
├── src/
│   ├── app/
│   │   └── (既存のページ)
│   └── lib/
│       └── api.ts                      # APIクライアント（アップロード機能なし）

server/
├── internal/
│   ├── api/
│   │   ├── handler/
│   │   │   └── (既存のハンドラー)
│   │   └── router/
│   │       └── router.go
│   └── config/
│       └── config.go
```

#### 2.1.2 変更後の構造
```
client/
├── src/
│   ├── app/
│   │   └── dm_movie/
│   │       └── upload/
│   │           └── page.tsx            # アップロード画面（新規作成）
│   └── lib/
│       └── api.ts                      # 変更なし（TUSは直接接続）

server/
├── internal/
│   ├── api/
│   │   ├── handler/
│   │   │   └── upload_handler.go       # TUSハンドラー（新規作成）
│   │   └── router/
│   │       └── router.go               # TUSエンドポイント登録追加
│   ├── config/
│   │   └── config.go                    # UploadConfig追加
│   └── storage/
│       ├── filestore.go                 # ローカルファイルストア（新規作成）
│       └── s3store.go                   # S3ストア（新規作成）
├── cmd/
│   └── server/
│       └── main.go                     # 変更なし
└── config/
    ├── develop/
    │   └── config.yaml                  # upload設定追加
    ├── staging/
    │   └── config.yaml                  # upload設定追加
    └── production/
        └── config.yaml.example          # upload設定追加
```

### 2.2 ファイル構成

#### 2.2.1 変更ファイル
- **サーバー側**:
  - `server/internal/api/router/router.go`: TUSエンドポイントの登録を追加
  - `server/internal/config/config.go`: `UploadConfig`構造体を追加
  - `config/develop/config.yaml`: アップロード設定を追加
  - `config/staging/config.yaml`: アップロード設定を追加
  - `config/production/config.yaml.example`: アップロード設定を追加

#### 2.2.2 新規作成ファイル
- **クライアント側**:
  - `client/src/app/dm_movie/upload/page.tsx`: アップロード画面
- **サーバー側**:
  - `server/internal/api/handler/upload_handler.go`: TUSハンドラー
  - `server/internal/storage/filestore.go`: ローカルファイルストアラッパー
  - `server/internal/storage/s3store.go`: S3ストアラッパー

### 2.3 システム構成図

```
┌─────────────────────────────────────────────────────────┐
│              クライアント（Next.js）                      │
│  ┌──────────────────────────────────────────────────┐  │
│  │  dm_movie/upload/page.tsx                       │  │
│  │  - uppy または tus-js-client                    │  │
│  │  - ファイル選択、進捗表示                          │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                    │
│                     │ TUS Protocol                      │
│                     │ (OPTIONS, POST, PATCH, HEAD)      │
│                     ▼                                    │
└─────────────────────┼──────────────────────────────────┘
                    │ HTTP
                    │ /api/upload/dm_movie
                    │ Authorization: Bearer {JWT}
                    ▼
┌─────────────────────────────────────────────────────────┐
│              APIサーバー（Go + Echo + tusd）               │
│  ┌──────────────────────────────────────────────────┐  │
│  │  router.go                                      │  │
│  │  - TUSエンドポイント登録                          │  │
│  │  - 認証ミドルウェア適用                           │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                    │
│                     ▼                                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │  upload_handler.go                               │  │
│  │  - tusd handler.NewHandler()                     │  │
│  │  - Hook処理（PostFinish）                         │  │
│  │  - ファイルサイズ・拡張子検証                      │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                    │
│                     ▼                                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │  storage/filestore.go または storage/s3store.go │  │
│  │  - 開発環境: ローカルファイルシステム              │  │
│  │  - 本番環境: AWS S3                              │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                    │
│                     ▼                                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │  ストレージ                                        │  │
│  │  - 開発: ./uploads/                              │  │
│  │  - 本番: AWS S3 Bucket                          │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.4 データフロー

#### 2.4.1 アップロードフロー
```
1. ユーザーがアップロード画面でファイルを選択
    ↓
2. uppy/tus-js-clientがTUS OPTIONSリクエストを送信
    ↓
3. APIサーバー側で認証チェック（public API）
    ↓
4. tusd handlerがTUSプロトコル機能を返す
    ↓
5. クライアントがTUS POSTリクエストでアップロード開始
    ↓
6. サーバー側でファイルサイズ・拡張子検証
    ↓
7. サーバーがアップロードリソースを作成し、URLを返す
    ↓
8. クライアントが5MBチャンクでTUS PATCHリクエストを送信
    ↓
9. サーバーがチャンクを受信してストレージに保存
    ↓
10. アップロード完了時にPostFinish Hookが実行
    ↓
11. クライアントにアップロード完了を通知
```

## 3. コンポーネント設計

### 3.1 クライアント側コンポーネント

#### 3.1.1 アップロード画面（dm_movie/upload/page.tsx）

**責任と境界**
- **主要責任**: ファイルアップロードUIの提供、アップロード進捗の表示、エラー表示
- **ドメイン境界**: フロントエンドUI層
- **データ所有**: アップロード状態（進捗、エラー、完了状態）

**依存関係**
- **インバウンド**: なし（ページコンポーネント）
- **アウトバウンド**: uppy または tus-js-client ライブラリ
- **外部**: TUSエンドポイント（`/api/upload/dm_movie`）

**インターフェース設計**

```typescript
// コンポーネント構造
export default function MovieUploadPage() {
  // uppy または tus-js-client の初期化
  // アップロード進捗の状態管理
  // エラー表示
  // ファイル選択UI
}
```

**主要機能**
- uppy または tus-js-client の初期化と設定
- TUSエンドポイントの設定（`http://localhost:8080/api/upload/dm_movie`）
- チャンクサイズの設定（5MB）
- リトライ遅延の設定（[0, 1000, 3000, 5000] ms）
- アップロード進捗のリアルタイム表示
- エラーメッセージの表示
- アップロード完了時の通知表示

### 3.2 サーバー側コンポーネント

#### 3.2.1 TUSハンドラー（upload_handler.go）

**責任と境界**
- **主要責任**: TUSプロトコルの実装、ファイルアップロードの処理、Hook処理の実行
- **ドメイン境界**: API層
- **データ所有**: アップロードセッション情報、ファイルメタデータ

**依存関係**
- **インバウンド**: router.go（エンドポイント登録）
- **アウトバウンド**: tusdライブラリ、storageパッケージ、authパッケージ
- **外部**: ストレージ（ローカルファイルシステムまたはAWS S3）

**インターフェース設計**

```go
// UploadHandler はファイルアップロードAPIのハンドラー
type UploadHandler struct {
    tusdHandler http.Handler
    hookHandler *hooks.Handler
    config      *config.UploadConfig
}

// NewUploadHandler は新しいUploadHandlerを作成
func NewUploadHandler(cfg *config.UploadConfig) (*UploadHandler, error)

// RegisterUploadEndpoints はTUSエンドポイントを登録
func RegisterUploadEndpoints(e *echo.Echo, h *UploadHandler) error
```

**主要機能**
- tusd handlerの初期化と設定
- TUSプロトコル（OPTIONS, POST, PATCH, HEAD, DELETE）の処理
- ファイルサイズ制限の検証
- ファイル拡張子制限の検証
- PostFinish Hookの設定と実行
- 認証ミドルウェアとの統合

#### 3.2.2 ファイルストレージ（storage/filestore.go, storage/s3store.go）

**責任と境界**
- **主要責任**: ファイルストレージの抽象化、環境別ストレージ実装の提供
- **ドメイン境界**: インフラストラクチャ層
- **データ所有**: アップロードされたファイル

**依存関係**
- **インバウンド**: upload_handler.go
- **アウトバウンド**: tusd filestore、AWS S3 SDK（本番環境）
- **外部**: ローカルファイルシステム、AWS S3

**インターフェース設計**

```go
// FileStore はファイルストレージのインターフェース
type FileStore interface {
    GetStore() handler.DataStore
}

// LocalFileStore はローカルファイルシステムストア
type LocalFileStore struct {
    path string
}

// S3FileStore はAWS S3ストア
type S3FileStore struct {
    bucket string
    region string
    // AWS認証情報
}
```

**主要機能**
- 開発環境: ローカルファイルシステムへの保存
- 本番環境: AWS S3への保存
- ストレージの初期化と設定
- tusd DataStoreインターフェースの実装

#### 3.2.3 設定管理（config/config.go）

**責任と境界**
- **主要責任**: アップロード機能の設定管理
- **ドメイン境界**: 設定層
- **データ所有**: アップロード設定値

**依存関係**
- **インバウンド**: upload_handler.go
- **アウトバウンド**: viper（設定ファイル読み込み）

**インターフェース設計**

```go
// UploadConfig はアップロード機能の設定
type UploadConfig struct {
    BasePath        string        `mapstructure:"base_path"`
    MaxFileSize     int64         `mapstructure:"max_file_size"`
    AllowedExtensions []string    `mapstructure:"allowed_extensions"`
    Storage         StorageConfig `mapstructure:"storage"`
}

// StorageConfig はストレージ設定
type StorageConfig struct {
    Type   string      `mapstructure:"type"` // "local" or "s3"
    Local  LocalConfig `mapstructure:"local"`
    S3     S3Config    `mapstructure:"s3"`
}

// LocalConfig はローカルストレージ設定
type LocalConfig struct {
    Path string `mapstructure:"path"`
}

// S3Config はS3ストレージ設定
type S3Config struct {
    Bucket string `mapstructure:"bucket"`
    Region string `mapstructure:"region"`
    // AWS認証情報は環境変数から取得
}
```

## 4. データモデル

### 4.1 アップロードセッション情報

TUSプロトコルでは、アップロードセッション情報はtusdライブラリが管理します。アプリケーション側で明示的なデータモデルは不要ですが、以下の情報が利用可能です：

- **Upload ID**: TUSプロトコルで生成される一意のアップロードID
- **File Size**: アップロードされるファイルのサイズ
- **Upload Offset**: 現在のアップロードオフセット（再開時に使用）
- **Metadata**: ファイル名、コンテンツタイプなどのメタデータ

### 4.2 Hookイベント情報

PostFinish Hookで取得可能な情報：

```go
// hooks.HookEvent の構造（tusdライブラリが提供）
type HookEvent struct {
    Upload UploadInfo
    HTTPRequest RequestInfo
}

type UploadInfo struct {
    ID     string
    Size   int64
    Offset int64
    MetaData map[string]string
    Storage map[string]interface{}
}
```

## 5. エラーハンドリング

### 5.1 エラー戦略

#### 5.1.1 クライアント側エラー
- **ネットワークエラー**: 自動リトライ（指数バックオフ）
- **認証エラー**: エラーメッセージを表示し、ログイン画面へリダイレクト
- **ファイルサイズ超過**: エラーメッセージを表示
- **拡張子エラー**: エラーメッセージを表示

#### 5.1.2 サーバー側エラー
- **認証エラー**: HTTP 401 Unauthorized
- **ファイルサイズ超過**: HTTP 413 Payload Too Large
- **拡張子エラー**: HTTP 400 Bad Request
- **ストレージエラー**: HTTP 500 Internal Server Error
- **TUSプロトコルエラー**: TUSプロトコルに準拠したエラーレスポンス

### 5.2 エラーカテゴリとレスポンス

**ユーザーエラー（4xx）**
- **400 Bad Request**: 無効なリクエスト、拡張子エラー
- **401 Unauthorized**: 認証エラー
- **413 Payload Too Large**: ファイルサイズ超過
- **415 Unsupported Media Type**: サポートされていないファイルタイプ

**システムエラー（5xx）**
- **500 Internal Server Error**: ストレージエラー、予期しないエラー
- **503 Service Unavailable**: ストレージサービスが利用不可

**TUSプロトコルエラー**
- **409 Conflict**: アップロードオフセットの不一致
- **410 Gone**: アップロードリソースが削除された
- **460 Checksum Mismatch**: チェックサムの不一致（将来の拡張）

### 5.3 モニタリング

- **ログ記録**: アップロード開始、完了、エラーをログに記録
- **メトリクス**: アップロード成功率、平均アップロード時間、エラー率
- **アラート**: ストレージエラー、認証エラーの増加時にアラート

## 6. テスト戦略

### 6.1 ユニットテスト

#### 6.1.1 サーバー側
- **upload_handler.go**: TUSハンドラーの初期化テスト、Hook処理のテスト
- **storage/filestore.go**: ローカルファイルストアのテスト
- **storage/s3store.go**: S3ストアのテスト（モック使用）
- **ファイル検証**: ファイルサイズ制限、拡張子制限のテスト

#### 6.1.2 クライアント側
- **dm_movie/upload/page.tsx**: コンポーネントのレンダリングテスト
- **uppy/tus-js-client設定**: 設定の検証テスト

### 6.2 統合テスト

#### 6.2.1 サーバー側
- **TUSプロトコル統合**: OPTIONS, POST, PATCH, HEADリクエストのテスト
- **認証統合**: Public API Key JWT、Auth0 JWTの認証テスト
- **ストレージ統合**: ローカルファイルシステムへの保存テスト
- **Hook処理**: PostFinish Hookの実行テスト

#### 6.2.2 クライアント側
- **アップロードフロー**: ファイル選択からアップロード完了までのテスト
- **エラーハンドリング**: ネットワークエラー、認証エラーのテスト
- **進捗表示**: アップロード進捗の表示テスト

### 6.3 E2Eテスト

- **アップロード成功シナリオ**: ファイル選択 → アップロード → 完了通知
- **中断・再開シナリオ**: アップロード中断 → 再開 → 完了
- **エラーシナリオ**: ファイルサイズ超過、拡張子エラー、認証エラー
- **大容量ファイルアップロード**: 100MB以上のファイルのアップロードテスト

## 7. セキュリティ考慮事項

### 7.1 認証・認可

- **認証方式**: Public API Key JWT または Auth0 JWT
- **認証チェック**: TUSエンドポイントへの全リクエストで認証を要求
- **認証ミドルウェア**: 既存のauth.NewHumaAuthMiddlewareを使用

### 7.2 ファイル検証

- **ファイルサイズ制限**: 設定可能な最大ファイルサイズを超えるファイルを拒否
- **拡張子制限**: 許可された拡張子のみアップロード可能
- **ファイル検証**: 本番環境ではAWSの機能を使用（コード実装は不要）

### 7.3 ストレージセキュリティ

- **開発環境**: ローカルファイルシステムへの保存、`.gitignore`に追加
- **本番環境**: AWS S3への保存、適切なIAM権限の設定
- **ファイルアクセス制御**: アップロードされたファイルへの直接アクセスを制限

### 7.4 入力検証

- **メタデータ検証**: ファイル名、コンテンツタイプなどのメタデータの検証
- **パス操作攻撃対策**: ファイルパスの検証とサニタイゼーション

## 8. パフォーマンスとスケーラビリティ

### 8.1 パフォーマンス

- **チャンクサイズ**: 5MBチャンクで効率的なアップロード
- **並列アップロード**: 現時点では1ファイルずつ（将来的な拡張項目）
- **ストレージ最適化**: ローカルファイルシステムとS3の最適化

### 8.2 スケーラビリティ

- **水平スケーリング**: 複数のAPIサーバーインスタンスで動作可能
- **ストレージスケーリング**: AWS S3の自動スケーリング機能を活用
- **負荷分散**: ロードバランサー経由での複数インスタンスへの分散

## 9. 技術スタックと設計決定

### 9.1 技術スタック

#### 9.1.1 フロントエンド
- **ライブラリ**: uppy または tus-js-client
- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript 5+

#### 9.1.2 バックエンド
- **ライブラリ**: `github.com/tus/tusd/v2/pkg/handler`
- **言語**: Go 1.21+
- **プロトコル**: TUS (Resumable Upload Protocol)
- **ストレージ**: ローカルファイルシステム（開発）、AWS S3（本番）

### 9.2 主要な設計決定

#### 決定1: TUSプロトコルの採用
- **コンテキスト**: 大容量ファイルのアップロードで中断・再開機能が必要
- **代替案**: 
  1. 通常のHTTP POST（中断・再開不可）
  2. カスタムプロトコル（実装コストが高い）
- **選択アプローチ**: TUSプロトコルを使用（標準化されたプロトコル、tusdライブラリが利用可能）
- **根拠**: 中断・再開機能を標準化された方法で実現、実装コストが低い
- **トレードオフ**: TUSプロトコルの学習コスト vs カスタム実装の開発・保守コスト

#### 決定2: 環境別ストレージ対応
- **コンテキスト**: 開発環境と本番環境で異なるストレージが必要
- **代替案**:
  1. 常にS3を使用（開発環境でもS3が必要）
  2. 常にローカルファイルシステム（本番環境でスケーラビリティの問題）
- **選択アプローチ**: 環境に応じてストレージを切り替え（開発: ローカル、本番: S3）
- **根拠**: 開発環境での簡易性と本番環境でのスケーラビリティを両立
- **トレードオフ**: ストレージ抽象化の実装コスト vs 環境別最適化の利点

#### 決定3: Hookシステムの採用
- **コンテキスト**: アップロード完了時の処理が必要（将来的にアップロード完了状態の表示など）
- **代替案**:
  1. NotifyCompleteUrls（外部URLへの通知）
  2. ポーリング（定期的な状態確認）
- **選択アプローチ**: tusdのHookシステム（PostFinishフック）を使用
- **根拠**: アプリケーション内で処理を実行可能、将来的な拡張に対応しやすい
- **トレードオフ**: Hook処理の実装コスト vs 将来の拡張性

## 10. 実装上の注意事項

### 10.1 TUSプロトコルの実装

- **BasePath**: `/api/upload/dm_movie` をベースパスとして使用
- **CORS設定**: TUSエンドポイントでもCORSを有効化
- **認証統合**: TUSリクエストでも認証ミドルウェアを適用

### 10.2 ストレージ実装

- **開発環境**: `./uploads` ディレクトリに保存、`.gitignore`に追加
- **本番環境**: AWS S3バケットに保存、適切なIAM権限を設定
- **ファイル名**: 元のファイル名を保持、衝突時は一意な名前を生成

### 10.3 Hook処理

- **PostFinish Hook**: アップロード完了時に実行、現時点では空実装
- **エラーハンドリング**: Hook処理のエラーはログに記録するが、アップロードは成功とする
- **将来の拡張**: アップロード完了状態の表示などに使用予定

### 10.4 ファイル検証

- **ファイルサイズ**: 設定可能な最大ファイルサイズを超えるファイルを拒否
- **拡張子**: 許可された拡張子のみアップロード可能（動画ファイル形式を想定）
- **検証タイミング**: TUS POSTリクエスト時（アップロード開始前）に検証

## 11. 将来の拡張性

### 11.1 アップロード完了状態の表示

PostFinish Hookを使用して、アップロード完了状態をデータベースに保存し、クライアント側で表示可能にする。

### 11.2 複数ファイルの同時アップロード（並列アップロード）

**対応しない理由**: 対象が動画ファイルで巨大であるため、並列アップロード（Aファイル＋Bファイル＋Cファイルを同時にアップロード）には対応しません。1ファイルずつ順次アップロード（Aファイル→Bファイル→Cファイル）する想定です。

**技術的な実現可能性**: TUSプロトコル自体は複数の同時アップロードをサポートしており、各アップロードセッションは独立したUpload IDを持つため、技術的には複数のアップロードを並列に処理可能です。サーバー側（tusdライブラリ）は既に複数の同時アップロードを処理できます。ただし、動画ファイルのような巨大ファイルを複数同時にアップロードすることは、ネットワーク帯域やサーバーリソースの観点から推奨されないため、本機能では対応しません。

### 11.3 アップロード履歴の管理

アップロードされたファイルの履歴をデータベースに保存し、一覧表示や削除機能を追加可能。

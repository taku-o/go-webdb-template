# Atlas導入実装タスク一覧

## 概要
Atlas導入の実装を段階的に進めるためのタスク一覧。要件定義書と設計書に基づき、実装可能な粒度でタスクを分解。

## 実装フェーズ

### Phase 1: ディレクトリ構造と初期設定

#### - [ ] タスク 1.1: スキーマ定義ディレクトリの作成
**目的**: Atlasスキーマ定義ファイル用のディレクトリを作成

**作業内容**:
- `db/schema/`ディレクトリを作成
- ディレクトリ構造を確認

**受け入れ基準**:
- `db/schema/`ディレクトリが存在する

---

#### - [ ] タスク 1.2: Atlasマイグレーションディレクトリの初期化
**目的**: Atlasマイグレーションファイル用のディレクトリを初期化

**作業内容**:
- `atlas migrate init --dir db/migrations/master`を実行
- `atlas migrate init --dir db/migrations/sharding`を実行
- 生成されたファイルを確認

**受け入れ基準**:
- `db/migrations/master/`ディレクトリが初期化されている
- `db/migrations/sharding/`ディレクトリが初期化されている
- Atlasの初期化ファイルが生成されている

---

### Phase 2: スキーマ定義ファイルの作成

#### - [ ] タスク 2.1: マスターデータベーススキーマ定義ファイルの作成（newsテーブル）
**目的**: newsテーブルのスキーマ定義をHCL形式で作成

**作業内容**:
- `db/schema/master.hcl`を作成
- `news`テーブルの定義を追加
  - カラム: id, title, content, author_id, published_at, created_at, updated_at
  - プライマリキー: id
  - インデックス: idx_news_published_at, idx_news_author_id
- 既存の`db/migrations/master/001_init.sql`を参考に定義

**受け入れ基準**:
- `db/schema/master.hcl`が作成されている
- `news`テーブルの定義が正しく記述されている
- HCL形式の構文エラーがない

---

#### - [ ] タスク 2.2: マスターデータベーススキーマ定義ファイルの作成（GoAdmin関連テーブル）
**目的**: GoAdmin関連テーブルのスキーマ定義をHCL形式で作成

**作業内容**:
- `db/schema/master.hcl`にGoAdmin関連テーブルの定義を追加
  - goadmin_menu
  - goadmin_operation_log
  - goadmin_site
  - goadmin_permissions
  - goadmin_roles
  - goadmin_role_menu
  - goadmin_role_permissions
  - goadmin_role_users
  - goadmin_session
  - goadmin_user_permissions
  - goadmin_users
- 既存の`db/migrations/master/002_goadmin.sql`を参考に定義
- インデックスと外部キー制約を適切に定義

**受け入れ基準**:
- すべてのGoAdmin関連テーブルが定義されている
- インデックスと外部キー制約が適切に定義されている
- HCL形式の構文エラーがない

---

#### - [ ] タスク 2.3: マスターデータベーススキーマ定義ファイルの作成（その他のテーブル）
**目的**: その他のマスターデータベーステーブルのスキーマ定義を追加

**作業内容**:
- `db/schema/master.hcl`にその他のテーブル定義を追加
  - 既存の`db/migrations/master/003_menu.sql`を参考
  - 既存の`db/migrations/master/004_api_key_menu.sql`を参考
- すべてのテーブル定義を確認

**受け入れ基準**:
- すべてのマスターデータベーステーブルが定義されている
- HCL形式の構文エラーがない

---

#### - [ ] タスク 2.4: シャーディングデータベーススキーマ定義ファイルの作成（usersテーブル）
**目的**: usersテーブル（32分割）のスキーマ定義をHCL形式で作成

**作業内容**:
- `db/schema/sharding.hcl`を作成
- `users_000` ～ `users_031`の32テーブルを定義
  - カラム: id, name, email, created_at, updated_at
  - プライマリキー: id
  - インデックス: idx_users_{suffix}_email (UNIQUE)
- 既存の`db/migrations/sharding/templates/users.sql.template`を参考に定義

**受け入れ基準**:
- `db/schema/sharding.hcl`が作成されている
- 32個のusersテーブルが定義されている
- HCL形式の構文エラーがない

---

#### - [ ] タスク 2.5: シャーディングデータベーススキーマ定義ファイルの作成（postsテーブル）
**目的**: postsテーブル（32分割）のスキーマ定義をHCL形式で作成

**作業内容**:
- `db/schema/sharding.hcl`に`posts_000` ～ `posts_031`の32テーブルを定義
  - カラム: id, user_id, title, content, created_at, updated_at
  - プライマリキー: id
  - 外部キー: fk_posts_{suffix}_user_id (user_id → users_{suffix}.id, ON DELETE CASCADE)
  - インデックス: idx_posts_{suffix}_user_id, idx_posts_{suffix}_created_at
- 既存の`db/migrations/sharding/templates/posts.sql.template`を参考に定義

**受け入れ基準**:
- 32個のpostsテーブルが定義されている
- 外部キー制約が適切に定義されている
- HCL形式の構文エラーがない

---

#### - [ ] タスク 2.6: スキーマ定義ファイルの検証
**目的**: 作成したスキーマ定義ファイルの構文と内容を検証

**作業内容**:
- `atlas schema validate --schema file://db/schema/master.hcl`を実行
- `atlas schema validate --schema file://db/schema/sharding.hcl`を実行
- エラーがあれば修正

**受け入れ基準**:
- スキーマ定義ファイルの検証が成功する
- 構文エラーがない
- スキーマ定義が正しい

---

### Phase 3: 環境別設定ファイルの作成

#### - [ ] タスク 3.1: 開発環境用Atlas設定ファイルの作成
**目的**: 開発環境用のAtlas設定ファイルを作成

**作業内容**:
- `config/develop/atlas.hcl`を作成
- マスターデータベース用の設定を追加
  - データソース: SQLite (`./server/data/master.db`)
  - マイグレーションディレクトリ: `file://db/migrations/master`
- シャーディングデータベース用の設定を追加
  - データソース: SQLite (`./server/data/sharding_db_*.db`)
  - マイグレーションディレクトリ: `file://db/migrations/sharding`

**受け入れ基準**:
- `config/develop/atlas.hcl`が作成されている
- マスターデータベースとシャーディングデータベースの設定が正しく記述されている
- HCL形式の構文エラーがない

---

#### - [ ] タスク 3.2: ステージング環境用Atlas設定ファイルの作成
**目的**: ステージング環境用のAtlas設定ファイルを作成

**作業内容**:
- `config/staging/atlas.hcl`を作成
- マスターデータベース用の設定を追加
  - データソース: PostgreSQL/MySQL
  - マイグレーションディレクトリ: `file://db/migrations/master`
- シャーディングデータベース用の設定を追加
  - データソース: PostgreSQL/MySQL
  - マイグレーションディレクトリ: `file://db/migrations/sharding`

**受け入れ基準**:
- `config/staging/atlas.hcl`が作成されている
- マスターデータベースとシャーディングデータベースの設定が正しく記述されている
- HCL形式の構文エラーがない

---

#### - [ ] タスク 3.3: 本番環境用Atlas設定ファイルの作成
**目的**: 本番環境用のAtlas設定ファイルを作成

**作業内容**:
- `config/production/atlas.hcl`を作成
- マスターデータベース用の設定を追加
  - データソース: PostgreSQL/MySQL
  - マイグレーションディレクトリ: `file://db/migrations/master`
- シャーディングデータベース用の設定を追加
  - データソース: PostgreSQL/MySQL
  - マイグレーションディレクトリ: `file://db/migrations/sharding`

**受け入れ基準**:
- `config/production/atlas.hcl`が作成されている
- マスターデータベースとシャーディングデータベースの設定が正しく記述されている
- HCL形式の構文エラーがない

---

### Phase 4: 初期マイグレーションの生成と適用

#### - [ ] タスク 4.1: マスターデータベースの初期マイグレーション生成
**目的**: マスターデータベースの初期マイグレーションファイルを生成

**作業内容**:
- `atlas migrate diff`コマンドを実行して初期マイグレーションを生成
  - `--dir file://db/migrations/master`
  - `--to file://db/schema/master.hcl`
  - `--dev-url sqlite://./server/data/master.db`
- 生成されたマイグレーションファイルを確認

**受け入れ基準**:
- 初期マイグレーションファイルが生成されている
- マイグレーションファイルの内容が正しい

---

#### - [ ] タスク 4.2: シャーディングデータベースの初期マイグレーション生成
**目的**: シャーディングデータベースの初期マイグレーションファイルを生成

**作業内容**:
- `atlas migrate diff`コマンドを実行して初期マイグレーションを生成
  - `--dir file://db/migrations/sharding`
  - `--to file://db/schema/sharding.hcl`
  - `--dev-url sqlite://./server/data/sharding_db_1.db`
- 生成されたマイグレーションファイルを確認

**受け入れ基準**:
- 初期マイグレーションファイルが生成されている
- マイグレーションファイルの内容が正しい

---

#### - [ ] タスク 4.3: 開発環境でのマスターデータベースマイグレーション適用
**目的**: 開発環境でマスターデータベースにマイグレーションを適用

**作業内容**:
- 既存のデータベースファイルを削除（必要に応じて）
- `atlas migrate apply`コマンドを実行
  - `--dir file://db/migrations/master`
  - `--url sqlite://./server/data/master.db`
- マイグレーション適用結果を確認
- データベースのテーブル構造を確認

**受け入れ基準**:
- マイグレーションが正常に適用される
- すべてのテーブルが正しく作成されている
- マイグレーション履歴が記録されている

---

#### - [ ] タスク 4.4: 開発環境でのシャーディングデータベースマイグレーション適用
**目的**: 開発環境でシャーディングデータベース（4つ）にマイグレーションを適用

**作業内容**:
- 既存のデータベースファイルを削除（必要に応じて）
- 4つのシャーディングデータベースに対して`atlas migrate apply`を実行
  - `sharding_db_1.db` ～ `sharding_db_4.db`
- マイグレーション適用結果を確認
- 各データベースのテーブル構造を確認（32分割テーブルが正しく作成されているか）

**受け入れ基準**:
- 4つのデータベースすべてにマイグレーションが正常に適用される
- 32分割テーブル（users_000 ～ users_031, posts_000 ～ posts_031）が正しく作成されている
- マイグレーション履歴が記録されている

---

### Phase 5: スクリプトの更新

#### - [ ] タスク 5.1: マイグレーション適用スクリプトの更新
**目的**: 既存の`scripts/migrate.sh`をAtlas対応に更新

**作業内容**:
- `scripts/migrate.sh`を確認
- Atlasコマンドを使用するように更新
- 環境別設定ファイル（`config/{env}/atlas.hcl`）を読み込むように更新
- マスターデータベースとシャーディングデータベースのマイグレーション適用を実装

**受け入れ基準**:
- `scripts/migrate.sh`がAtlas対応に更新されている
- 環境別設定ファイルを読み込める
- マスターデータベースとシャーディングデータベースのマイグレーション適用が正常に動作する

---

### Phase 6: 既存システムとの統合確認

#### - [ ] タスク 6.1: APIサーバーの動作確認
**目的**: Atlasで構築したデータベースで既存のAPIサーバーが正常に動作することを確認

**作業内容**:
- APIサーバーを起動
- 各APIエンドポイントの動作確認
  - ユーザー作成、取得、更新、削除
  - 投稿作成、取得、更新、削除
  - ユーザーと投稿のJOIN取得（クロスシャードクエリ）
- エラーログを確認

**受け入れ基準**:
- APIサーバーが正常に起動する
- すべてのAPIエンドポイントが正常に動作する
- エラーが発生しない

---

#### - [ ] タスク 6.2: クライアント（Next.js）の動作確認
**目的**: Atlasで構築したデータベースで既存のクライアントが正常に動作することを確認

**作業内容**:
- クライアント（Next.js）を起動
- 各画面の動作確認
  - ユーザー一覧画面
  - 投稿一覧画面
  - ユーザーと投稿のJOIN画面
- エラーログを確認

**受け入れ基準**:
- クライアントが正常に起動する
- すべての画面が正常に動作する
- エラーが発生しない

---

#### - [ ] タスク 6.3: 管理画面（GoAdmin）の動作確認
**目的**: Atlasで構築したデータベースで既存の管理画面が正常に動作することを確認

**作業内容**:
- 管理画面（GoAdmin）を起動
- 各機能の動作確認
  - ログイン機能
  - メニュー表示
  - データ管理機能
- エラーログを確認

**受け入れ基準**:
- 管理画面が正常に起動する
- すべての機能が正常に動作する
- エラーが発生しない

---

#### - [ ] タスク 6.4: 統合確認結果の文書化
**目的**: 既存システムとの統合確認結果を文書化

**作業内容**:
- 統合確認結果を記録
- 問題があれば対処方法を記録
- 確認結果をドキュメントに追加

**受け入れ基準**:
- 統合確認結果が文書化されている
- 問題と対処方法が記録されている

---

### Phase 7: 運用ドキュメントの作成

#### - [ ] タスク 7.1: Atlas運用ドキュメントの作成（基本使用方法）
**目的**: Atlasの基本的な使用方法を文書化

**作業内容**:
- `docs/Atlas.md`を作成
- Atlas CLIのインストール方法を記載
- スキーマ定義ファイルの作成方法を記載
- マイグレーション生成と適用の基本手順を記載

**受け入れ基準**:
- `docs/Atlas.md`が作成されている
- 基本的な使用方法が記載されている

---

#### - [ ] タスク 7.2: Atlas運用ドキュメントの作成（環境別適用手順）
**目的**: 環境別のマイグレーション適用手順を文書化

**作業内容**:
- `docs/Atlas.md`に環境別の適用手順を追加
  - 開発環境での運用
  - ステージング環境での運用
  - 本番環境での運用

**受け入れ基準**:
- 環境別の適用手順が記載されている

---

#### - [ ] タスク 7.3: Atlas運用ドキュメントの作成（ケース別運用方法）
**目的**: ケース別の運用方法を文書化

**作業内容**:
- `docs/Atlas.md`にケース別の運用方法を追加
  - スキーマ変更の手順
  - ロールバックの手順
  - データ移行の手順
  - トラブルシューティング

**受け入れ基準**:
- ケース別の運用方法が記載されている

---

#### - [ ] タスク 7.4: Atlas運用ドキュメントの作成（イレギュラーケースの対処）
**目的**: イレギュラーケースの対処方法を文書化

**作業内容**:
- `docs/Atlas.md`にイレギュラーケースの対処方法を追加
  - 直接SQL適用後の作業
  - マイグレーションハッシュの確認方法
  - マイグレーション履歴とスキーマの整合性を取る方法

**受け入れ基準**:
- イレギュラーケースの対処方法が記載されている

---

### Phase 8: READMEの更新

#### - [ ] タスク 8.1: READMEにAtlas使用方法を追記
**目的**: READMEにAtlas使用方法を追記

**作業内容**:
- `README.md`のデータベースセットアップセクションを更新
- Atlasを使用したデータベースセットアップ手順を追加
- 既存のマイグレーションスクリプトの説明を更新

**受け入れ基準**:
- `README.md`にAtlas使用方法が追記されている
- データベースセットアップ手順が明確に記載されている

---

### Phase 9: 運用実験

#### - [ ] タスク 9.1: 0からのデータベース初期化の実験
**目的**: 空のデータベースからAtlasでスキーマを適用する実験

**作業内容**:
- 既存のデータベースファイルを削除
- Atlasでスキーマを適用
- データベース構造を確認
- 実験結果を記録

**受け入れ基準**:
- 0からのデータベース初期化が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.2: master側の操作実験（テーブル追加）
**目的**: master側でテーブルを追加する操作の実験

**作業内容**:
- `db/schema/master.hcl`に新しいテーブルを追加
- マイグレーションファイルを生成
- マイグレーションを適用
- テーブルが正しく作成されることを確認
- 実験結果を記録

**受け入れ基準**:
- テーブル追加が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.3: master側の操作実験（カラム追加）
**目的**: master側でテーブルにカラムを追加する操作の実験

**作業内容**:
- `db/schema/master.hcl`の既存テーブルにカラムを追加
- マイグレーションファイルを生成
- マイグレーションを適用
- カラムが正しく追加されることを確認
- 実験結果を記録

**受け入れ基準**:
- カラム追加が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.4: master側の操作実験（データ更新）
**目的**: master側でテーブルのデータを更新する操作の実験

**作業内容**:
- データベースに直接SQLでデータを更新
- マイグレーション履歴との整合性を確認
- 実験結果を記録

**受け入れ基準**:
- データ更新が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.5: master側の操作実験（テーブル削除）
**目的**: master側でテーブルを削除する操作の実験

**作業内容**:
- `db/schema/master.hcl`からテーブルを削除
- マイグレーションファイルを生成
- マイグレーションを適用
- テーブルが正しく削除されることを確認
- 実験結果を記録

**受け入れ基準**:
- テーブル削除が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.6: sharding側の操作実験（テーブル追加）
**目的**: sharding側でテーブルを追加する操作の実験

**作業内容**:
- `db/schema/sharding.hcl`に新しいテーブルを追加
- マイグレーションファイルを生成
- 4つのシャーディングデータベースにマイグレーションを適用
- テーブルが正しく作成されることを確認
- 実験結果を記録

**受け入れ基準**:
- テーブル追加が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.7: sharding側の操作実験（カラム追加）
**目的**: sharding側でテーブルにカラムを追加する操作の実験

**作業内容**:
- `db/schema/sharding.hcl`の既存テーブルにカラムを追加
- マイグレーションファイルを生成
- 4つのシャーディングデータベースにマイグレーションを適用
- カラムが正しく追加されることを確認
- 実験結果を記録

**受け入れ基準**:
- カラム追加が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.8: sharding側の操作実験（データ更新）
**目的**: sharding側でテーブルのデータを更新する操作の実験

**作業内容**:
- データベースに直接SQLでデータを更新
- マイグレーション履歴との整合性を確認
- 実験結果を記録

**受け入れ基準**:
- データ更新が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.9: sharding側の操作実験（テーブル削除）
**目的**: sharding側でテーブルを削除する操作の実験

**作業内容**:
- `db/schema/sharding.hcl`からテーブルを削除
- マイグレーションファイルを生成
- 4つのシャーディングデータベースにマイグレーションを適用
- テーブルが正しく削除されることを確認
- 実験結果を記録

**受け入れ基準**:
- テーブル削除が正常に動作する
- 実験結果が記録されている

---

#### - [ ] タスク 9.10: イレギュラーケースの実験（直接SQL適用後の作業）
**目的**: 直接SQLを適用した後の作業の実験

**作業内容**:
- データベースに直接SQLを適用（Atlasを経由せず）
- `atlas migrate status`でマイグレーション適用状態を確認
- `atlas migrate hash`でマイグレーションハッシュを確認
- マイグレーション履歴とスキーマの不一致を検出
- ベースラインの設定（`atlas migrate baseline`）を実行
- マイグレーション履歴とスキーマの整合性を確認
- 実験結果を記録

**受け入れ基準**:
- 直接SQL適用後の作業が正常に動作する
- マイグレーションハッシュの確認方法が確認できている
- マイグレーション履歴とスキーマの整合性を取る方法が確認できている
- 実験結果が記録されている

---

#### - [ ] タスク 9.11: 運用実験結果の文書化
**目的**: 運用実験の結果を文書化

**作業内容**:
- すべての運用実験の結果をまとめる
- 問題点や改善点を記録
- 運用ドキュメントに反映

**受け入れ基準**:
- 運用実験の結果が文書化されている
- 問題点や改善点が記録されている

---

### Phase 10: 既存ツールの削除

#### - [ ] タスク 10.1: 既存ツールの不要確認
**目的**: 既存ツールが不要になったことを確認

**作業内容**:
- `server/cmd/migrate-gen/main.go`が不要かどうかを確認
- 既存のマイグレーションスクリプトが不要かどうかを確認
- 確認結果を記録

**受け入れ基準**:
- 既存ツールが不要になったことが確認されている

---

#### - [ ] タスク 10.2: 不要になった既存ツールの削除
**目的**: 不要になった既存ツールを削除

**作業内容**:
- 不要になった既存ツールを削除
  - `server/cmd/migrate-gen/main.go`（不要な場合）
- 削除内容を記録

**受け入れ基準**:
- 不要になった既存ツールが削除されている
- 削除内容が記録されている

---

## タスクの依存関係

### フェーズ間の依存関係
- Phase 1 → Phase 2: ディレクトリ構造の作成後にスキーマ定義ファイルを作成
- Phase 2 → Phase 3: スキーマ定義ファイルの作成後に環境別設定ファイルを作成
- Phase 3 → Phase 4: 環境別設定ファイルの作成後にマイグレーションを生成・適用
- Phase 4 → Phase 5: マイグレーション適用後にスクリプトを更新
- Phase 5 → Phase 6: スクリプト更新後に既存システムとの統合確認
- Phase 6 → Phase 7: 統合確認後に運用ドキュメントを作成
- Phase 7 → Phase 8: 運用ドキュメント作成後にREADMEを更新
- Phase 8 → Phase 9: README更新後に運用実験を実施
- Phase 9 → Phase 10: 運用実験後に既存ツールを削除

### フェーズ内の依存関係
- Phase 2: タスク2.1 → タスク2.2 → タスク2.3 → タスク2.4 → タスク2.5 → タスク2.6
- Phase 3: タスク3.1 → タスク3.2 → タスク3.3（並行実行可能）
- Phase 4: タスク4.1 → タスク4.3、タスク4.2 → タスク4.4
- Phase 6: タスク6.1 → タスク6.2 → タスク6.3 → タスク6.4
- Phase 7: タスク7.1 → タスク7.2 → タスク7.3 → タスク7.4
- Phase 9: タスク9.1 → タスク9.2 → タスク9.3 → タスク9.4 → タスク9.5 → タスク9.6 → タスク9.7 → タスク9.8 → タスク9.9 → タスク9.10 → タスク9.11

## 注意事項

### 実装時の注意点
- スキーマ定義ファイル（HCL形式）の構文エラーに注意
- 環境別設定ファイルのデータソース設定を確認
- マイグレーション適用前にバックアップを取得（本番環境）
- 既存システムとの統合確認を必ず実施
- 運用実験の結果を必ず記録

### リスクと対策
- **リスク**: スキーマ定義の誤りによるデータベース構造の不整合
  - **対策**: スキーマ定義ファイルの検証を必ず実施
- **リスク**: マイグレーション適用時のエラー
  - **対策**: 開発環境で十分にテストしてから本番環境に適用
- **リスク**: 既存システムとの不整合
  - **対策**: 統合確認を必ず実施し、問題があれば対処


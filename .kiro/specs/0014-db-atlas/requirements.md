# Atlas導入要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Issue番号**: #26
- **Issueタイトル**: データベースの管理にAtlasを導入
- **Feature名**: 0014-db-atlas
- **作成日**: 2025-01-27

### 1.2 目的
データベース管理にAtlas CLIを導入し、バージョン管理型のマイグレーション運用を実現する。
既存の手動マイグレーション管理から、宣言的なスキーマ定義（HCL形式）による管理に移行し、環境間での一貫性と保守性を向上させる。

### 1.3 スコープ
- Atlas CLIの導入とセットアップ
- スキーマ定義ファイル（HCL形式）の作成
- 環境別設定ファイルの作成
- マイグレーション生成と適用のワークフロー構築
- 運用ドキュメントの作成
- **重要**: 既存のデータベースやデータの中身は破棄しても構わないため、ゼロからAtlasスキーマを定義可能

## 2. 背景・現状分析

### 2.1 現在の実装
- **マイグレーションファイル**: 
  - `db/migrations/master/` - マスターデータベース用SQLファイル（001_init.sql, 002_goadmin.sql, 003_menu.sql, 004_api_key_menu.sql）
  - `db/migrations/sharding/templates/` - シャーディング用テンプレート（users.sql.template, posts.sql.template）
  - `db/migrations/sharding/generated/` - 生成されたSQLファイル（users_000.sql ～ users_031.sql, posts_000.sql ～ posts_031.sql）
- **マイグレーション適用スクリプト**: `scripts/migrate.sh`
- **マイグレーション生成ツール**: `server/cmd/migrate-gen/main.go`
- **データベース構成**:
  - マスターデータベース: `master.db`（newsテーブル、GoAdmin関連テーブル）
  - シャーディングデータベース: `sharding_db_1.db` ～ `sharding_db_4.db`（usersテーブル32分割、postsテーブル32分割）
- **環境別設定**: `config/{env}/database.yaml`（develop, staging, production）

### 2.2 課題点
1. **手動でのマイグレーション管理**: SQLファイルを手動で作成・管理しており、バージョン管理が不十分
2. **バージョン管理の不備**: マイグレーション履歴がデータベースに記録されていない
3. **環境間での一貫性不足**: 開発環境、ステージング環境、本番環境でマイグレーション適用の手順が異なる可能性
4. **スキーマの宣言的定義の欠如**: 現在のスキーマ状態を宣言的に定義するファイルが存在しない
5. **マイグレーション生成の複雑さ**: シャーディングテーブルの生成にテンプレートと専用ツールが必要

### 2.3 本実装による改善点
1. **バージョン管理型のマイグレーション**: Atlasによるマイグレーション履歴の自動管理
2. **スキーマの宣言的定義**: HCL形式によるスキーマ定義により、現在のスキーマ状態を明確に管理
3. **環境間での一貫性**: 環境別設定ファイルにより、各環境でのマイグレーション適用を統一
4. **開発効率の向上**: Atlas CLIによるマイグレーション生成・適用の簡素化
5. **運用ドキュメントの整備**: ケース別の運用手順を文書化

## 3. 機能要件

### 3.1 Atlas CLIの導入とセットアップ

#### 3.1.1 Atlas CLIのインストール
- **公式サイト**: https://atlasgo.io/
- **インストール方法**: 公式ドキュメントに従ってインストール
- **バージョン**: 最新の安定版を使用

#### 3.1.2 Atlasの初期化
- プロジェクトルートでAtlasを初期化
- 必要な設定ファイルとディレクトリ構造を作成

### 3.2 スキーマ定義ファイル（HCL形式）の作成

#### 3.2.1 マスターデータベーススキーマ
- **ファイル**: `db/schema/master.hcl`
- **内容**: マスターデータベースの全テーブル定義
  - `news`テーブル（id, title, content, author_id, published_at, created_at, updated_at）
  - GoAdmin関連テーブル（goadmin_menu, goadmin_operation_log, goadmin_site, goadmin_permissions, goadmin_roles, goadmin_role_menu, goadmin_role_permissions, goadmin_role_users, goadmin_session, goadmin_user_permissions, goadmin_users）
  - その他のマスターデータベーステーブル

#### 3.2.2 シャーディングデータベーススキーマ
- **ファイル**: `db/schema/sharding.hcl`
- **内容**: シャーディングデータベースのテーブル定義
  - `users`テーブル（32分割: users_000 ～ users_031）
  - `posts`テーブル（32分割: posts_000 ～ posts_031）
  - 各テーブルのインデックス定義
  - 外部キー制約（posts.user_id → users.id）

#### 3.2.3 スキーマ定義の参考
- 既存のSQLファイル（`db/migrations/master/*.sql`）を参考にスキーマを定義
- 既存のテンプレート（`db/migrations/sharding/templates/*.sql.template`）を参考にシャーディングテーブルを定義
- **注意**: 既存データベースは破棄可能なため、移行ではなく新規にスキーマを定義

### 3.3 環境別設定ファイル

#### 3.3.1 開発環境設定
- **ファイル**: `config/develop/atlas.hcl`
- **内容**: 
  - データソース設定（SQLite: `./data/master.db`, `./data/sharding_db_*.db`）
  - マイグレーションディレクトリ設定
  - その他の開発環境固有設定

#### 3.3.2 ステージング環境設定
- **ファイル**: `config/staging/atlas.hcl`
- **内容**: 
  - データソース設定（PostgreSQL/MySQL想定）
  - マイグレーションディレクトリ設定
  - その他のステージング環境固有設定

#### 3.3.3 本番環境設定
- **ファイル**: `config/production/atlas.hcl`
- **内容**: 
  - データソース設定（PostgreSQL/MySQL想定）
  - マイグレーションディレクトリ設定
  - その他の本番環境固有設定

### 3.4 マイグレーション生成と適用

#### 3.4.1 開発環境での運用
- **マイグレーション生成**: `atlas migrate diff`コマンドでスキーマ変更を検出し、マイグレーションファイルを生成
- **マイグレーション適用**: `atlas migrate apply`コマンドで直接データベースに適用
- **マイグレーション履歴**: Atlasが自動的にマイグレーション履歴を管理

#### 3.4.2 本番環境での運用
- **マイグレーション生成**: 開発環境と同様に`atlas migrate diff`でマイグレーションファイルを生成
- **SQL生成**: `atlas migrate apply --dry-run`または`atlas schema apply --dry-run`でSQLを生成
- **SQL適用**: 生成したSQLを本番環境に適用（手動または自動化スクリプト）

#### 3.4.3 マイグレーションファイルの管理
- **ディレクトリ**: `db/migrations/master/`, `db/migrations/sharding/`
- **ファイル命名**: Atlasの標準命名規則に従う
- **バージョン管理**: Gitでマイグレーションファイルを管理

### 3.5 シャーディングデータベースの管理

#### 3.5.1 複数データベースへの適用
- マスターデータベース: 単一データベースへの適用
- シャーディングデータベース: 4つのデータベース（sharding_db_1.db ～ sharding_db_4.db）への適用
- 各シャーディングデータベースに同じスキーマを適用

#### 3.5.2 シャーディングテーブルの定義
- `db/schema/sharding.hcl`で32分割テーブルを定義
- テーブル名のパターン: `users_000`, `users_001`, ..., `users_031`, `posts_000`, `posts_001`, ..., `posts_031`

## 4. 非機能要件

### 4.1 環境別設定の管理
- 環境別設定ファイル（`config/{env}/atlas.hcl`）により、各環境での設定を分離
- 設定ファイルの構造は既存の`config/{env}/database.yaml`と整合性を保つ

### 4.2 マイグレーション履歴の管理
- Atlasが自動的にマイグレーション履歴をデータベースに記録
- マイグレーションの適用状態を追跡可能

### 4.3 運用ドキュメントの整備
- **ファイル**: `docs/Atlas.md`
- **内容**: 
  - Atlasの基本的な使用方法
  - 環境別のマイグレーション適用手順
  - ケース別の運用方法（スキーマ変更、ロールバック、データ移行など）
  - イレギュラーケースの対処方法（直接SQL適用後の作業、マイグレーションハッシュの確認など）
  - トラブルシューティング

### 4.5 運用実験
- **環境**: develop環境のみで実施
- **目的**: 一通り完成したら、運用をある程度想定した操作の実験を実施
- **シナリオ**:
  1. **0からのデータベースの初期化**
     - 空のデータベースからAtlasでスキーマを適用
  2. **master側の操作**
     2-1. テーブルの追加
     2-2. テーブルにカラムを追加
     2-3. テーブルのデータを更新
     2-4. テーブルを削除
  3. **sharding側の操作**
     3-1. テーブルの追加
     3-2. テーブルにカラムを追加
     3-3. テーブルのデータを更新
     3-4. テーブルを削除
  4. **イレギュラーケースのシナリオ**
     4-1. **直接SQLを適用した後の作業**
       - データベースに直接SQLを適用（Atlasを経由せず）
       - Atlasのマイグレーション履歴と実際のスキーマの不一致を検出
       - `atlas migrate hash`コマンドによるマイグレーションハッシュの確認
       - マイグレーション履歴とスキーマの整合性を取る方法の実験
       - ベースラインの設定やマイグレーション履歴の修正方法の確認

### 4.4 既存ツールとの関係
- 既存の`scripts/migrate.sh`はAtlas対応に更新、または新規スクリプトに置き換え
- 既存の`server/cmd/migrate-gen/main.go`はAtlas導入後は不要になる可能性があるが、移行期間中は維持
- **既存ツールの削除**: 最終的に既存ツールが不要になったら削除する

## 5. 制約事項

### 5.1 データベース構造
- **既存データベースの破棄**: 既存のデータベースやデータの中身は破棄しても構わないため、既存構造を維持する必要はない
- **スキーマ定義の参考**: 既存のSQLファイルを参考にスキーマを定義するが、完全な互換性は不要

### 5.2 環境別設定ファイルの構造
- 既存の`config/{env}/`ディレクトリ構造は維持
- `config/{env}/database.yaml`との整合性を考慮

### 5.3 技術スタック
- **Atlas**: 最新の安定版を使用
- **データベース**: SQLite（開発環境）、PostgreSQL/MySQL（本番想定）
- 既存のGoバージョン（1.23.4）は維持

### 5.4 マイグレーション履歴
- Atlas導入時点で既存のマイグレーション履歴は破棄される
- 新規にAtlasでマイグレーション履歴を開始

## 6. 受け入れ基準

### 6.1 Atlas CLIの導入
- [ ] Atlas CLIがインストールされている
- [ ] Atlasの初期化が完了している

### 6.2 スキーマ定義ファイル
- [ ] `db/schema/master.hcl`が作成されている
- [ ] `db/schema/sharding.hcl`が作成されている
- [ ] 既存のSQLファイルを参考にスキーマが定義されている

### 6.3 環境別設定ファイル
- [ ] `config/develop/atlas.hcl`が作成されている
- [ ] `config/staging/atlas.hcl`が作成されている
- [ ] `config/production/atlas.hcl`が作成されている

### 6.4 マイグレーション生成と適用
- [ ] 開発環境でマイグレーションが正常に生成できる
- [ ] 開発環境でマイグレーションが正常に適用できる
- [ ] 本番環境向けのSQL生成が正常に動作する

### 6.5 シャーディングデータベースの管理
- [ ] マスターデータベースへのマイグレーション適用が正常に動作する
- [ ] シャーディングデータベース（4つ）へのマイグレーション適用が正常に動作する
- [ ] 32分割テーブルが正しく作成される

### 6.6 既存システムとの統合確認
- [ ] Atlasでデータベースを構築した後、既存のAPIサーバーが正しく動作する
- [ ] Atlasでデータベースを構築した後、既存のクライアント（Next.js）が正しく動作する
- [ ] Atlasでデータベースを構築した後、既存の管理画面（GoAdmin）が正しく動作する
- [ ] 既存のAPIエンドポイントが正常に動作する（ユーザー作成、取得、更新、削除など）
- [ ] 既存のAPIエンドポイントが正常に動作する（投稿作成、取得、更新、削除など）
- [ ] シャーディング機能が正常に動作する（クロスシャードクエリなど）
- [ ] 既存システムとの統合確認結果が文書化されている

### 6.7 運用ドキュメント
- [ ] `docs/Atlas.md`が作成されている
- [ ] 基本的な使用方法が記載されている
- [ ] 環境別の適用手順が記載されている
- [ ] ケース別の運用方法が記載されている

### 6.8 既存ツールとの統合
- [ ] `scripts/migrate.sh`がAtlas対応に更新されている、または新規スクリプトが作成されている
- [ ] `README.md`にAtlas使用方法が追記されている

### 6.9 運用実験
- [ ] develop環境で0からのデータベース初期化が正常に動作する
- [ ] master側の操作（テーブル追加、カラム追加、データ更新、テーブル削除）が正常に動作する
- [ ] sharding側の操作（テーブル追加、カラム追加、データ更新、テーブル削除）が正常に動作する
- [ ] イレギュラーケース（直接SQL適用後の作業）が正常に動作する
- [ ] マイグレーションハッシュの確認方法が確認できている
- [ ] マイグレーション履歴とスキーマの整合性を取る方法が確認できている
- [ ] 運用実験の結果が文書化されている

### 6.10 既存ツールの削除
- [ ] 既存ツールが不要になったことを確認
- [ ] 不要になった既存ツールを削除

## 7. 影響範囲

### 7.1 新規追加が必要なディレクトリ・ファイル

#### ディレクトリ
- `db/schema/`: スキーマ定義ファイル用ディレクトリ

#### ファイル
- `db/schema/master.hcl`: マスターデータベーススキーマ定義
- `db/schema/sharding.hcl`: シャーディングデータベーススキーマ定義
- `config/develop/atlas.hcl`: 開発環境用Atlas設定
- `config/staging/atlas.hcl`: ステージング環境用Atlas設定
- `config/production/atlas.hcl`: 本番環境用Atlas設定
- `docs/Atlas.md`: Atlas運用ドキュメント

### 7.2 変更が必要なファイル

#### スクリプト
- `scripts/migrate.sh`: Atlas対応に更新、または新規スクリプトに置き換え

#### ドキュメント
- `README.md`: Atlas使用方法の追記

### 7.3 削除される可能性のあるファイル
- `server/cmd/migrate-gen/main.go`: Atlas導入後は不要になる可能性があるが、移行期間中は維持
- **削除方針**: 最終的に既存ツールが不要になったら削除する

### 7.4 既存ファイルの扱い
- `db/migrations/master/*.sql`: 参考として残す（Atlasスキーマ定義の参考）
- `db/migrations/sharding/templates/*.sql.template`: 参考として残す（Atlasスキーマ定義の参考）
- `db/migrations/sharding/generated/*.sql`: 参考として残す（Atlasスキーマ定義の参考）

## 8. 実装上の注意事項

### 8.1 Atlas HCL形式でのスキーマ定義
- HCL形式の構文に従ってスキーマを定義
- 既存のSQLファイルを参考に、テーブル定義、インデックス、外部キー制約をHCL形式で記述

### 8.2 環境別設定の管理
- 各環境の`atlas.hcl`でデータソースを適切に設定
- 開発環境はSQLite、ステージング・本番環境はPostgreSQL/MySQLを想定

### 8.3 マイグレーション生成と適用のワークフロー
- スキーマ変更時は`atlas migrate diff`でマイグレーションファイルを生成
- 開発環境では`atlas migrate apply`で直接適用
- 本番環境では生成したSQLを確認してから適用

### 8.4 シャーディングデータベースの管理
- 4つのシャーディングデータベースに同じスキーマを適用
- 32分割テーブルの定義を適切に記述

### 8.5 マイグレーション履歴の管理
- Atlasが自動的に`atlas_schema_migrations`テーブルを作成し、履歴を管理
- マイグレーションの適用状態を確認する方法を文書化

### 8.6 運用ドキュメント
- 基本的な使用方法（マイグレーション生成、適用）
- 環境別の適用手順
- ケース別の運用方法：
  - スキーマ変更の手順
  - ロールバックの手順
  - データ移行の手順
  - トラブルシューティング

### 8.7 運用実験の実施
- develop環境のみで運用実験を実施
- 実験シナリオに従って各操作を実行
- 実験結果を文書化し、問題点や改善点を記録
- 実験を通じて運用ドキュメントを改善

### 8.8 イレギュラーケースの対処
- **直接SQL適用後の対処**:
  - データベースに直接SQLを適用した場合、Atlasのマイグレーション履歴と実際のスキーマが不一致になる
  - `atlas migrate hash`コマンドでマイグレーションファイルのハッシュを確認
  - `atlas migrate status`コマンドでマイグレーション適用状態を確認
  - ベースラインの設定やマイグレーション履歴の修正方法を確認
  - スキーマのベースライン設定（`atlas migrate baseline`）の使用方法を確認
  - マイグレーション履歴とスキーマの整合性を取る手順を文書化

### 8.9 既存システムとの統合確認
- **Atlasでデータベース構築後の確認**:
  - Atlasでデータベースを構築した後、既存のAPIサーバー、クライアント、管理画面が正しく動作することを確認
  - 既存のAPIエンドポイント（ユーザー作成、取得、更新、削除など）が正常に動作することを確認
  - 既存のAPIエンドポイント（投稿作成、取得、更新、削除など）が正常に動作することを確認
  - シャーディング機能（クロスシャードクエリなど）が正常に動作することを確認
  - 管理画面（GoAdmin）の各機能が正常に動作することを確認
  - 統合確認の結果を文書化し、問題があれば対処方法を記録

## 9. 参考情報

### 9.1 関連Issue
- GitHub Issue #26: データベースの管理にAtlasを導入

### 9.2 既存ドキュメント
- `README.md`: プロジェクト概要とセットアップ手順
- `docs/Sharding.md`: シャーディングの詳細仕様
- `db/migrations/master/*.sql`: 既存のマスターデータベースマイグレーション
- `db/migrations/sharding/templates/*.sql.template`: 既存のシャーディングテンプレート

### 9.3 技術スタック
- **Atlas**: https://atlasgo.io/
- **Go**: 1.23.4
- **データベース**: SQLite（開発環境）、PostgreSQL/MySQL（本番想定）

### 9.4 参考リンク
- Atlas公式ドキュメント: https://atlasgo.io/
- Atlas GitHub: https://github.com/ariga/atlas
- Atlas CLI リファレンス: https://atlasgo.io/cli-reference


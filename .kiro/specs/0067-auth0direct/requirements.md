# Auth0直接ログイン対応の要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Feature名**: 0067-auth0direct
- **作成日**: 2026-01-27
- **関連Issue**: https://github.com/taku-o/go-webdb-template/issues/138

### 1.2 目的
ログイン時にNextAuth.jsのデフォルトサインインページ（`/api/auth/signin`）を回避し、直接Auth0の認証画面に遷移するようにする。これにより、ユーザー体験を向上させ、ログインフローのステップを削減する。

### 1.3 スコープ
- `signIn()`関数の呼び出し時にプロバイダーID（`'auth0'`）を指定する
- 変更対象ファイル：
  - `client/app/page.tsx`
  - `client/components/layout/navbar.tsx`

**本実装の範囲外**:
- NextAuth.jsの設定変更
- 認証プロバイダーの追加・変更
- その他の認証フローの変更
- UI/UXの変更（ログインボタンの見た目や配置など）

## 2. 背景・現状分析

### 2.1 現状
現在のログインフローは以下の通り：

1. ユーザーがログインボタンをクリック
2. `/api/auth/signin?callbackUrl=http%3A%2F%2Flocalhost%3A3000%2F` に遷移（ワンクッションページ）
3. プロバイダー選択画面が表示される
4. Auth0を選択してAuth0の認証画面に遷移

### 2.2 問題点
- ログインボタンをクリックした後、NextAuth.jsのデフォルトサインインページが表示される
- プロバイダー選択画面が表示されるが、Auth0のみが利用可能なため、不要なステップとなっている
- ユーザーは追加のクリック操作が必要で、ログインフローが冗長

### 2.3 必要性
- ユーザー体験の向上：ログインボタンをクリックしたら直接Auth0の認証画面に遷移する
- フローの簡素化：不要な中間ページを削減する
- プロバイダーが1つの場合、選択画面は不要

### 2.4 実現可否
- NextAuth.jsの`signIn()`関数は、プロバイダーIDを引数として指定することで、デフォルトサインインページをスキップして直接プロバイダーの認証画面に遷移できる
- 既存のコードを最小限の変更で対応可能
- 既存の認証フローに影響を与えない

## 3. 機能要件

### 3.1 ログインフローの変更

#### 3.1.1 変更前の動作
1. ユーザーがログインボタンをクリック
2. `/api/auth/signin?callbackUrl=...` に遷移
3. NextAuth.jsのデフォルトサインインページ（プロバイダー選択画面）が表示される
4. Auth0を選択
5. Auth0の認証画面に遷移

#### 3.1.2 変更後の動作
1. ユーザーがログインボタンをクリック
2. 直接Auth0の認証画面に遷移

### 3.2 コード変更

#### 3.2.1 変更対象ファイル1: `client/app/page.tsx`
- **変更箇所**: 112行目付近
- **変更前**: `await signIn()`
- **変更後**: `await signIn('auth0')`

#### 3.2.2 変更対象ファイル2: `client/components/layout/navbar.tsx`
- **変更箇所**: 44行目付近
- **変更前**: `await signIn()`
- **変更後**: `await signIn('auth0')`

### 3.3 動作確認要件
- ログインボタンをクリックした際に、NextAuth.jsのデフォルトサインインページが表示されないこと
- 直接Auth0の認証画面に遷移すること
- 認証成功後、適切にリダイレクトされること
- 既存の認証機能が正常に動作すること

## 4. 非機能要件

### 4.1 互換性
- 既存のNextAuth.jsの設定と互換性を保つ
- 既存の認証フローに影響を与えない
- 既存のセッション管理機能に影響を与えない

### 4.2 保守性
- コードの変更は最小限に留める
- 既存のコード構造を維持する
- コメントやドキュメントの更新は不要（変更が単純なため）

### 4.3 パフォーマンス
- ページ遷移のステップが減るため、ログインまでの時間が短縮される
- 既存のパフォーマンスに悪影響を与えない

## 5. 制約事項

### 5.1 技術的制約
- NextAuth.jsの`signIn()`関数の仕様に従う
- プロバイダーID（`'auth0'`）は、NextAuth.jsの設定で定義されているIDと一致する必要がある

### 5.2 実装上の制約
- 既存の認証設定を変更しない
- UI/UXの変更は行わない（ログインボタンの見た目や配置など）
- 他のファイルへの影響を最小限に留める

### 5.3 機能の制約
- 本実装はAuth0プロバイダーのみを対象とする
- 将来的に複数のプロバイダーを追加する場合は、別途対応が必要

## 6. 受け入れ基準

### 6.1 コード変更
- [ ] `client/app/page.tsx`の`signIn()`呼び出しが`signIn('auth0')`に変更されている
- [ ] `client/components/layout/navbar.tsx`の`signIn()`呼び出しが`signIn('auth0')`に変更されている
- [ ] コードの構文エラーがない
- [ ] TypeScriptの型エラーがない

### 6.2 動作確認
- [ ] ログインボタンをクリックした際に、NextAuth.jsのデフォルトサインインページが表示されない
- [ ] ログインボタンをクリックした際に、直接Auth0の認証画面に遷移する
- [ ] 認証成功後、適切にリダイレクトされる
- [ ] 既存の認証機能（ログアウト、セッション管理など）が正常に動作する
- [ ] ページリロード後もセッションが維持される

### 6.3 テスト
- [ ] 既存のテストが全て成功する
- [ ] 新しいテストエラーが発生していない

## 7. 影響範囲

### 7.1 変更されるファイル
- `client/app/page.tsx`: `signIn()`の呼び出しを`signIn('auth0')`に変更
- `client/components/layout/navbar.tsx`: `signIn()`の呼び出しを`signIn('auth0')`に変更

### 7.2 既存ファイルへの影響
- その他のファイルへの影響はない
- NextAuth.jsの設定ファイルへの影響はない

### 7.3 既存機能への影響
- 認証機能全体への影響はない
- ログインフローのみが変更される
- ログアウト機能への影響はない
- セッション管理機能への影響はない

## 8. 実装上の注意事項

### 8.1 プロバイダーIDの確認
- NextAuth.jsの設定で定義されているAuth0プロバイダーのIDが`'auth0'`であることを確認する
- 設定ファイル（`client/auth.ts`など）でプロバイダーIDを確認する

### 8.2 変更の適用
- 2つのファイルで同じ変更を適用する
- 変更は単純な関数呼び出しの引数追加のみ

### 8.3 動作確認
- 変更後、実際にログインフローをテストする
- デフォルトサインインページが表示されないことを確認する
- Auth0の認証画面に直接遷移することを確認する
- 認証成功後のリダイレクトが正常に動作することを確認する

### 8.4 エラーハンドリング
- 既存のエラーハンドリングに影響を与えない
- NextAuth.jsのエラーハンドリングは既存のまま動作する

## 9. 参考情報

### 9.1 関連ドキュメント
- NextAuth.js公式ドキュメント: `signIn()`関数の使用方法
- `docs/Partner-Idp-Auth0-Login.md`: Auth0設定手順

### 9.2 関連Issue
- https://github.com/taku-o/go-webdb-template/issues/138: 本要件定義書の元となったIssue

### 9.3 技術スタック
- **NextAuth.js**: 認証ライブラリ
- **Auth0**: 認証プロバイダー
- **Next.js**: フレームワーク

### 9.4 実装の流れ
1. `client/app/page.tsx`の`signIn()`を`signIn('auth0')`に変更
2. `client/components/layout/navbar.tsx`の`signIn()`を`signIn('auth0')`に変更
3. 動作確認（ログインフローのテスト）
4. 既存のテストの実行と確認

### 9.5 依存関係
- NextAuth.jsの設定（既存の設定をそのまま使用）
- Auth0プロバイダーの設定（既存の設定をそのまま使用）

# CLIツール対応実装タスク一覧

## 概要
CLIツール対応の実装を段階的に進めるためのタスク一覧。要件定義書と設計書に基づき、実装可能な粒度でタスクを分解。

## 実装フェーズ

### Phase 1: ディレクトリ構造の作成

#### タスク 1.1: CLIツールディレクトリの作成
**目的**: CLIツールを配置するディレクトリを作成

**作業内容**:
- `server/cmd/list-users/`ディレクトリを作成

**受け入れ基準**:
- `server/cmd/list-users/`ディレクトリが存在する

---

#### タスク 1.2: 実行ファイル生成先ディレクトリの作成
**目的**: ビルド後の実行ファイルを配置するディレクトリを作成

**作業内容**:
- `server/bin/`ディレクトリを作成
- `.gitignore`に`server/bin/`を追加

**受け入れ基準**:
- `server/bin/`ディレクトリが存在する
- `.gitignore`に`server/bin/`が追加されている

---

### Phase 2: CLIツールの基本実装

#### タスク 2.1: main.goの基本構造の作成
**目的**: CLIツールの基本構造を作成

**作業内容**:
- `server/cmd/list-users/main.go`を作成
- パッケージ宣言とインポート文を追加:
  - `package main`
  - 必要なパッケージのインポート（`context`, `flag`, `fmt`, `log`, `os`, `time`）
  - プロジェクト内部パッケージのインポート（`config`, `db`, `repository`, `service`, `model`）
- `main()`関数の空の実装を作成

**受け入れ基準**:
- `server/cmd/list-users/main.go`が存在する
- コンパイルエラーがない

---

#### タスク 2.2: コマンドライン引数処理の実装
**目的**: `--limit`フラグを処理する機能を実装

**作業内容**:
- `flag.Int()`で`--limit`フラグを定義（デフォルト値: 20、説明: "Number of users to output (default: 20, max: 100)"）
- `flag.Parse()`で引数を解析
- `flag.Usage`を設定して使用方法を表示できるようにする

**受け入れ基準**:
- `--limit`フラグが定義されている
- `flag.Parse()`が呼び出されている
- コンパイルエラーがない

---

#### タスク 2.3: 引数バリデーションの実装
**目的**: `--limit`フラグの値を検証する機能を実装

**作業内容**:
- `limit < 1`の場合、エラーメッセージを出力し、`log.Fatalf()`で終了
- `limit > 100`の場合、100に制限し、警告メッセージを出力（`log.Printf()`）

**受け入れ基準**:
- `limit < 1`の場合、エラーが出力され、終了コード1で終了する
- `limit > 100`の場合、100に制限され、警告が出力される
- コンパイルエラーがない

---

### Phase 3: 設定読み込みとDB接続の実装

#### タスク 3.1: 設定読み込みの実装
**目的**: 既存の設定読み込み機能を使用して設定を読み込む

**作業内容**:
- `config.Load()`を呼び出して設定を読み込む
- エラーハンドリングを実装（エラー時は`log.Fatalf()`で終了）

**受け入れ基準**:
- 設定が正常に読み込まれる
- エラー時は適切なエラーメッセージが出力される
- コンパイルエラーがない

---

#### タスク 3.2: DB接続の初期化
**目的**: GORM Managerを使用してDB接続を初期化

**作業内容**:
- `db.NewGORMManager(cfg)`でGORM Managerを初期化
- `defer gormManager.CloseAll()`でリソースのクリーンアップを設定
- エラーハンドリングを実装（エラー時は`log.Fatalf()`で終了）

**受け入れ基準**:
- GORM Managerが正常に初期化される
- `defer`でリソースのクリーンアップが設定されている
- エラー時は適切なエラーメッセージが出力される
- コンパイルエラーがない

---

#### タスク 3.3: DB接続確認の実装
**目的**: すべてのシャードへの接続を確認

**作業内容**:
- `gormManager.PingAll()`で接続確認を実行
- エラーハンドリングを実装（エラー時は`log.Fatalf()`で終了）

**受け入れ基準**:
- すべてのシャードへの接続が確認される
- エラー時は適切なエラーメッセージが出力される
- コンパイルエラーがない

---

### Phase 4: Repository層とService層の初期化

#### タスク 4.1: Repository層の初期化
**目的**: UserRepositoryGORMを初期化

**作業内容**:
- `repository.NewUserRepositoryGORM(gormManager)`でRepositoryを初期化

**受け入れ基準**:
- Repositoryが正常に初期化される
- コンパイルエラーがない

---

#### タスク 4.2: Service層の初期化
**目的**: UserServiceを初期化

**作業内容**:
- `service.NewUserService(userRepo)`でServiceを初期化

**受け入れ基準**:
- Serviceが正常に初期化される
- コンパイルエラーがない

---

### Phase 5: ユーザー一覧取得と出力処理の実装

#### タスク 5.1: ユーザー一覧取得の実装
**目的**: Service層を使用してユーザー一覧を取得

**作業内容**:
- `context.Background()`でコンテキストを作成
- `userService.ListUsers(ctx, limit, 0)`でユーザー一覧を取得
- エラーハンドリングを実装（エラー時は`log.Fatalf()`で終了）
- 取得したユーザー一覧を`limit`件に制限（マージ後に制限）

**受け入れ基準**:
- ユーザー一覧が正常に取得される
- 取得件数が`limit`件に制限される
- エラー時は適切なエラーメッセージが出力される
- コンパイルエラーがない

---

#### タスク 5.2: printUsersTSV関数の実装
**目的**: ユーザー一覧をTSV形式で出力する関数を実装

**作業内容**:
- `printUsersTSV(users []*model.User)`関数を作成
- ヘッダー行を出力（`ID\tName\tEmail\tCreatedAt\tUpdatedAt`）
- 各ユーザー情報を1行ずつ出力:
  - ID, Name, Emailをそのまま出力
  - CreatedAt, UpdatedAtをRFC3339形式（`time.RFC3339`）で出力
  - 各フィールドをタブ文字（`\t`）で区切る

**受け入れ基準**:
- ヘッダー行が出力される
- 各ユーザー情報がTSV形式で出力される
- 日時がRFC3339形式で出力される
- コンパイルエラーがない

---

#### タスク 5.3: 出力処理の統合
**目的**: ユーザー一覧取得と出力処理を統合

**作業内容**:
- `printUsersTSV(users)`を呼び出して出力
- 正常終了時は`os.Exit(0)`で終了

**受け入れ基準**:
- ユーザー一覧が正常に出力される
- 正常終了時に終了コード0で終了する
- コンパイルエラーがない

---

### Phase 6: ビルドと動作確認

#### タスク 6.1: ビルドの実行
**目的**: CLIツールをビルドして実行ファイルを生成

**作業内容**:
- `cd server`でディレクトリに移動
- `go build -o bin/list-users ./cmd/list-users`でビルドを実行
- ビルドエラーがないことを確認

**受け入れ基準**:
- ビルドが正常に完了する
- `server/bin/list-users`実行ファイルが生成される
- ビルドエラーがない

---

#### タスク 6.2: 基本動作確認
**目的**: CLIツールの基本動作を確認

**作業内容**:
- デフォルト引数で実行: `./bin/list-users`
- 出力がTSV形式であることを確認
- ヘッダー行が含まれていることを確認
- デフォルトで20件のユーザーが出力されることを確認

**受け入れ基準**:
- デフォルト引数で正常に実行される
- TSV形式で出力される
- ヘッダー行が含まれている
- デフォルトで20件のユーザーが出力される

---

#### タスク 6.3: limitパラメータの動作確認
**目的**: `--limit`フラグの動作を確認

**作業内容**:
- `--limit 10`で実行: `./bin/list-users --limit 10`
- 10件のユーザーが出力されることを確認
- `--limit 50`で実行: `./bin/list-users --limit 50`
- 50件のユーザーが出力されることを確認
- `--limit 0`で実行: `./bin/list-users --limit 0`
- エラーが出力されることを確認
- `--limit 200`で実行: `./bin/list-users --limit 200`
- 100件に制限され、警告が出力されることを確認

**受け入れ基準**:
- `--limit 10`で10件のユーザーが出力される
- `--limit 50`で50件のユーザーが出力される
- `--limit 0`でエラーが出力される
- `--limit 200`で100件に制限され、警告が出力される

---

#### タスク 6.4: 環境変数の動作確認
**目的**: 環境変数`APP_ENV`による環境切り替えを確認

**作業内容**:
- `APP_ENV=develop ./bin/list-users`で実行
- 開発環境の設定が読み込まれることを確認
- `APP_ENV=staging ./bin/list-users`で実行
- ステージング環境の設定が読み込まれることを確認

**受け入れ基準**:
- `APP_ENV=develop`で開発環境の設定が読み込まれる
- `APP_ENV=staging`でステージング環境の設定が読み込まれる

---

#### タスク 6.5: クロスシャードクエリの動作確認
**目的**: すべてのシャードからユーザーを取得できることを確認

**作業内容**:
- 複数のシャードにユーザーデータが存在する状態で実行
- すべてのシャードからユーザーが取得されることを確認
- 出力件数が`limit`件に制限されることを確認

**受け入れ基準**:
- すべてのシャードからユーザーが取得される
- 出力件数が`limit`件に制限される

---

### Phase 7: エラーハンドリングの確認

#### タスク 7.1: エラーケースの動作確認
**目的**: 各種エラーケースの動作を確認

**作業内容**:
- 設定ファイルが存在しない場合のエラー処理を確認
- DB接続に失敗した場合のエラー処理を確認
- クエリ実行に失敗した場合のエラー処理を確認
- 各エラーケースで適切な終了コード（1）が返されることを確認

**受け入れ基準**:
- 各エラーケースで適切なエラーメッセージが出力される
- 各エラーケースで終了コード1が返される

---

### Phase 8: テストの実装

#### タスク 8.1: printUsersTSV関数のユニットテスト
**目的**: printUsersTSV関数の動作を確認するユニットテストを作成

**作業内容**:
- `server/cmd/list-users/main_test.go`を作成
- `TestPrintUsersTSV`関数を実装:
  - テスト用のユーザーデータを作成
  - 標準出力をキャプチャ
  - `printUsersTSV()`を呼び出し
  - 出力内容を検証（ヘッダー行、データ行、日時形式）

**受け入れ基準**:
- `server/cmd/list-users/main_test.go`が存在する
- `TestPrintUsersTSV`テストが実装されている
- テストが正常に実行される

---

#### タスク 8.2: 引数バリデーションのユニットテスト
**目的**: 引数バリデーションの動作を確認するユニットテストを作成

**作業内容**:
- `TestValidateLimit`関数を実装:
  - `limit < 1`の場合のテスト
  - `limit > 100`の場合のテスト
  - 正常な`limit`値の場合のテスト

**受け入れ基準**:
- `TestValidateLimit`テストが実装されている
- テストが正常に実行される

---

### Phase 9: ドキュメントの更新

#### タスク 9.1: README.mdの更新
**目的**: CLIツールの使用方法をREADME.mdに記載

**作業内容**:
- `README.md`を確認
- CLIツールの使用方法セクションを追加（必要に応じて）:
  - ビルド方法
  - 実行方法
  - オプションの説明
  - 使用例

**受け入れ基準**:
- README.mdにCLIツールの使用方法が記載されている（必要に応じて）

---

### Phase 10: 最終確認

#### タスク 10.1: 既存テストの動作確認
**目的**: 既存のテストコードが正常に動作することを確認

**作業内容**:
- `cd server`でディレクトリに移動
- `go test ./...`で既存のテストを実行
- すべてのテストが正常に動作することを確認

**受け入れ基準**:
- 既存のテストがすべて正常に動作する
- テストエラーがない

---

#### タスク 10.2: 受け入れ基準の確認
**目的**: 要件定義書の受け入れ基準をすべて満たしていることを確認

**作業内容**:
- 要件定義書の受け入れ基準（6.1, 6.2, 6.3）を確認
- 各項目が実装されていることを確認

**受け入れ基準**:
- 要件定義書の受け入れ基準をすべて満たしている

---

## 実装順序の推奨

1. **Phase 1**: ディレクトリ構造の作成
2. **Phase 2**: CLIツールの基本実装
3. **Phase 3**: 設定読み込みとDB接続の実装
4. **Phase 4**: Repository層とService層の初期化
5. **Phase 5**: ユーザー一覧取得と出力処理の実装
6. **Phase 6**: ビルドと動作確認
7. **Phase 7**: エラーハンドリングの確認
8. **Phase 8**: テストの実装
9. **Phase 9**: ドキュメントの更新
10. **Phase 10**: 最終確認

## 注意事項

### 既存コードの再利用
- 既存の`config.Load()`、`db.NewGORMManager()`、`repository.NewUserRepositoryGORM()`、`service.NewUserService()`をそのまま使用する
- 新しいコードを追加せず、既存のアーキテクチャを維持する

### クロスシャードクエリのlimit処理
- 既存の`UserRepositoryGORM.List()`は各シャードから`limit`件ずつ取得してマージするため、実際の出力件数は`limit * シャード数`になる可能性がある
- マージ後に`limit`件に制限する処理を追加する必要がある

### リソース管理
- `defer gormManager.CloseAll()`でDB接続を確実にクローズする
- エラー発生時もリソースが適切に解放されるようにする

### 出力形式
- TSV形式の標準に従う（タブ区切り、改行で行を区切る）
- ヘッダー行を必ず含める
- 日時はRFC3339形式で統一する


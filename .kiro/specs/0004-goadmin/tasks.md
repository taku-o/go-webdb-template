# GoAdmin管理画面導入実装タスク一覧

## 概要
GoAdmin管理画面導入の実装を段階的に進めるためのタスク一覧。要件定義書と設計書に基づき、実装可能な粒度でタスクを分解。

## 実装フェーズ

### Phase 1: 依存関係とインフラ準備

#### タスク 1.1: GoAdmin関連パッケージの追加
**目的**: GoAdmin本体と関連パッケージをgo.modに追加

**作業内容**:
- `server/go.mod`に以下を追加:
  - `github.com/GoAdminGroup/go-admin` (最新安定版)
  - `github.com/GoAdminGroup/go-admin/engine` (エンジン設定)
  - `github.com/GoAdminGroup/go-admin/plugins/admin` (管理画面プラグイン)
  - `github.com/GoAdminGroup/go-admin/modules` (各種モジュール)
  - `golang.org/x/crypto/bcrypt` (パスワードハッシュ化用)
- `go mod tidy`を実行して依存関係を解決
- `go mod download`でパッケージをダウンロード

**受け入れ基準**:
- `go mod tidy`がエラーなく実行できる
- すべての依存関係が正しく解決されている
- `go.sum`が更新されている

---

#### タスク 1.2: 設定構造の拡張
**目的**: Config構造体に管理画面用設定を追加

**作業内容**:
- `server/internal/config/config.go`の`Config`構造体に以下を追加:
  - `Admin AdminConfig`: 管理画面設定
- `AdminConfig`構造体を新規作成:
  - `Port int`: 管理画面のポート番号（8081）
  - `ReadTimeout time.Duration`: 読み取りタイムアウト
  - `WriteTimeout time.Duration`: 書き込みタイムアウト
  - `Auth AuthConfig`: 認証設定
  - `Session SessionConfig`: セッション設定
- `AuthConfig`構造体を新規作成:
  - `Username string`: ユーザー名
  - `Password string`: パスワード（環境変数から読み込み）
- `SessionConfig`構造体を新規作成:
  - `Lifetime int`: セッション有効期限（秒）

**受け入れ基準**:
- コンパイルエラーがない
- 既存の設定ファイルが動作する（後方互換性）
- 新しい設定項目が正しく読み込まれる

---

#### タスク 1.3: 設定ファイルの更新
**目的**: 各環境の設定ファイルに管理画面用設定を追加

**作業内容**:
- `config/develop.yaml`に管理画面設定を追加:
  - `admin`セクションを追加
  - ポート番号: 8081
  - 認証情報（開発環境用）
  - セッション設定
- `config/staging.yaml`に管理画面設定を追加
- `config/production.yaml.example`に管理画面設定を追加

**受け入れ基準**:
- 設定ファイルが正しく読み込まれる
- 環境変数による設定上書きが動作する
- 各環境の設定が適切に設定されている

---

### Phase 2: GoAdmin統合基盤

#### タスク 2.1: エントリーポイントの作成
**目的**: 管理画面サービスのエントリーポイントを作成

**作業内容**:
- `server/cmd/admin/main.go`を新規作成:
  - 設定ファイルの読み込み
  - GORM Managerの初期化（既存のものを再利用）
  - GoAdmin Engineの初期化
  - HTTPサーバーの起動（ポート8081）
  - Graceful shutdownの実装
- 既存の`server/cmd/server/main.go`を参考に実装

**受け入れ基準**:
- コンパイルエラーがない
- 管理画面サービスがポート8081で起動する
- Graceful shutdownが正しく動作する

---

#### タスク 2.2: GoAdmin設定構造体の実装
**目的**: GoAdmin設定を管理する構造体を実装

**作業内容**:
- `server/internal/admin/config.go`を新規作成:
  - `Config`構造体を定義
  - `NewConfig()`関数を実装
  - `GetGoAdminConfig()`メソッドを実装（GoAdmin設定を返す）
  - `getDatabaseConfig()`メソッドを実装（GORM Managerをアダプターとして設定）

**受け入れ基準**:
- コンパイルエラーがない
- GoAdmin設定が正しく生成される
- GORM Managerがアダプターとして正しく設定される

---

#### タスク 2.3: GoAdmin Engineの基本初期化
**目的**: GoAdmin Engineを初期化して基本的な動作を確認

**作業内容**:
- `server/cmd/admin/main.go`に以下を追加:
  - GoAdmin Engineの初期化
  - 基本的な設定の適用
  - HTTPサーバーへの統合
- 最小限の設定で動作確認

**受け入れ基準**:
- GoAdmin Engineが正常に初期化される
- 管理画面のログインページが表示される（認証実装前でも基本画面は表示される）

---

### Phase 3: テーブル設定

#### タスク 3.1: シャーディング対応ヘルパー関数の実装
**目的**: クロスシャードクエリを実行するヘルパー関数を実装

**作業内容**:
- `server/internal/admin/sharding.go`を新規作成:
  - `queryAllShards()`関数を実装（全シャードからデータを取得してマージ）
  - `findUserAcrossShards()`関数を実装（全シャードからユーザーを検索）
  - `findPostAcrossShards()`関数を実装（全シャードから投稿を検索）
  - goroutineを使用した並列クエリ実行
  - エラーハンドリング

**受け入れ基準**:
- 全シャードのデータを正しく取得できる
- 並列クエリが正しく動作する
- エラーハンドリングが適切

---

#### タスク 3.2: Usersテーブル設定の実装
**目的**: GoAdminでUsersテーブルのCRUD操作を自動生成

**作業内容**:
- `server/internal/admin/tables.go`を新規作成:
  - `GetUserTable()`関数を実装
  - フィールド定義（ID, Name, Email, CreatedAt, UpdatedAt）
  - テーブル名、タイトル、説明の設定
  - シャーディング対応のクエリ関数を設定:
    - `SetQueryFunc()`: 全シャードからデータを取得
    - `SetInsertFunc()`: 新規作成（シャードキーに基づくルーティング）
    - `SetUpdateFunc()`: 更新（シャードを特定して更新）
    - `SetDeleteFunc()`: 削除（シャードを特定して削除）

**受け入れ基準**:
- Usersテーブルの一覧表示が正常に動作する
- 新規作成が正常に動作する
- 更新が正常に動作する
- 削除が正常に動作する
- 全シャードのデータが統合表示される

---

#### タスク 3.3: Postsテーブル設定の実装
**目的**: GoAdminでPostsテーブルのCRUD操作を自動生成

**作業内容**:
- `server/internal/admin/tables.go`に以下を追加:
  - `GetPostTable()`関数を実装
  - フィールド定義（ID, UserID, Title, Content, CreatedAt, UpdatedAt）
  - テーブル名、タイトル、説明の設定
  - UserIDによるフィルタリング機能
  - シャーディング対応のクエリ関数を設定（Usersテーブルと同様）

**受け入れ基準**:
- Postsテーブルの一覧表示が正常に動作する
- 新規作成が正常に動作する
- 更新が正常に動作する
- 削除が正常に動作する
- UserIDによるフィルタリングが正常に動作する
- 全シャードのデータが統合表示される

---

#### タスク 3.4: テーブル設定の統合
**目的**: テーブル設定をGoAdmin Engineに登録

**作業内容**:
- `server/cmd/admin/main.go`に以下を追加:
  - Admin Pluginの初期化
  - UsersテーブルとPostsテーブルの登録
  - GoAdmin Engineへの統合

**受け入れ基準**:
- 管理画面でUsersテーブルとPostsテーブルが表示される
- CRUD操作が正常に動作する

---

### Phase 4: カスタムページ実装

#### タスク 4.1: カスタムページ基盤の実装
**目的**: カスタムページを登録する基盤を実装

**作業内容**:
- `server/internal/admin/pages/pages.go`を新規作成:
  - `RegisterCustomPages()`関数を実装
  - GoAdmin Engineにカスタムページを登録する処理

**受け入れ基準**:
- カスタムページがGoAdmin Engineに登録される
- カスタムページへのルーティングが動作する

---

#### タスク 4.2: 最初のページ（ランディングページ）の実装
**目的**: 管理画面のトップページを実装

**作業内容**:
- `server/internal/admin/pages/home.go`を新規作成:
  - `HomePage()`関数を実装
  - プロジェクト概要の表示
  - 統計情報の取得と表示（ユーザー数、投稿数、各シャードのデータ件数）
  - 主要機能へのナビゲーションリンク
  - HTMLテンプレートの実装

**受け入れ基準**:
- 最初のページが正常に表示される
- 統計情報が正しく表示される
- ナビゲーションリンクが正常に動作する

---

#### タスク 4.3: ユーザー情報登録画面の実装
**目的**: 新規ユーザー情報を登録するフォームを実装

**作業内容**:
- `server/internal/admin/pages/user_register.go`を新規作成:
  - `UserRegisterPage()`関数を実装
  - GETリクエスト: フォーム表示
  - POSTリクエスト: フォーム送信処理
  - バリデーション機能（必須項目チェック、メール形式チェック）
  - エラーメッセージ表示
  - 既存のService層を使用したユーザー登録
  - 登録完了画面へのリダイレクト

**受け入れ基準**:
- ユーザー情報登録画面が正常に表示される
- フォーム送信が正常に動作する
- バリデーションが正常に動作する
- エラーメッセージが適切に表示される
- ユーザーが正しく登録される

---

#### タスク 4.4: ユーザー情報登録完了画面の実装
**目的**: ユーザー情報登録完了を通知する画面を実装

**作業内容**:
- `server/internal/admin/pages/user_register_complete.go`を新規作成:
  - `UserRegisterCompletePage()`関数を実装
  - 登録成功メッセージの表示
  - 登録されたユーザー情報の表示（ID、名前、メールアドレス、登録日時）
  - 「一覧に戻る」リンク
  - 「新規登録を続ける」リンク
  - HTMLテンプレートの実装

**受け入れ基準**:
- ユーザー情報登録完了画面が正常に表示される
- 登録されたユーザー情報が正しく表示される
- リンクが正常に動作する

---

#### タスク 4.5: カスタムページの統合
**目的**: カスタムページをGoAdmin Engineに登録

**作業内容**:
- `server/cmd/admin/main.go`に以下を追加:
  - `RegisterCustomPages()`の呼び出し
  - カスタムページのルーティング設定

**受け入れ基準**:
- すべてのカスタムページが正常に表示される
- カスタムページ間のナビゲーションが正常に動作する

---

### Phase 5: 認証・認可実装

#### タスク 5.1: 認証設定の実装
**目的**: ログイン機能を実装

**作業内容**:
- `server/internal/admin/auth/auth.go`を新規作成:
  - `LoginHandler()`関数を実装
  - 認証情報の検証（設定ファイルから読み込み）
  - パスワードのハッシュ化（bcrypt）と検証
  - セッション作成
  - ログイン成功時のリダイレクト
  - ログイン失敗時のエラーメッセージ表示

**受け入れ基準**:
- ログインページが正常に表示される
- 正しい認証情報でログインできる
- 間違った認証情報でログインできない
- ログイン成功時に管理画面にリダイレクトされる

---

#### タスク 5.2: セッション管理の実装
**目的**: セッション管理機能を実装

**作業内容**:
- `server/internal/admin/auth/session.go`を新規作成:
  - セッション管理の実装
  - セッションタイムアウトの処理
  - ログアウト機能の実装
- GoAdminのセッション機能を使用

**受け入れ基準**:
- セッションが正しく管理される
- セッションタイムアウトが正常に動作する
- ログアウトが正常に動作する

---

#### タスク 5.3: アクセス制御の実装
**目的**: 認証済みユーザーのみ管理画面にアクセス可能にする

**作業内容**:
- `server/internal/admin/auth/auth.go`に以下を追加:
  - `RegisterAuth()`関数を実装
  - GoAdmin Engineに認証関数を登録
  - 未認証ユーザーをログインページにリダイレクト
  - 認証チェックの実装

**受け入れ基準**:
- 未認証ユーザーは管理画面にアクセスできない
- 未認証ユーザーはログインページにリダイレクトされる
- 認証済みユーザーは管理画面にアクセスできる

---

#### タスク 5.4: 認証・認可の統合
**目的**: 認証・認可機能をGoAdmin Engineに統合

**作業内容**:
- `server/cmd/admin/main.go`に以下を追加:
  - `RegisterAuth()`の呼び出し
  - 認証・認可の設定

**受け入れ基準**:
- 認証・認可が正常に動作する
- すべての管理画面ページが認証保護される

---

### Phase 6: シャーディング対応の強化

#### タスク 6.1: シャードキーに基づくルーティングの実装
**目的**: 新規作成時に適切なシャードにルーティングする機能を実装

**作業内容**:
- `server/internal/admin/sharding.go`に以下を追加:
  - 新規作成時のシャード選択ロジック
  - シャードキー（user_id）に基づくルーティング
  - デフォルトシャードへの保存（簡易実装）

**受け入れ基準**:
- 新規作成時に適切なシャードに保存される
- シャードキーに基づくルーティングが正常に動作する

---

#### タスク 6.2: シャード情報の表示
**目的**: 管理画面でシャード情報を表示する機能を実装

**作業内容**:
- テーブル設定にシャードIDカラムを追加（オプション）
- 一覧表示でシャード情報を表示
- 統計情報で各シャードのデータ件数を表示

**受け入れ基準**:
- シャード情報が正しく表示される
- 各シャードのデータ件数が正しく表示される

---

### Phase 7: テスト実装

#### タスク 7.1: 管理画面の基本テスト
**目的**: 管理画面の基本機能のテストを実装

**作業内容**:
- `server/internal/admin/admin_test.go`を新規作成:
  - GoAdmin Engineの初期化テスト
  - テーブル設定のテスト
  - カスタムページのテスト

**受け入れ基準**:
- すべてのテストがパスする
- テストカバレッジが70%以上を達成

---

#### タスク 7.2: 認証・認可のテスト
**目的**: 認証・認可機能のテストを実装

**作業内容**:
- `server/internal/admin/auth/auth_test.go`を新規作成:
  - ログイン機能のテスト
  - セッション管理のテスト
  - アクセス制御のテスト

**受け入れ基準**:
- すべてのテストがパスする
- 認証・認可が正しく動作することを確認

---

#### タスク 7.3: シャーディング対応のテスト
**目的**: シャーディング対応機能のテストを実装

**作業内容**:
- `server/internal/admin/sharding_test.go`を新規作成:
  - クロスシャードクエリのテスト
  - シャードキーに基づくルーティングのテスト
  - 全シャードデータの統合表示のテスト

**受け入れ基準**:
- すべてのテストがパスする
- シャーディング対応が正しく動作することを確認

---

#### タスク 7.4: 統合テストの実装
**目的**: 管理画面の統合テストを実装

**作業内容**:
- `server/test/admin/`ディレクトリを作成
- 統合テストを実装:
  - 管理画面の起動テスト
  - ログインからCRUD操作までの一連のフローテスト
  - カスタムページの動作テスト

**受け入れ基準**:
- すべての統合テストがパスする
- 管理画面の一連の動作が正常であることを確認

---

### Phase 8: ドキュメント更新

#### タスク 8.1: READMEの更新
**目的**: READMEに管理画面の起動方法を追加

**作業内容**:
- `README.md`に以下を追加:
  - 管理画面の起動方法
  - 管理画面のアクセス方法
  - 認証情報の設定方法

**受け入れ基準**:
- READMEが正しく更新されている
- 管理画面の起動方法が明確に記載されている

---

#### タスク 8.2: アーキテクチャドキュメントの更新
**目的**: アーキテクチャドキュメントに管理画面を追加

**作業内容**:
- `docs/Architecture.md`に以下を追加:
  - 管理画面のアーキテクチャ説明
  - GoAdmin統合の説明
  - シャーディング対応の説明

**受け入れ基準**:
- アーキテクチャドキュメントが正しく更新されている
- 管理画面のアーキテクチャが明確に記載されている

---

#### タスク 8.3: 管理画面の使い方ドキュメント作成
**目的**: 管理画面の使い方ドキュメントを作成

**作業内容**:
- `docs/Admin.md`を新規作成:
  - 管理画面の概要
  - ログイン方法
  - テーブル管理の使い方
  - カスタムページの使い方
  - トラブルシューティング

**受け入れ基準**:
- 管理画面の使い方ドキュメントが作成されている
- 使用方法が明確に記載されている

---

## 実装順序の推奨

1. Phase 1: 依存関係とインフラ準備（必須）
2. Phase 2: GoAdmin統合基盤（必須）
3. Phase 3: テーブル設定（必須）
4. Phase 5: 認証・認可実装（必須）
5. Phase 4: カスタムページ実装（機能要件）
6. Phase 6: シャーディング対応の強化（最適化）
7. Phase 7: テスト実装（品質保証）
8. Phase 8: ドキュメント更新（ドキュメント化）

## 注意事項

- 各タスクは独立して実装可能な粒度に分解
- 前のフェーズが完了してから次のフェーズに進む
- テストは各フェーズで適宜実装
- エラーハンドリングは各タスクで適切に実装
- 既存のコードスタイルに準拠


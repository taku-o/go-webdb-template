# GoAdmin管理画面導入要件定義書

## 1. 概要

### 1.1 プロジェクト情報
- **プロジェクト名**: go-webdb-template
- **Issue番号**: #5
- **Issueタイトル**: 管理画面の作成
- **Feature名**: 0004-goadmin
- **作成日**: 2025-01-27

### 1.2 目的
GoAdminを導入した管理画面を作成し、以下の機能を実現する：
1. 既存データベースのデータを参照・編集する機能
2. カスタムページ（最初のページ、ユーザー情報登録画面、ユーザー情報登録完了画面）の提供
3. 複数DB・シャーディング構成に対応した管理画面の実装
4. 認証・認可機能によるセキュアなアクセス制御

### 1.3 スコープ
- GoAdminフレームワークの導入と設定
- 既存のGORM接続管理との統合
- 既存サービス（ポート8080）とは独立した管理画面サービス（ポート8081）の実装
- 既存データベース（users, postsテーブル）の管理機能
- カスタムページの実装
- 認証・認可機能の実装
- 複数シャードにまたがるデータアクセス機能

## 2. 背景・現状分析

### 2.1 現在の実装
- **メインサービス**: ポート8080で動作するAPIサーバー（`server/cmd/server/main.go`）
- **データベース接続**: GORMを使用した接続管理（`server/internal/db/manager.go`）
- **シャーディング**: Hash-based sharding戦略で複数シャードに分散
- **データモデル**: Userモデル、Postモデルが定義済み
- **管理画面**: 未実装

### 2.2 課題点
1. **データ確認の困難さ**: コード確認用サンプルプロジェクトとして、データベースの内容を確認・編集する機能が不足
2. **手動操作の必要性**: データベースに直接接続してSQLを実行する必要があり、非効率
3. **複数シャード対応の複雑さ**: シャーディング構成により、全データを確認するには複数のシャードにアクセスする必要がある
4. **ユーザーフレンドリーなUIの不足**: コマンドラインやSQLクエリによる操作は技術者以外には困難

### 2.3 GoAdmin導入による改善点
1. **視覚的なデータ管理**: Webブラウザから直感的にデータを確認・編集可能
2. **自動CRUD機能**: モデル定義に基づいて自動的にCRUD操作を提供
3. **カスタムページ対応**: プロジェクト固有のページを実装可能
4. **認証・認可機能**: セキュアなアクセス制御を実装可能
5. **GORM統合**: 既存のGORM接続を活用して実装可能

## 3. 機能要件

### 3.1 GoAdmin本体の導入

#### 3.1.1 バージョン指定
- **GoAdmin本体**: `github.com/GoAdminGroup/go-admin` (最新安定版)
- **GoAdmin Engine**: `github.com/GoAdminGroup/go-admin/engine` (エンジン設定)
- **GoAdmin Plugins**: `github.com/GoAdminGroup/go-admin/plugins/admin` (管理画面プラグイン)
- **GoAdmin Modules**: `github.com/GoAdminGroup/go-admin/modules` (各種モジュール)
- **GORM Adapter**: GoAdminのGORMアダプター（既存のGORM接続と統合）

#### 3.1.2 既存実装との統合
- 既存の`server/internal/db/manager.go`のGORM Managerを再利用
- 既存の`server/internal/model/user.go`と`server/internal/model/post.go`をGoAdminで使用
- 既存の設定ファイル（`config/develop.yaml`等）を拡張して管理画面用設定を追加

#### 3.1.3 サーバー構成
- 新規エントリーポイント: `server/cmd/admin/main.go`を作成
- 独立したHTTPサーバーとしてポート8081で動作
- 既存のメインサービス（ポート8080）とは完全に独立
- 設定ファイルに管理画面用の設定セクションを追加

### 3.2 管理画面の基本機能

#### 3.2.1 データベーステーブル管理
- **Usersテーブル管理**
  - 一覧表示（全シャードのデータを統合表示）
  - 詳細表示
  - 新規作成
  - 編集
  - 削除
  - 検索・フィルタリング機能

- **Postsテーブル管理**
  - 一覧表示（全シャードのデータを統合表示）
  - 詳細表示
  - 新規作成
  - 編集
  - 削除
  - 検索・フィルタリング機能
  - UserIDによるフィルタリング

#### 3.2.2 シャーディング対応
- 全シャードにまたがるデータの一覧表示
- シャードキー（user_id）に基づく適切なシャードへの自動ルーティング
- クロスシャードクエリによる全データの取得とマージ
- 各シャードのデータを識別可能な表示（シャードIDの表示など）

#### 3.2.3 データ操作機能
- **作成**: 新規レコードの作成（適切なシャードへの自動配置）
- **読み取り**: レコードの詳細表示
- **更新**: 既存レコードの編集
- **削除**: レコードの削除（確認ダイアログ付き）
- **一括操作**: 複数レコードの一括削除（オプション）

### 3.3 カスタムページの実装

#### 3.3.1 最初のページ（ランディングページ）
- **目的**: 管理画面のトップページとして、概要とナビゲーションを提供
- **機能**:
  - プロジェクト概要の表示
  - データベース統計情報の表示（ユーザー数、投稿数など）
  - 各シャードのデータ件数表示
  - 主要機能へのナビゲーションリンク
  - クイックアクセスメニュー

#### 3.3.2 ユーザー情報登録画面
- **目的**: 新規ユーザー情報を入力・登録するためのフォーム
- **機能**:
  - ユーザー名入力フィールド
  - メールアドレス入力フィールド
  - バリデーション機能（必須項目チェック、メール形式チェック）
  - 送信ボタン
  - エラーメッセージ表示
  - 既存のUserモデルを使用したデータ登録

#### 3.3.3 ユーザー情報登録完了画面
- **目的**: ユーザー情報の登録が成功したことを通知する確認ページ
- **機能**:
  - 登録成功メッセージの表示
  - 登録されたユーザー情報の表示（ID、名前、メールアドレス）
  - 登録日時の表示
  - 「一覧に戻る」リンク
  - 「新規登録を続ける」リンク

### 3.4 認証・認可機能

#### 3.4.1 ログイン機能
- **ログインページ**: ユーザー名とパスワードによる認証
- **セッション管理**: ログイン状態の維持
- **ログアウト機能**: セッションの破棄

#### 3.4.2 アクセス制御
- **認証チェック**: 未認証ユーザーはログインページにリダイレクト
- **認可チェック**: 認証済みユーザーのみ管理画面にアクセス可能
- **セッションタイムアウト**: 一定時間無操作で自動ログアウト

#### 3.4.3 セキュリティ対策
- パスワードのハッシュ化（bcrypt等）
- CSRF対策
- XSS対策
- SQLインジェクション対策（GORMのパラメータ化クエリを活用）

### 3.5 設定管理

#### 3.5.1 設定ファイルの拡張
- `config/develop.yaml`: 管理画面用設定を追加
  - 管理画面のポート番号（8081）
  - 認証情報（開発環境用）
  - セッション設定
- `config/staging.yaml`: ステージング環境用設定を追加
- `config/production.yaml.example`: 本番環境用設定テンプレートを追加

#### 3.5.2 環境変数対応
- 環境変数による設定上書き機能を維持
- 機密情報（パスワード等）は環境変数から読み込み

## 4. 非機能要件

### 4.1 既存サービスへの影響
- 既存のメインサービス（ポート8080）への影響なし
- 既存のAPIエンドポイントの動作を維持
- 既存のデータベース接続との競合なし

### 4.2 パフォーマンス
- 管理画面のレスポンス時間: 1秒以内（通常操作）
- 大量データの一覧表示時はページネーションを実装
- クロスシャードクエリは並列実行でパフォーマンスを維持

### 4.3 セキュリティ
- 認証・認可機能の実装（必須）
- HTTPS対応（本番環境）
- セッション管理の適切な実装
- 入力値のバリデーションとサニタイゼーション

### 4.4 テストカバレッジ
- 管理画面の基本機能のテスト実装
- 認証・認可機能のテスト実装
- カスタムページのテスト実装
- シャーディング対応機能のテスト実装
- テストカバレッジ: 70%以上を目標

### 4.5 エラーハンドリング
- 適切なエラーメッセージの表示
- ログ出力によるエラー追跡
- ユーザーフレンドリーなエラー画面

### 4.6 ドキュメント
- 管理画面の使い方ドキュメント
- 設定ファイルの説明
- カスタムページの実装方法の説明

## 5. 制約事項

### 5.1 アーキテクチャ
- 既存のレイヤードアーキテクチャを維持
- 既存のGORM接続管理を再利用
- 既存のモデル定義をそのまま使用

### 5.2 シャーディング戦略
- 既存のHash-based sharding戦略を維持
- シャードキー（`user_id`）の変更は行わない
- クロスシャードクエリはアプリケーションレベルで実装

### 5.3 設定ファイル
- 既存のYAML設定ファイル形式を維持
- 環境変数による設定上書き機能を維持

### 5.4 データベース
- 開発環境: SQLite3
- 本番環境: PostgreSQL / MySQL
- 既存のマイグレーションファイル構造を維持

### 5.5 ポート番号
- メインサービス: ポート8080（既存）
- 管理画面サービス: ポート8081（新規）

## 6. 受け入れ基準

### 6.1 機能要件
- [ ] GoAdminが正常に動作する
- [ ] 管理画面がポート8081で起動する
- [ ] Usersテーブルの参照・編集が可能
- [ ] Postsテーブルの参照・編集が可能
- [ ] 全シャードのデータを一覧表示できる
- [ ] カスタムページ（最初のページ）が正常に表示される
- [ ] カスタムページ（ユーザー情報登録画面）が正常に動作する
- [ ] カスタムページ（ユーザー情報登録完了画面）が正常に表示される
- [ ] 認証・認可が正常に機能する
- [ ] ログイン・ログアウトが正常に動作する

### 6.2 非機能要件
- [ ] 既存のメインサービス（ポート8080）が正常に動作する
- [ ] 既存のAPIエンドポイントが正常に動作する
- [ ] 管理画面のテストが追加され、パスする
- [ ] テストカバレッジが70%以上を達成

### 6.3 ドキュメント
- [ ] 管理画面の使い方ドキュメントが作成される
- [ ] 設定ファイルの説明が追加される
- [ ] README.mdに管理画面の起動方法が記載される

### 6.4 コード品質
- [ ] 既存のコードスタイルに準拠
- [ ] 適切なエラーハンドリングが実装されている
- [ ] 適切なログ出力が実装されている

## 7. 影響範囲

### 7.1 新規追加が必要なファイル

#### 管理画面エントリーポイント
- `server/cmd/admin/main.go`: 管理画面サービスのエントリーポイント

#### 管理画面設定
- `server/internal/admin/config.go`: GoAdmin設定構造体と初期化処理
- `server/internal/admin/router.go`: GoAdminルーター設定

#### カスタムページ
- `server/internal/admin/pages/home.go`: 最初のページ（ランディングページ）
- `server/internal/admin/pages/user_register.go`: ユーザー情報登録画面
- `server/internal/admin/pages/user_register_complete.go`: ユーザー情報登録完了画面

#### 認証・認可
- `server/internal/admin/auth/login.go`: ログイン処理
- `server/internal/admin/auth/session.go`: セッション管理

#### テスト
- `server/internal/admin/admin_test.go`: 管理画面の基本テスト
- `server/test/admin/`: 管理画面の統合テスト

#### 設定ファイル
- `config/develop.yaml`: 管理画面用設定の追加
- `config/staging.yaml`: 管理画面用設定の追加
- `config/production.yaml.example`: 管理画面用設定の追加

#### 依存関係
- `server/go.mod`: GoAdmin関連パッケージの追加
- `server/go.sum`: 依存関係の更新

### 7.2 変更が必要なファイル
- なし（既存ファイルへの影響は最小限）

### 7.3 削除されるファイル
- なし

### 7.4 ドキュメント更新
- `README.md`: 管理画面の起動方法を追加
- `docs/Architecture.md`: 管理画面のアーキテクチャを追加
- `.kiro/steering/tech.md`: 技術スタックにGoAdminを追加（必要に応じて）

## 8. 実装上の注意事項

### 8.1 GoAdminの統合
- 既存のGORM ManagerをGoAdminのアダプターとして使用
- GoAdminのテーブル生成機能を活用してCRUD操作を自動化
- カスタムページはGoAdminのページ機能を使用

### 8.2 シャーディング対応
- 全シャードのデータを取得する際は、既存の`GetAllConnections()`メソッドを活用
- クロスシャードクエリはgoroutineを使用して並列実行
- 結果のマージはアプリケーションレベルで実装

### 8.3 認証・認可の実装
- GoAdminの認証機能を活用
- セッション管理はGoAdminのセッション機能を使用
- 開発環境では簡易的な認証でも可（本番環境では適切な認証を実装）

### 8.4 カスタムページの実装
- GoAdminのカスタムページ機能を使用
- HTMLテンプレートはGoAdminのテンプレート機能を活用
- フォーム送信は既存のService層を経由してデータベースに保存

### 8.5 エラーハンドリング
- GoAdminのエラーハンドリング機能を活用
- 既存のエラーハンドリングパターンと整合性を保つ
- ユーザーフレンドリーなエラーメッセージを表示

### 8.6 テスト
- GoAdminのテスト機能を活用
- 統合テストでは実際のデータベース接続を使用
- 認証・認可のテストを実装

## 9. 参考情報

### 9.1 GoAdmin公式ドキュメント
- GoAdmin公式サイト: https://github.com/GoAdminGroup/go-admin
- GoAdminドキュメント: https://book.go-admin.cn/
- GoAdmin GORM統合: https://book.go-admin.cn/guide/admin/plugins/gorm

### 9.2 関連Issue
- GitHub Issue #5: 管理画面の作成

### 9.3 既存ドキュメント
- `docs/Architecture.md`: システムアーキテクチャ
- `docs/Sharding.md`: シャーディング戦略の詳細
- `.kiro/steering/tech.md`: 技術スタックとアーキテクチャ
- `.kiro/specs/0003-gorm-introduction/requirements.md`: GORM導入要件定義書

### 9.4 既存実装
- `server/internal/db/manager.go`: GORM接続管理
- `server/internal/model/user.go`: Userモデル定義
- `server/internal/model/post.go`: Postモデル定義
- `server/cmd/server/main.go`: メインサービスエントリーポイント

